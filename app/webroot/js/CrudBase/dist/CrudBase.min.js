/**
 * CakePHPによるAjax認証
 * 
 * @note
 * AjaxLoginWithCakeController.phpと連動
 * 
 * @date 2016-9-12 | 2019-1-18
 * @version 2.0.1 ES6対応 aクエリを廃止
 */

class AjaxLoginWithCake{
	
	/**
	 * コンストラクタ
	 * 
	 * @param param 省略可
	 * - btn_type ボタンタイプ  0:プレーンスタイル , 1:Bootstrapスタイル
	 * - login_check_url ログイン確認URL
	 * - login_url ログインURL
	 * - logout_url ログアウトURL
	 * - callback ログイン認証後によびだすコールバック関数
	 * - form_slt ボタン表示区分へのセレクタ  デフォルト→"#ajax_login_with_cake
	 */
	constructor(param){
		
		this.param = this._setParamIfEmpty(param);
	}
	
	/**
	 * If Param property is empty, set a value.
	 */
	_setParamIfEmpty(param){
		
		if(param == null) param = {};

		// ボタンタイプ  0:プレーンスタイル , 1:Bootstrapスタイル
		if(param['btn_type'] == null) param['btn_type'] = 1;
		
		if(param['login_check_url'] == null) param['login_check_url'] = "ajax_login_with_cake/login_check";
		
		if(param['login_url'] == null) param['login_url'] = "ajax_login_with_cake/login_rap";
		
		if(param['logout_url'] == null) param['logout_url'] = "users/logout";

		if(this._isEmpty(param['callback'])) param['callback'] = null;
		
		if(this._isEmpty(param['form_slt'])) param['form_slt'] = "#ajax_login_with_cake";
		
		return param;
	}
	
	/**
	 * パラメータのマージ
	 */
	_margeParam(param){
		this.param = Object.assign({}, this.param, param);
		return this.param
	}
	
	
	/**
	 * 認証フォーム付
	 * @param param constructorのparamと同じ
	 */
	loginCheckEx(param){

		var rGet = this._getUrlQuery();// GETパラメータを取得
		
//		// aパラメータがONの場合に認証機能を有効にする。
//		if(this._isSet(rGet['a'])){
//			this.loginCheck(param);
//		}
		
		this.loginCheck(param);

	}
	
	/**
	 * 認証チェック
	 */
	loginCheck(param){
		
		param = this._margeParam(param);

		var data={'dummy':1};
		var json_str = JSON.stringify(data);//データをJSON文字列にする。

		// AJAX
		$.ajax({
			type: "POST",
			url: param.login_check_url,
			data: "key1="+json_str,
			cache: false,
			dataType: "text",
		})
		.done((str_json, type) => {

			try{
				var res = jQuery.parseJSON(str_json);//パース
			}catch(e){
				alert('エラー' + str_json);
				throw new Error(str_json);
			}
			
			//formShowCb(res);//フォームにログインボタンやメッセージを表示する
			this._showBtns(res);

			// クライアントから指定されたコールバック関数を実行する
			if(param.callback != null){
				callBack(res.auth_flg);
			}
		})
		.fail((jqXHR, statusText, errorThrown) => {
			jQuery('#err').html(jqXHR.responseText);
			alert(statusText);
		});
		
	}
	
	
	/**
	 * ボタン表示区分にログインボタンやメッセージを表示する
	 */
	_showBtns(res){

		var form_slt = this.param.form_slt;
		var formElm = jQuery(form_slt);

		if(res.auth_flg == 1 ){
			var logout_btn_html = this._getLogoutBtnHtml(); // ログアウトボタンのＨＴＭＬを取得
			formElm.html(logout_btn_html);
		}
		
		else{
			var login_btn_html = this._getLoginBtnHtml(); // ログインボタンのＨＴＭＬを取得
			formElm.html(login_btn_html);
		}
		
	}
	
	/**
	 * ログアウトボタンのＨＴＭＬを取得
	 * @reutrn string ログアウトボタンのＨＴＭＬ
	 */
	_getLogoutBtnHtml(){
		
		var logout_url = this.param.logout_url;

		var btn_html = "";
		if(this.param.btn_type == 1){
			btn_html = "<span class='text-success'>認証中です </span><a href='" + logout_url + "' id='logout_btn' class='btn btn-default btn-xs'>ログアウト</a>";
		}else{
			btn_html = "<a href='" + logout_url + "' id='logout_btn'>ログアウト</a>";
		}
		return btn_html

	}
	
	/**
	 * ログインボタンのＨＴＭＬを取得
	 * @reutrn string ログインボタンのＨＴＭＬ
	 */
	_getLoginBtnHtml(){

		var login_url = this.param.login_url;

		var btn_html = "";
		if(this.param.btn_type == 1){
			btn_html = "<a id='login_btn' href='" + login_url + "' class='btn btn-primary' >ログイン</a>";
		}else{
			btn_html = "<a id='login_btn' href='" + login_url + "' >ログイン</a>";
		}
		return btn_html

	}
	
	/**
	 * URLクエリデータを取得する
	 * 
	 * @return object URLクエリデータ
	 */
	_getUrlQuery(){
		query = window.location.search;
		
		if(query =='' || query==null){
			return {};
		}
		var query = query.substring(1,query.length);
		var ary = query.split('&');
		var data = {};
		for(var i=0 ; i<ary.length ; i++){
			var s = ary[i];
			var prop = s.split('=');
			
			data[prop[0]]=prop[1];
	
		}	
		return data;
	}
	
	/**
	 * 空チェック
	 */
	_isEmpty(v){
		if(v =='' || v==null || v == false){
			return true;
		}else{
			return false;
		}
	}
	
	/**
	 * 値セットチェック
	 */
	_isSet(v){
		if(v =='' || v==null || v == false){
			return false;
		}else{
			return true;
		}
	}
	
	
}
/**
 * カレンダービュー
 * 
 * @note
 * 一覧をカレンダーの構造で表示する
 * 
 * @date 2018-12-1
 * @version 1.0.0
 * 
 */
class CalendarViewK{

	
	/**
	 * カレンダービューを生成する
	 * @param object data 一覧テーブルからのデータ
	 * @param string date_field 日付フィールド
	 * @param function callback カレンダーセル作成のコールバック
	 */
	create(data, date_field, callback){

		// データ中の日付データを整形する
		data = this._shapingDateInData(data, date_field);
		
		// 基準月初日を取得する
		var base_month_start = this._getBaseMonthStart(data, date_field);
		if(base_month_start == null){
			console.log('カレンダービュー：データ中に日付がありません。');
			return;
		}

		// 基準月末日を取得する
		var base_month_end = this._getMonthEndDate(base_month_start);

		// カレンダーデータのフォーマットを作成する。
		var calData = this._createCalendarDataFormat(base_month_start, base_month_end);
		
		// データを日付で集計する
		var dataA = this._aggByDateField(data, date_field);
		
		// カレンダーデータに日付集計データをマッピングする
		calData = this._mappingToCalData(calData, dataA);
		
		// カレンダーデータの週ごとに構造変換する
		calData = this._weekStructConv(calData);
		
		// コールバック関数が空であるなら見本コールバック関数をセットする。
		if(callback == null) callback = this._callback;

		// カレンダービューHTMLを組み立てる
		var html = this._buildCalendarViewHtml(calData, callback, base_month_start);
		
		jQuery('#calendar_view_k').html(html);
	}
	
	
	/**
	 * 見本コールバック
	 */
	_callback(cellData, self){
		
		var html = "";
		if(cellData['ents'] != null){
			var ents = cellData['ents'];
			for(var i in ents){
				var ent = ents[i];
				var name_field = self._getNameField(ent);
				var name = self._xss_sanitize(ent[name_field]);
				html += "<div>" + name + "</div>";
			}

		}
		
		html = "<div style='width:120px;height:80px'>" + html + "</div>";
		
		return html;
	}
	
	_getNameField(ent){
		if(this.name_field == null){
			this.name_field = 'id';
			for(var field in ent){
				if(field.indexOf('name') >= 0){
					this.name_field = field;
				}
				
			}
		}
		
		return this.name_field;
	}
	
	/**
	 * XSSサニタイズ
	 * 
	 * @note
	 * 「<」と「>」のみサニタイズする
	 * 
	 * @param any data サニタイズ対象データ | 値および配列を指定
	 * @returns サニタイズ後のデータ
	 */
	_xss_sanitize(data){
		if(typeof data == 'object'){
			for(var i in data){
				data[i] = _xss_sanitize(data[i]);
			}
			return data;
		}
		
		else if(typeof data == 'string'){
			return data.replace(/</g, '&lt;').replace(/>/g, '&gt;');
		}
		
		else{
			return data;
		}
	}
	
	
	
	/**
	 * カレンダービューHTMLを組み立てる
	 * @param object カレンダーデータ
	 * @param function callback カレンダーセル作成のコールバック
	 * @param string 基準月初日
	 * @return string カレンダービューHTML
	 */
	_buildCalendarViewHtml(calData, callback, base_month_start){
		
		// 年月を取得
		var dt1 = new Date(base_month_start);
		var ym = dt1.getFullYear() + '-' + (dt1.getMonth() + 1);

		var html = "<table class='calendar_view_k'><caption>" + ym + "</caption><thead><tr>";
		
		// ▼ 列部分の日 ～ 土を作成
		var weeks = [
			{'code':'sun', 'wamei':'日'}, 
			{'code':'mon', 'wamei':'月'}, 
			{'code':'tue', 'wamei':'火'}, 
			{'code':'wed', 'wamei':'水'}, 
			{'code':'thu', 'wamei':'木'}, 
			{'code':'fri', 'wamei':'金'}, 
			{'code':'sat', 'wamei':'土'}
			];
		for(var w_i in weeks){
			var week_wamei = weeks[w_i]['wamei'];
			var week_code = weeks[w_i]['code'];
			var th_class = 'cvk_' + week_code;
			html += "<th class='" + th_class + "'>" + week_wamei + "</th>";
		}
		html += "</tr></thead><tbody>";
		
		// ▼セル部分を作成
		for(var w_i in calData){
			var wData = calData[w_i];
			html += "<tr>";
			for(var key_date in wData){
				var ent = wData[key_date];
				
				// 日, 曜日番号, 曜日コードを取得する
				var cellDate = new Date(key_date);
				var day = cellDate.getDate();
				var week_no = cellDate.getDay();
				var week_code = weeks[week_no]['code'];
				
				// クラス属性・曜日
				var day_class = 'cvk_' + week_code;
				
				// クラス属性・当月外
				if(ent['cur_month_flg'] == 0) day_class = 'cvk_out_this_month';
				
				// セル内容をコールバック関数にて作成
				var cell_contents = callback(ent, this);

				html += 
					"<td><div class='cvk_cell'>" +
					"<div class='cvk_cell_div1 " + day_class + "'>" + day + "</div>" +
					"<div class='cvk_cell_div2'> " + week_code + " </div>" +
					"<div class='cvk_cell_div3'>" + cell_contents +  "</div>" +
					"</div></td>";
			}
			html += "</tr>";
		}
		
		html += "</tbody></table>";
		return html;
	}
	
	
	/**
	 * カレンダーデータの週ごとに構造変換する
	 * @param object calData カレンダーデータ
	 * @return object 構造変換後のカレンダーデータ
	 */
	_weekStructConv(calData){
		
		var calData2 = [];
		var mw_i = 0;
		var w_i = 0;
		for(var date_key in calData){

			var calEnt = calData[date_key];
	
			if(calData2[mw_i] == null){
				// 第4週以降の日曜日が来月日付になっているならただちに終了する。
				if(mw_i >= 4 && calEnt['cur_month_flg'] == 0){
					return calData2;
				}
				
				calData2[mw_i] = {};
			}
			calData2[mw_i][date_key] = calEnt;
			
			w_i ++;
			if(w_i == 7){
				mw_i ++;
				w_i = 0;
			}
		}
		return calData2;
	}
	

	/**
	 * カレンダーデータに日付集計データをマッピングする
	 * @param object calData カレンダーデータ
	 * @param object dataA 日付集計データ
	 * @return object 日付集計データをマッピングしたカレンダーデータ
	 */
	_mappingToCalData(calData, dataA){
		
		for(var key_date in calData){
			if(dataA[key_date] != null){
				calData[key_date]['ents'] = dataA[key_date];
			}
		}
		
		return calData;
	}
	
	
	
	/**
	 * カレンダーデータのフォーマットを作成する。
	 * @param string base_month_start 基準月初日
	 * @param string base_month_end 基準月末日
	 * @return object カレンダーデータのフォーマット
	 */
	_createCalendarDataFormat(base_month_start, base_month_end){

		var bmsDate = new Date(base_month_start); // 日付オブジェクトに変換する
		
		var cur_year = bmsDate.getFullYear(); // 当年
		var cur_month_no = bmsDate.getMonth(); // 当月番号(0～11)
		
		// 曜日番号を取得する
		var week_no = bmsDate.getDay(); // 0～6(日～土)

		// スタート外部日付を算出
		var sodDate = new Date(base_month_start); // スタート外部日付オブジェクト
		sodDate.setDate(sodDate.getDate() - week_no); // スタート外部日付を算出
		var start_out_date = this._convDateToYMD(sodDate); // スタート外部日付
		
		// カレンダーデータのフォーマットを作成
		var calData = {}; // カレンダーデータ
		var dt = new Date(start_out_date);
		for(var i=0; i<42; i++){
			
			// 当月フラグ：当月なら1, 先月、次月なら0
			var cur_month_flg = 0;
			if(dt.getFullYear() == cur_year && dt.getMonth() ==cur_month_no){
				cur_month_flg = 1;
			}
			
			// フォーマットをセット
			var key_date = this._convDateToYMD(dt);
			calData[key_date] = {
					'index':i,
					'date':key_date,
					'cur_month_flg':cur_month_flg,
			}
			dt.setDate(dt.getDate() + 1);
		}

		return calData;
	}
	
	
	/**
	 * データ中の日付データを整形する
	 * @param object data 一覧テーブルからのデータ
	 * @param string date_field 日付フィールド
	 * @param object 日付を整形したデータ
	 */
	_shapingDateInData(data, date_field){
		for(var i in data){
			var ent = data[i];
			ent[date_field] = this._shapingDate(ent[date_field]); // 日付整形
		}
		return data;
	}
	
	/**
	 * 基準月初日を取得する
	 * @param object data 一覧テーブルからのデータ
	 * @param string date_field 日付フィールド
	 * @return string 基準月初日
	 */
	_getBaseMonthStart(data, date_field){
		
		// データ中に最初に登場する日付を取得し、その日付の月初日を基準月初日として取得する。
		for(var i in data){
			var ent = data[i];
			if(ent[date_field] != null){
				var base_month_start = ent[date_field];
				base_month_start = this._getMonthStartDate(base_month_start); // 対象日付の月初日を取得
				return base_month_start;
			}
		}
		
		return null;
	}
	
	/**
	 * 対象日付の月初日を取得
	 * @param mixed date1 対象日付
	 * @return string 対象日付の月初日
	 */
	_getMonthStartDate(date1){
		if(date1 == null) return null;
		if((typeof date1) == 'string'){
			date1 = new Date(date1);
		}
		
		var year = date1.getFullYear();
		var month = date1.getMonth() + 1;
		var date_str = year + '-' + month + '-1';
		return date_str;
	}
	
	/**
	 * 対象日付の月末日を取得する
	 * @param mixed date1 対象日付
	 * @return string 月末日
	 */
	_getMonthEndDate(date1){
		if(date1 == null) return null;
		if((typeof date1) == 'string'){
			date1 = new Date(date1);
		}

		// 月末日の算出
		var mEndDate = new Date(date1.getFullYear(), date1.getMonth() + 1, 0);
		
		var year = mEndDate.getFullYear();
		var month = mEndDate.getMonth() + 1;
		var day = mEndDate.getDate();
		var date_str = year + '-' + month + '-' + day;
		return date_str;
	}
	
	/**
	 * データを日付で集計する
	 * @param object data 一覧テーブルからのデータ
	 * @param string date_field 日付フィールド
	 * @return object 日付集計データ
	 */
	_aggByDateField(data, date_field){
		
		var dataA = {}; // 日付集計データ
		for(var i in data){
			var ent = data[i];
			var date1 = ent[date_field];

			if(date1 == null) continue;
			if(dataA[date1] == null) dataA[date1] = [];
			dataA[date1].push(ent);
		}
		
		return dataA;
		
	}
	
	/**
	 * 日付整形
	 * @param date1 整形前日付
	 * @return string 整形後日付
	 */
	_shapingDate(date1){
		if(date1 == null) return null;
		
		if((typeof date1) == 'string'){
			date1 = new Date(date1);
		}
		var date1 = this._convDateToYMD(date1);
		return date1;
		
	}
	
	/**
	 * 日付オブジェクトを「y-m-d」形式の日付書式に変換する
	 * @param Date date1 日付オブジェクト
	 * @returns string 「y-m-d」形式の日付文字列
	 */
	_convDateToYMD(date1){
		var year = date1.getFullYear();
		var month = date1.getMonth() + 1;
		var day = date1.getDate();
		var date_str = year + '-' + month + '-' + day;
		return date_str;
	}
	
	
}
/**
 * ボタンサイズ変更【CrudBase用】
 * @version 1.0.0
 * @date 2018-10-27
 */
class CbBtnSizeChanger{
	
	/**
	 * コンストラクタ
	 * 
	 * @param object cnfData 設定データ（省略可）
	 * @param object param
	 * - save_flg 保存フラグ 0:保存しない , 1:保存する（デフォルト）
	 * - 
	 */
	constructor(param, cnfData){
		
		this.saveKeys = ['cnfData']; // ローカルストレージへ保存と読込を行うparamのキー。
		this.ls_key = "CbBtnSizeChanger"; // ローカルストレージにparamを保存するときのキー。
		this.param = this._setParamIfEmpty(param);
		
		// 設定データの初期化
		var cnfData = this._initCnfData(this.param, cnfData);
		
		// 設定フォームを作成
		var cnf_html = this._createCnfFormHtml(cnfData);
		var mainForm = jQuery(this.param.main_slt); // 設定フォーム
		mainForm.html(cnf_html);
		
		// 設定フォームにチェックイベント（クリックイベント）を組み込む
		this._setCheckEvent(mainForm, cnfData);
		
		// サブイベントをセットする
		this._setSubEvents(mainForm);
		
		// 保存フラグがONであるなら、設定データのボタンサイズ設定を各ボタンへ反映
		if(this.param.save_flg == 1){
			this._changeSizeAll(cnfData);
		}
		
		this.mainForm = mainForm;
		this.cnfData = cnfData;
		
	}
	
	/**
	 * If Param property is empty, set a value.
	 */
	_setParamIfEmpty(param){
		
		if(param == null) param = {};
	
		// ▼ ローカルストレージで保存していたパラメータをセットする
		var param_json = localStorage.getItem(this.ls_key);
		if(!this._empty(param_json)){
			var lsParam = JSON.parse(param_json);
			if(lsParam){
				for(var i in this.saveKeys){
					var s_key = this.saveKeys[i];
					param[s_key] = lsParam[s_key];
				}
			}
		}
		
		if(param['cnfData'] == null) param['cnfData'] = {};
		
		if(param['main_slt'] == null) param['main_slt'] = '#CbBtnSizeChanger';
		
		// ラジオボタンデータ
		if(param['radioData'] == null){
			param['radioData'] = [
				{'value':'btn-xs', 'wamei':' 極小'},
				{'value':'btn-sm', 'wamei':' 小　'},
				{'value':'', 'wamei':' 普通'},
				{'value':'btn-lg', 'wamei':' 大　'},
				]
		}
		
		if(param['save_flg'] == null) param['save_flg'] = 1;

		return param;
	}
	
	
	/**
	 * 設定データの生成
	 * @param param
	 * @param string cnfData 設定データ(引数）
	 * @return object 設定データ
	 */
	_initCnfData(param, cnfDataP){
		
		var cnfData = param.cnfData;
		if(this._empty(cnfDataP)) cnfDataP = {};
		
		jQuery.extend(cnfData, cnfDataP);

		if(this._empty(cnfData)) {
			
			cnfData = [
				{'slt':'.row_edit_btn','wamei':'編集ボタン','def_size':'btn-xs','size':'btn-xs'},
				{'slt':'.row_copy_btn','wamei':'複製ボタン','def_size':'btn-xs','size':'btn-xs'},
				{'slt':'.row_delete_btn','wamei':'削除ボタン','def_size':'btn-xs','size':'btn-xs'},
				{'slt':'.row_eliminate_btn','wamei':'抹消ボタン','def_size':'btn-xs','size':'btn-xs'},
				{'slt':'.row_exc_btn','wamei':'行入替ボタン(↑↓ボタン)','def_size':'btn-xs','size':'btn-xs'},
				{'slt':'.row_enabled_btn','wamei':'有効ボタン','def_size':'btn-xs','size':'btn-xs'},
				
			];
		}
		
		
		// ▼ セレクタからコード文字列を取得する
		for(var i in cnfData){
			var cnfEnt = cnfData[i];
			cnfEnt['code'] = this._getCodeFromSlt(cnfEnt.slt);
		}

		return cnfData;
		
	}
	
	/**
	 * セレクタからコード文字列を取得する
	 * @param string slt セレクタ
	 * @return string コード文字列
	 */
	_getCodeFromSlt(slt){
		
		var code = slt; // コード文字列
		
		// ▼ 先頭の一文字が「.」または「#」なら除去する。
		var s1 = code.charAt(0); // 先頭の一文字を取得する
		if(s1=='.' || s1=='#'){
			code = code.substr(1);
		}
		return code;
	}
	
	
	
	
	/**
	 * 設定フォームHTMLを作成
	 * @param object cnfData 設定フォーム
	 * @return string 設定フォームHTML
	 */
	_createCnfFormHtml(cnfData){
		
		// 設定一覧
		var html = "<div style='padding:10px;background-color:#8dbbf3;border-radius:5px;display:inline-block'><table class='tbl2'><tbody>";
		for(var i in cnfData){
			var cnfEnt = cnfData[i];
			html += "<tr>";
			html += "<td>" + cnfEnt.wamei + "</td>";
			var radios_html = this._createRadiosHtml(cnfEnt); // ラジオボタンHTMLを作成
			html += "<td>" + radios_html + "</td>";
			html += "</tr>";
		}
		html += "</tbody></table>";
		
		// 初期に戻すボタン
		html += "<input id='cbbsc_def_btn' type='button' value='初期に戻す' class='btn btn-default btn-xs' >";
		html += "<input id='cbbsc_close_btn' type='button' value='閉じる' class='btn btn-default btn-xs' >";
		html += "</div>";
		
		return html;
	}
	
	/**
	 * ラジオボタンHTMLを作成
	 * @param object cnfEnt 設定エンティティ
	 * @return string ラジオボタンHTML
	 */
	_createRadiosHtml(cnfEnt){
		
		var html = ""; // ラジオボタンHTML
		var radioData = this.param.radioData; // ラジオボタンデータ
		
		for(var i in radioData){
			var rEnt = radioData[i];
			
			var checked_str = '';
			if(rEnt.value == cnfEnt.size) checked_str = 'checked';
			
			var radio_name = 'cbbsc_r_' + cnfEnt.code;
			var radio_value = rEnt.value;
			
			var unit_radio_h = "<label class='btn btn-primary btn-sm'><input type='radio' " +
					"name='" + radio_name + "' " +
					"value='" + radio_value + "' " +
					checked_str + " >" +
					rEnt.wamei + "</label>";
			
			html += unit_radio_h;
		}
		
		html = "<div class='btn-group' >" + html + "</div>";
		return html;
	}
	
	
	/**
	 * 設定フォームにチェックイベント（クリックイベント）を組み込む
	 * @param jQuery mainForm 設定フォーム・jQueryオブジェクト
	 * @param object cnfData 設定データ
	 */
	_setCheckEvent(mainForm, cnfData){
		
		for(var i in cnfData){
			var cnfEnt = cnfData[i];
			var radio_name = 'cbbsc_r_' + cnfEnt.code;
			mainForm.find("[name='" + radio_name + "']").click((e)=>{
				this._checkEvent(e); // ラジオボタンのチェックイベント
			});
		}
	}
	
	/**
	 * ラジオボタンのチェックイベント
	 */
	_checkEvent(e){
		
		var radio = jQuery(e.target);
		
		var name = radio.attr('name');
		var value = radio.val();
		
		// name属性から設定エンティティを取得する
		var cnfEnt = this._getCnfEntByName(name);
		cnfEnt.size = value;

		// ▼設定エンティティのセレクタにひもづく要素をループしてサイズを変更する
		jQuery(cnfEnt.slt).each((i,btn) => {
			this._changeSize(btn,value);
		});
		
		if(this.param.save_flg == 1){
			this._saveParam(); // 設定を保存する
		}
		
	}
	
	/**
	 * name属性から設定エンティティを取得する
	 * @param string name ラジオボタンのname属性
	 * @return object 設定エンティティ
	 */
	_getCnfEntByName(name){
		
		var search_name = name.replace('cbbsc_r_', '');
		for(var i in this.cnfData){
			var cnfEnt = this.cnfData[i];
			if(cnfEnt.code == search_name){
				return cnfEnt;
			}
		}
		return null;
	}
	
	/**
	 * ボタン要素のサイズ変更する
	 * @param object btn ボタン要素
	 * @param string size サイズ文字列
	 */
	_changeSize(btn,size){
		btn = jQuery(btn);
		
		// ▼ ボタンサイズのclass属性をいったん除去する
		var radioData = this.param.radioData; // ラジオボタンデータ
		for(var i in radioData){
			var class_str = radioData[i].value; // ボタンサイズのclass属性  btn-xs, btn-sm, btn-lg
			if(class_str == '') continue;
			if(btn.hasClass(class_str)){
				if(size == class_str) return; // 変更不要であるなら処理抜け
				btn.removeClass(class_str);
			}
		}
		
		// サイズ文字列が空、つまり「普通」サイズならこの時点で処理を抜ける。
		if(size == '') return;
		
		// サイズ文字列をclass属性に追加する。
		btn.addClass(size);
		
	}
	
	
	/**
	 * 設定データのボタンサイズ設定を各ボタンへ反映
	 * @param cnfData 設定データ
	 */
	_changeSizeAll(cnfData){
		
		for(var i in cnfData){
			var cnfEnt = cnfData[i];
			jQuery(cnfEnt.slt).each((i,btn) => {
				this._changeSize(btn,cnfEnt.size);
			});
		}
	}
	

	/**
	 * サブイベントをセットする
	 * @param jQuery mainForm 設定フォーム・jQueryオブジェクト
	 */
	_setSubEvents(mainForm){
		
		// ▼「初期に戻す」ボタンにイベントをセットする
		mainForm.find("#cbbsc_def_btn").click((e)=>{
			this._returnToInit(); // 初期に戻す
		});
		
		// ▼「閉じる」ボタンにイベントをセットする
		mainForm.find("#cbbsc_close_btn").click((e)=>{
			this.mainForm.hide();
		});
		
	}
	
	/**
	 * 初期に戻す
	 */
	_returnToInit(){
		
		// ▼設定データを初期に戻す
		var cnfData = this.cnfData;
		for(var i in cnfData){
			var cnfEnt = cnfData[i];
			if(cnfEnt['def_size'] == null) cnfEnt['def_size'] = 'btn-xs';
			cnfEnt.size = cnfEnt.def_size;
		}
		
		// 設定データのボタンサイズ設定を各ボタンへ反映
		this._changeSizeAll(cnfData);
		
		// ラジオボタンに設定データを反映する
		this._setCnfDataToRadios(cnfData);

		// ローカルストレージに設定を保存
		this._saveParam();
	}
	
	
	/**
	 * ラジオボタンに設定データを反映する
	 * @param object cnfData 設定データ
	 */
	_setCnfDataToRadios(cnfData){
		
		for(var i in cnfData){
			var cnfEnt = cnfData[i];
			var radio_name = 'cbbsc_r_' + cnfEnt.code;
			var radio = this.mainForm.find("[name='" + radio_name + "'][value='" + cnfEnt.size + "']");
			if(radio[0]){
				radio.prop('checked',true);
			}
		}
		
	}


	/**
	 * ローカルストレージにパラメータを保存する
	 */
	_saveParam(){
		
		this.param['cnfData'] = this.cnfData;
		var lsParam = {};
		for(var i in this.saveKeys){
			var s_key = this.saveKeys[i];
			lsParam[s_key] = this.param[s_key];
		}
		var param_json = JSON.stringify(lsParam);
		localStorage.setItem(this.ls_key,param_json);
	}
	
	
	/**
	 * ローカルストレージで保存しているパラメータをクリアする
	 */
	_clear(){
		localStorage.removeItem(this.ls_key);
	}




	// Check empty.
	_empty(v){
		if(v == null || v == '' || v=='0'){
			return true;
		}else{
			if(typeof v == 'object'){
				if(Object.keys(v).length == 0){
					return true;
				}
			}
			return false;
		}
	}
}
/**
 * CrudBase・ファイルアップロードコンポーネント | CrudBase File Upload Component
 * 
 * @note
 * CurdBase.jsのコンポーネントの一つ
 * 
 * @date 2018-8-24 | 2019-2-13
 * @version 1.2.0
 * @history
 * 2019-2-13 v1.2.0 経由パス関連を廃止
 * 2018-10-9 v1.1.3 経由ディレクトリパスに対応
 * 2018-9-19 v1.1.2 ファイルアップロード機能：DnDに対応
 * 2018-9-18 v1.1.1 コールバックパラメータを追加（pacb_param)
 * 2018-9-17 v1.1.0 画像ファイルが空の時に新規登録すると2行目のサムネイル画像が表示される
 * 2018-8-24 v1.0.0 開発
 * 
 */
class CbFileUploadComponent{
	
	
	/**
	 * コンストラクタ
	 * 
	 * @param param fuIds file要素idリスト
	 * @param object option FileUploadK:addEventのoption
	 * 
	 */
	constructor(fuIds,option){
		
		
		this.fileUploadK = this._factoryFileUploadK(fuIds,option); // 拡張ファイルアップロード・オブジェクト
		
		this.fuIds = fuIds; // file要素idリスト
		this.fields = this._fueIdsToFields(fuIds); // FUフィールドリスト
		this.none_img_fp = 'img/icon/none.gif';
		
	}
	
	
	/**
	 * file要素idリストからフィールドリストを取得する
	 * @param array fuIds file要素idリスト
	 * @return array フィールドリスト
	 */
	_fueIdsToFields(fuIds){
		
		var fields = [];
		
		for(var i in fuIds){
			var fue_id = fuIds[i];
			var field = this._fudIdToField(fue_id); // file要素idからフィールドに変換する。
			fields.push(field);
		}
		
		fields = this._array_unique(fields); // 重複を除去する

		return fields;
	}
	
	/**
	 * file要素idからフィールドに変換する
	 * @param string fue_id file要素ID
	 * @return string フィールド
	 */
	_fudIdToField(fue_id){
		
		var field = fue_id; // フィールド
		if(fue_id == null) return field;
		if(fue_id.length < 3) return field;
		
		var es2 = field.slice(-2); // ディレクトリパスから末尾の2文字を取得する。
		
		
		if(es2 == '_n' || es2 == '_e'){
			var field = field.substr(0,field.length - 2);
		}
		
		return field;
	}
	
	
	/**
	* 配列から重複を除去する
	*/
	_array_unique(ary){
		var ary2= ary.filter(function (x, i, self) {
			return self.indexOf(x) === i;
		});
		
		return ary2;
	}
	


	/**
	 * 拡張ファイルアップロード・コンポーネントのファクトリーメソッド
	 * @param array fuIds file要素idリスト
	 * @param object option FileUploadK:addEventのoption
	 * @return FileUploadK 拡張ファイルアップロード・コンポーネント
	 */
	_factoryFileUploadK(fuIds,option){
		
		// 拡張ファイルアップロードクラスの生成
		var fileUploadK = new FileUploadK({
			'prog_slt':'#prog1',
			'err_slt':'#err',
			'valid_ext':'image',
			'img_width':120,
			'img_height':120,
			});
		
		
		// file要素を拡張
		for(var i in fuIds){
			var fue_id = fuIds[i];
			fileUploadK.addEvent(fue_id,option);
		}

		return fileUploadK;
		
	}
	
	
	
	/**
	 * ファイルアップロード関連のイベントを追加する。
	 * 
	 * @note
	 * ファイルチェンジイベントの追加。
	 * DnDイベントの追加
	 * 
	 * @param fue_id ファイルアップロード要素のid属性
	 * @param option 
	 *  - valid_ext バリデーション拡張子(詳細はconstructor()の引数を参照）
	 *  - pacb プレビュー後コールバック関数
	 *  - img_width プレビュー画像サイスX　（画像ファイルのみ影響）
	 *  - img_height プレビュー画像サイスY
	 */
	addEvent(fue_id,option){
		return this.fileUploadK.addEvent(fue_id,option);
	}
	
	
	/**
	 * ファイル群のパラメータデータを取得する
	 * @return object ファイル群のパラメータデータ
	 */
	getFileParams(){
		return this.fileUploadK.getFileParams();
	}
	
	
	/**
	 * AJAXによるアップロード
	 * 
	 * @param callback(res) ファイルアップロード後コールバック
	 * @param withData 一緒に送るデータ
	 * @param option 未使用
	 */
	uploadByAjax(callback,withData,option){
		return this.fileUploadK.uploadByAjax(callback,withData,option);
	}
	
	
	/**
	 * ファイル名リストを取得
	 * @param int fue_id ファイル要素のID属性値（省略可）
	 * @return array ファイル名リスト
	 */
	getFileNames(fue_id){
		return this.fileUploadK.getFileNames(fue_id);
	}
	
	
	/**
	 * file要素にファイルパスをセットする
	 * @param string fue_id file要素のid
	 * @param array fps ファイル名リスト（ ファイル名一つを文字列指定可）
	 * @param object option addEventのoptionと同じ
	 */
	setFilePaths(fue_id,fps,option){

		// file要素にファイルパスをセットする
		var res = this.fileUploadK.setFilePaths(fue_id,fps,option);

		return res;

	}
	
	
	/**
	 * 画像をTR要素に表示する
	 * @param jQuery tr TR要素オブジェクト
	 * @param object ent データエンティティ
	 */
	setImageToTr(tr,ent){

		for(var i in this.fields){
			var field = this.fields[i];
			
			// TR要素からLabel要素を取得する。
			var lbl = tr.find("[for='" + field + "']");
			if(!lbl[0]) continue;
			var imgElm = lbl.find('img');
			if(imgElm[0]){
				
				var fp = ent[field]; // ファイル名
				
				// ファイル名が空である場合、空画像パスをセットする。
				if(fp == null || fp == ''){
					imgElm.attr('src',this.none_img_fp);
					var aElm = lbl.find('a');
					if(aElm[0]){
						aElm.attr('href',this.none_img_fp);
					}
					return;
				}
				
				var orig_fp = fp; // オリジナルファイルパス
				var thum_fp = fp.replace('/orig/', '/thum/'); // サムネイルファイルパス

				// IMG要素に画像を表示する。
				var imgObj = new Image();
				imgObj.src = thum_fp;
				imgObj.onload = () => {
					imgElm.attr('src',thum_fp);
				};

				// アンカー要素を取得し、オリジナルファイルパスをセットする。
				var aElm = lbl.find('a');
				if(aElm[0]){
					aElm.attr('href',orig_fp);
				}
				
			}
			
			
		}
			
	}
	
	
	/**
	 * FDにファイルオブジェクトをセットする
	 * @param FileData fd FD
	 * @parma string form_type フォーム種別 :new_inp,edit
	 * @return FileData FD
	 */
	setFilesToFd(fd,form_type){

		var box = this.fileUploadK.box;

		for(var fu_id in box){

			var fieldInfo = this._getFieldInfoFromFuKey(fu_id); // fu_keyからフィールドInfoを取得する
			if(fieldInfo.form_type != form_type) continue;

			var files = box[fu_id]['files']; // FDにセット予定のファイルオブジェクトを取得する
			if(files == null) continue;
			if(files[0] == null) continue;
			
			var fileData = box[fu_id]['fileData']; // エラーチェックのためにフィールドデータを取得 （フィールドデータにはFU要素やDnD由来のMIME,サイズ、ファイル名がセットされている。）
			if(fileData[0] == null) continue;
			var fEnt = fileData[0]; // フィールドエンティティを取得 (単一アップロードなので一行目のみ取得)
			if(fEnt.err_flg == false){ // エラーでない場合
				fd.append(fieldInfo.field, files[0]); // FDにファイルオブジェクトをセットする
			}

		}
		return fd;

	}
	
	/**
	 * fu_keyからフィールドInfoを取得する
	 * @param string fu_id
	 * @return フィールドInfo
	 */
	_getFieldInfoFromFuKey(fu_id){
		
		// フィールドInfoのデフォルト
		var fieldInfo = {
				'fu_id':fu_id,
				'field':fu_id,
				'form_type':'none',
		}
		
		if(fu_id == null || fu_id == '') return fieldInfo;
		if(fu_id.length < 3) return fieldInfo;
		
		var end_str = fu_id.slice(-2); // 末尾の2文字を取得
		if(end_str == '_n'){
			fieldInfo.form_type = 'new_inp';
			fieldInfo.field = fu_id.substr(0,fu_id.length-2); // 末尾の2文字を削る
		}else if(end_str == '_e'){
			fieldInfo.form_type = 'edit';
			fieldInfo.field = fu_id.substr(0,fu_id.length-2);
		}else{
			return fieldInfo;
		}
		
		return fieldInfo;
		
	}
	
	
	
}
/**
 * Google翻訳API・キャッシュ機能拡張
 * 
 * @note
 * Google Transrate APIのキャッシュ機能付き拡張クラス
 * 
 * @date 2019-1-27 | 2019-2-2
 * @version 1.0.2
 * @licens MIT
 */
class CbGtaCash{
	
	/**
	 * コンストラクタ
	 * @param object param
	 * - slt 翻訳言語SELECT要素のセレクタ
	 * - ajax_url AJAX URL
	 * - changed_select_callback SELECT変更コールバック
	 */
	constructor(param){
		param = this._setParamIfEmpty(param);
		this.param = param;
		this.jaTextList = {}; // 日本語テキストリスト
	}
	
	/**
	 * 初期化
	 * @param string page_code ページコード  ページごとに指定された一意コード
	 * @param array xids 翻訳テキスト区分のID属性リスト
	 * @param object param 省略可（コンストラクタで設定している場合）
	 */
	init(page_code, xids, param){
		if(param) jQuery.extend(this.param, param);
		param = this.param;
		this.xids = xids;
		this.page_code = page_code;

		// 言語データを取得
		var langData = this._getLangData();
		this.langData = langData;
		// 言語データからSELECT要素の選択肢HTMLを生成し、SELECT要素に埋め込む。
		var select_option_html = this._createSelectOptionHtml(langData);
		var selElm = jQuery(param.slt);
		selElm.html(select_option_html);
		
		// 翻訳SELECTのチェンジイベントを組み込み
		selElm.change((evt) => {
			var selElm = jQuery(evt.currentTarget);
			var lang = selElm.val();
			if(lang == '') return;
			this.cashTransExe(this, lang); // キャッシュ翻訳実行
			
			if(this.param.changed_select_callback){
				this.param.changed_select_callback(selElm);
			}
		});
		
	}
	
	/**
	 * キャッシュ翻訳実行
	 * @param string lang 言語コード
	 */
	cashTransExe(self, lang){
		
		var data = [];
		for(var i in self.xids){
			var xid = self.xids[i];
			if(xid == null || xid=='') return;
			// ▼ 日本語テキストを取得する
			xid = self._setSharp(xid); // 「#」が付いていなければ付加する。
			
			// ▼ 日本語テキストリストを取得する
			if(self.jaTextList[xid] == null){
				var jaTextElm = jQuery(xid);
				if(jaTextElm[0] == null) continue;
				self.jaTextList[xid] = jQuery(xid).html(); // ID属性に紐づく日本語テキストを取得
			}
			var ja_text = self.jaTextList[xid];
			
			var ent = {
				'lang':lang,
				'xid':xid,
				'ja_text':ja_text,
			};
			
			data.push(ent);
			
		}
		
		// キャッシュ翻訳実行AJAX
		self._cashTransExeAjax(self.page_code, lang, data);
	}
	
	/**
	 * キャッシュ翻訳実行AJAX
	 * @param string page_code ページコード
	 * @param string lang 言語コード
	 * @param array data 
	 */
	_cashTransExeAjax(page_code, lang, data){
		// PHPのJSONデコードでエラーになるので、＆だけ変換しておく。
		for(var i in data){
			var ent = data[i];
			ent.ja_text = ent.ja_text.replace(/&/g, '%26'); 
		}
		
		// 送信データ
		var sendData={
				'action_code':'get_cash',
				'page_code':page_code,
				'lang':lang,
				'data':data,
			};
		
		//sendData={'action_code':'get_cash'};
		
		var send_json = JSON.stringify(sendData);//データをJSON文字列にする。
		var ajax_url = this.param.ajax_url;
		
		// AJAX
		jQuery.ajax({
			type: "POST",
			
			url: ajax_url,
			data: "key1=" + send_json,
			cache: false,
			dataType: "text",
		})
		.done((res_json, type) => {
			
			var res;
			try{
				res =jQuery.parseJSON(res_json);//パース
			}catch(e){
				jQuery("#err").append(res_json);
				return;
			}
			this._cashTrans(res); // キャッシュ翻訳レスポンス
			
		})
		.fail((jqXHR, statusText, errorThrown) => {
			jQuery('#err').append('アクセスエラー');
			jQuery('#err').append(jqXHR.responseText);
			
		});
	}
	
	
	/**
	 * キャッシュ翻訳レスポンス
	 */
	_cashTrans(data){

		// 翻訳ボタンをすべて非表示にする
		jQuery('.cb_gta_cash_btn').hide();

		for(var i in data){
			var ent = data[i];
			if(ent.t_cash_flg == 1){
				// 翻訳キャッシュフラグがONである場合、翻訳テキストをID属性に紐づく要素にセットする。
				jQuery(ent.xid).html(ent.trans_text);
			}else{
				// 翻訳ボタンの作成とイベント組み込み
				this._createCbGtaCashBtn(ent);
			}
		}
	}
	
	/**
	 * 翻訳ボタンの作成とイベント組み込み
	 * @param object ent
	 */
	_createCbGtaCashBtn(ent){
		
		var lang_name = this._getLangName(ent.lang);// 言語コードから言語名（lang_name）を取得する
		var btn_name = lang_name;	// 言語名からボタン名を組み立てる。

		var ttElm = jQuery(ent.xid);// ID属性に紐づく要素を翻訳対象要素として取得する
		var cgcBtn = ttElm.find('.cb_gta_cash_btn'); // 翻訳対象要素から「.cb_gta_cash_btn」で翻訳ボタン要素を取得する
		
		// 翻訳ボタン要素が存在する場合,翻訳ボタンの属性をいくつか書き換え、表示する（翻訳ボタン作成済みである場合）
		if(cgcBtn[0]){
			cgcBtn.val(btn_name); // ボタン名を変更
			cgcBtn.attr('data-lang', ent.lang); // 言語コードは変更
			cgcBtn.show(); 
			return;
		}
		
		// ▼ 翻訳ボタン要素が存在しない場合
		

		
		// 翻訳ボタンHTMLを組み立てる。data_xid属性にID属性を、data_lang属性に言語コードをセット
		var cgc_btn_html = `<input type="button" value="${btn_name}" 
			class="cb_gta_cash_btn btn btn-success btn-sm" data-xid="${ent.xid}" data-lang="${ent.lang}"/>`;
		
		var wElm = ttElm.find('.cb_gta_cash_wb'); // 翻訳対象要素から翻訳ボタンラップを探す
		
		// 翻訳ボタンラップ要素が存在する場合
		if(wElm[0]){
			wElm.html(cgc_btn_html); // 翻訳ボタンラップ要素に翻訳ボタンHTMLをセットする
		}else{
		// 翻訳ボタンラップ要素が存在しない場合
			cgc_btn_html = "<div class='cb_gta_cash_wb'>" + cgc_btn_html + "</div>"; // 翻訳ボタンラップで翻訳ボタンHTMLを包む
			ttElm.prepend(cgc_btn_html); // 翻訳対象要素の先頭に翻訳ボタンHTMLを挿入する
			
		}
		
		cgcBtn = ttElm.find(`[data-xid='${ent.xid}']`); // data-xidに対し、翻訳ボタン要素を再取得する
		
		// 翻訳ボタン要素にクリックイベントを組み込む
		cgcBtn.click(evt=>{
			var btnElm = $(evt.currentTarget);
			this.apiTranseAction(btnElm);
		});
	}
	
	
	/**
	 * API翻訳アクション
	 * @param jQuery btnElm 翻訳ボタン要素
	 */
	apiTranseAction(btnElm){
		
		// すべての翻訳ボタンを押せなくする。（Google Transe APIは数秒のインターバルを必要とするため）
		jQuery('.cb_gta_cash_btn').prop('disabled', true);
		
		// ボタン要素からID属性と言語コードを取得する
		var xid = btnElm.attr('data-xid');
		var lang = btnElm.attr('data-lang');
		var ja_text = this.jaTextList[xid]; // 日本語テキストを取得
		ja_text = ja_text.replace(/&/g, '%26'); // PHPのJSONデコードでエラーになるので、＆だけ変換しておく。
		
		// 送信データ
		var sendData={
				'action_code':'api_transe',
				'page_code':this.page_code,
				'lang':lang,
				'xid':xid,
				'ja_text':ja_text,
			};
		var send_json = JSON.stringify(sendData);//データをJSON文字列にする。
		var ajax_url = this.param.ajax_url;
		
		// AJAX
		jQuery.ajax({
			type: "POST",
			url: ajax_url,
			data: "key1=" + send_json,
			cache: false,
			dataType: "text",
		})
		.done((res_json, type) => {
			var res;
			try{
				res =jQuery.parseJSON(res_json);//パース
			}catch(e){
				jQuery("#err").append(res_json);
				return;
			}
			
			// 翻訳テキストをID属性に紐づく要素にセットする。
			jQuery(res.xid).html(res.trans_text);
			
			setTimeout(function(){jQuery('.cb_gta_cash_btn').prop('disabled', false);}, 3000);
			
		})
		.fail((jqXHR, statusText, errorThrown) => {
			jQuery('#err').append('アクセスエラー');
			jQuery('#err').append(jqXHR.responseText);
			
		});
	}
	
	
	
	/**
	 * 言語コードから言語名を取得する
	 * @param string lang 言語コード
	 * @reutrn string 言語名
	 */
	_getLangName(lang){
		
		var lang_name = 'none';
		var langData = this.langData;
		for(var i in langData){
			var ent = langData[i];
			if(ent['iso639-1'] == lang){
				lang_name = ent.lang_name;
				break;
			}
		}
		return lang_name;
	}
	
	
	/**
	 *  「#」が付いていなければ付加する
	 * @param string xid ID属性
	 * @return string 「#」付きのID属性
	 */
	_setSharp(xid){
		var s1 = xid.charAt(0);
		if(s1 != '#'){
			xid = '#' + xid;
		}
		return xid;
	}

	/**
	 * 言語データからSELECT要素の選択肢HTMLを生成し、SELECT要素に埋め込む。
	 * @param object langData 言語データ
	 */
	_createSelectOptionHtml(langData){
		var html = "<option value='' > -- Language -- </option>";
		for(var i in langData){
			var ent = langData[i];
			var lang_name = ent.wamei + '  ' + ent.lang_name;
			html += "<option value='" + ent['iso639-1'] + "' >" +  lang_name + "</option>";
		}
		
		return html;
	}

	
	/**
	 * If Param property is empty, set a value.
	 */
	_setParamIfEmpty(param){
		
		if(param['slt'] == null) param['slt'] = '#cb_gta_cash';
		if(param['ajax_url'] == null) throw new Error('Empty ajax_url !');
		
		
		return param;
	}
	
	
	/**
	 * 言語データを取得
	 * @returns object 言語データ
	 */
	_getLangData(){
		
		var langData = [
			{"lang_nation":"インド・ヨーロッパ語族","wamei":"英語","lang_name":"English","iso639-1":"en","iso639-2T":"eng","iso639-2B":"eng","iso639-3":"eng","iso639-6":"engs","note":"","google_api":true},
//			{"lang_nation":"シナ・チベット語族","wamei":"中国語","lang_name":"中文,汉语,漢語","iso639-1":"zh","iso639-2T":"zho","iso639-2B":"chi","iso639-3":"zho","iso639-6":"","note":"マクロランゲージ","google_api":true},
//			{"lang_nation":"中国語繁体字","wamei":"中国語繁体字","lang_name":"中文,繁体字","iso639-1":"zh-TW","iso639-2T":"zh-TW","iso639-2B":"zh-TW","iso639-3":"zh-TW","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"朝鮮語族","wamei":"ハングル","lang_name":"한국어 (韓國語),조선어 (朝鮮語)","iso639-1":"ko","iso639-2T":"kor","iso639-2B":"kor","iso639-3":"kor","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ドイツ語","lang_name":"Deutsch","iso639-1":"de","iso639-2T":"deu","iso639-2B":"ger","iso639-3":"deu","iso639-6":"deus","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"フランス語","lang_name":"français","iso639-1":"fr","iso639-2T":"fra","iso639-2B":"fre","iso639-3":"fra","iso639-6":"fras","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"スペイン語","lang_name":"español,castellano","iso639-1":"es","iso639-2T":"spa","iso639-2B":"spa","iso639-3":"spa","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ポルトガル語","lang_name":"português","iso639-1":"pt","iso639-2T":"por","iso639-2B":"por","iso639-3":"por","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ベンガル語","lang_name":"বাংলা","iso639-1":"bn","iso639-2T":"ben","iso639-2B":"ben","iso639-3":"ben","iso639-6":"","note":"","google_api":true},

//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ギリシア語","lang_name":"ελληνικά","iso639-1":"el","iso639-2T":"ell","iso639-2B":"gre","iso639-3":"ell","iso639-6":"ells","note":"","google_api":true},

//			{"lang_nation":"北西コーカサス語族","wamei":"アブハズ語","lang_name":"аҧсуа бызшәа,аҧсшәа","iso639-1":"ab","iso639-2T":"abk","iso639-2B":"abk","iso639-3":"abk","iso639-6":"abks","note":"","google_api":false},
//			{"lang_nation":"アフロ・アジア語族","wamei":"アファル語","lang_name":"Qafár af","iso639-1":"aa","iso639-2T":"aar","iso639-2B":"aar","iso639-3":"aar","iso639-6":"aars","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"アフリカーンス語","lang_name":"Afrikaans","iso639-1":"af","iso639-2T":"afr","iso639-2B":"afr","iso639-3":"afr","iso639-6":"afrs","note":"","google_api":true},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"アカン語","lang_name":"Akan","iso639-1":"ak","iso639-2T":"aka","iso639-2B":"aka","iso639-3":"aka","iso639-6":"","note":"マクロランゲージ","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"アルバニア語","lang_name":"Gjuha shqipe","iso639-1":"sq","iso639-2T":"sqi","iso639-2B":"alb","iso639-3":"sqi","iso639-6":"","note":"マクロランゲージ","google_api":true},
//			{"lang_nation":"アフロ・アジア語族","wamei":"アムハラ語","lang_name":"አማርኛ","iso639-1":"am","iso639-2T":"amh","iso639-2B":"amh","iso639-3":"amh","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"アフロ・アジア語族","wamei":"アラビア語","lang_name":"العربية","iso639-1":"ar","iso639-2T":"ara","iso639-2B":"ara","iso639-3":"ara","iso639-6":"","note":"マクロランゲージ","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"アラゴン語","lang_name":"aragonés","iso639-1":"an","iso639-2T":"arg","iso639-2B":"arg","iso639-3":"arg","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"アルメニア語","lang_name":"Հայերեն","iso639-1":"hy","iso639-2T":"hye","iso639-2B":"arm","iso639-3":"hye","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"アッサム語","lang_name":"অসমীয়া","iso639-1":"as","iso639-2T":"asm","iso639-2B":"asm","iso639-3":"asm","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"北東コーカサス語族","wamei":"アヴァル語","lang_name":"Авар мацӀ,МагӀарул мацӀ","iso639-1":"av","iso639-2T":"ava","iso639-2B":"ava","iso639-3":"ava","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"アヴェスター語","lang_name":"―","iso639-1":"ae","iso639-2T":"ave","iso639-2B":"ave","iso639-3":"ave","iso639-6":"","note":"古代言語","google_api":false},
//			{"lang_nation":"アイマラ語族","wamei":"アイマラ語","lang_name":"Aymar aru","iso639-1":"ay","iso639-2T":"aym","iso639-2B":"aym","iso639-3":"aym","iso639-6":"","note":"マクロランゲージ","google_api":false},
//			{"lang_nation":"テュルク語族","wamei":"アゼルバイジャン語","lang_name":"Azərbaycanca,تورک دیلی‎","iso639-1":"az","iso639-2T":"aze","iso639-2B":"aze","iso639-3":"aze","iso639-6":"","note":"マクロランゲージ","google_api":true},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"バンバラ語","lang_name":"bamanankan","iso639-1":"bm","iso639-2T":"bam","iso639-2B":"bam","iso639-3":"bam","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"テュルク語族","wamei":"バシキール語","lang_name":"башҡорт теле","iso639-1":"ba","iso639-2T":"bak","iso639-2B":"bak","iso639-3":"bak","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"孤立した言語","wamei":"バスク語","lang_name":"euskara","iso639-1":"eu","iso639-2T":"eus","iso639-2B":"baq","iso639-3":"eus","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ベラルーシ語","lang_name":"беларуская мова","iso639-1":"be","iso639-2T":"bel","iso639-2B":"bel","iso639-3":"bel","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ビハール語","lang_name":"―","iso639-1":"bh","iso639-2T":"bih","iso639-2B":"bih","iso639-3":"–","iso639-6":"","note":"集合的言語","google_api":false},
//			{"lang_nation":"クレオール言語","wamei":"ビスラマ語","lang_name":"Bislama","iso639-1":"bi","iso639-2T":"bis","iso639-2B":"bis","iso639-3":"bis","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ボスニア語","lang_name":"bosanski jezik","iso639-1":"bs","iso639-2T":"bos","iso639-2B":"bos","iso639-3":"bos","iso639-6":"boss","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ブルトン語","lang_name":"brezhoneg","iso639-1":"br","iso639-2T":"bre","iso639-2B":"bre","iso639-3":"bre","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ブルガリア語","lang_name":"български език","iso639-1":"bg","iso639-2T":"bul","iso639-2B":"bul","iso639-3":"bul","iso639-6":"buls","note":"","google_api":true},
//			{"lang_nation":"シナ・チベット語族","wamei":"ビルマ語","lang_name":"မြန်မာဘာသာ","iso639-1":"my","iso639-2T":"mya","iso639-2B":"bur","iso639-3":"mya","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"カタルーニャ語、バレンシア語","lang_name":"català,valencià","iso639-1":"ca","iso639-2T":"cat","iso639-2B":"cat","iso639-3":"cat","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"オーストロネシア語族","wamei":"チャモロ語","lang_name":"Fino' Chamoru","iso639-1":"ch","iso639-2T":"cha","iso639-2B":"cha","iso639-3":"cha","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"北東コーカサス語族","wamei":"チェチェン語","lang_name":"нохчийн мотт","iso639-1":"ce","iso639-2T":"che","iso639-2B":"che","iso639-3":"che","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"チェワ語","lang_name":"Chicheŵa,Chichewa","iso639-1":"ny","iso639-2T":"nya","iso639-2B":"nya","iso639-3":"nya","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"テュルク語族","wamei":"チュヴァシ語","lang_name":"Чăвашла","iso639-1":"cv","iso639-2T":"chv","iso639-2B":"chv","iso639-3":"chv","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"コーンウォール語","lang_name":"Kernowek","iso639-1":"kw","iso639-2T":"cor","iso639-2B":"cor","iso639-3":"cor","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"コルシカ語","lang_name":"corsu,lingua corsa","iso639-1":"co","iso639-2T":"cos","iso639-2B":"cos","iso639-3":"cos","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"アルゴンキン語族","wamei":"クリー語","lang_name":"Nēhiyawēwin,ᓀᐦᐃᔭᐍᐏᐣ","iso639-1":"cr","iso639-2T":"cre","iso639-2B":"cre","iso639-3":"cre","iso639-6":"","note":"マクロランゲージ","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"クロアチア語","lang_name":"hrvatski","iso639-1":"hr","iso639-2T":"hrv","iso639-2B":"hrv","iso639-3":"hrv","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"チェコ語","lang_name":"čeština,český jazyk","iso639-1":"cs","iso639-2T":"ces","iso639-2B":"cze","iso639-3":"ces","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"デンマーク語","lang_name":"dansk","iso639-1":"da","iso639-2T":"dan","iso639-2B":"dan","iso639-3":"dan","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ディベヒ語","lang_name":"ދިވެހި","iso639-1":"dv","iso639-2T":"div","iso639-2B":"div","iso639-3":"div","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"オランダ語","lang_name":"Nederlands","iso639-1":"nl","iso639-2T":"nld","iso639-2B":"dut","iso639-3":"nld","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"シナ・チベット語族","wamei":"ゾンカ語","lang_name":"རྫོང་ཁ","iso639-1":"dz","iso639-2T":"dzo","iso639-2B":"dzo","iso639-3":"dzo","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"人工言語","wamei":"エスペラント","lang_name":"Esperanto","iso639-1":"eo","iso639-2T":"epo","iso639-2B":"epo","iso639-3":"epo","iso639-6":"","note":"ルドヴィコ・ザメンホフが1887年に発表","google_api":true},
//			{"lang_nation":"ウラル語族","wamei":"エストニア語","lang_name":"eesti keel","iso639-1":"et","iso639-2T":"est","iso639-2B":"est","iso639-3":"est","iso639-6":"","note":"マクロランゲージ","google_api":true},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"エウェ語","lang_name":"Eʋegbe","iso639-1":"ee","iso639-2T":"ewe","iso639-2B":"ewe","iso639-3":"ewe","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"フェロー語","lang_name":"føroyskt","iso639-1":"fo","iso639-2T":"fao","iso639-2B":"fao","iso639-3":"fao","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"オーストロネシア語族","wamei":"フィジー語","lang_name":"Na vosa vaka-Viti","iso639-1":"fj","iso639-2T":"fij","iso639-2B":"fij","iso639-3":"fij","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"ウラル語族","wamei":"フィンランド語","lang_name":"suomi,suomen kieli","iso639-1":"fi","iso639-2T":"fin","iso639-2B":"fin","iso639-3":"fin","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"フラニ語","lang_name":"Fulfulde,Pulaar,Pular","iso639-1":"ff","iso639-2T":"ful","iso639-2B":"ful","iso639-3":"ful","iso639-6":" ","note":"マクロランゲージ","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ガリシア語","lang_name":"galego","iso639-1":"gl","iso639-2T":"glg","iso639-2B":"glg","iso639-3":"glg","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"南コーカサス語族","wamei":"グルジア語","lang_name":"ქართული","iso639-1":"ka","iso639-2T":"kat","iso639-2B":"geo","iso639-3":"kat","iso639-6":"","note":"","google_api":true},

//			{"lang_nation":"トゥピ語族","wamei":"グアラニー語","lang_name":"avañe'ẽ","iso639-1":"gn","iso639-2T":"grn","iso639-2B":"grn","iso639-3":"grn","iso639-6":" ","note":"マクロランゲージ","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"グジャラート語","lang_name":"ગુજરાતી","iso639-1":"gu","iso639-2T":"guj","iso639-2B":"guj","iso639-3":"guj","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"クレオール言語","wamei":"ハイチ語","lang_name":"Kreyòl ayisyen","iso639-1":"ht","iso639-2T":"hat","iso639-2B":"hat","iso639-3":"hat","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"アフロ・アジア語族","wamei":"ハウサ語","lang_name":"Hausa,هَوُسَ","iso639-1":"ha","iso639-2T":"hau","iso639-2B":"hau","iso639-3":"hau","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"アフロ・アジア語族","wamei":"ヘブライ語","lang_name":"עברית","iso639-1":"he","iso639-2T":"heb","iso639-2B":"heb","iso639-3":"heb","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"ヘレロ語","lang_name":"Otjiherero","iso639-1":"hz","iso639-2T":"her","iso639-2B":"her","iso639-3":"her","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ヒンディー語","lang_name":"हिन्दी","iso639-1":"hi","iso639-2T":"hin","iso639-2B":"hin","iso639-3":"hin","iso639-6":"hins","note":"","google_api":true},
//			{"lang_nation":"オーストロネシア語族","wamei":"ヒリモツ語","lang_name":"Hiri Motu","iso639-1":"ho","iso639-2T":"hmo","iso639-2B":"hmo","iso639-3":"hmo","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"ウラル語族","wamei":"ハンガリー語","lang_name":"magyar","iso639-1":"hu","iso639-2T":"hun","iso639-2B":"hun","iso639-3":"hun","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"人工言語","wamei":"インターリングア","lang_name":"Interlingua","iso639-1":"ia","iso639-2T":"ina","iso639-2B":"ina","iso639-3":"ina","iso639-6":" ","note":"国際補助語協会が1951年に発表","google_api":false},
//			{"lang_nation":"オーストロネシア語族","wamei":"インドネシア語","lang_name":"Bahasa Indonesia","iso639-1":"id","iso639-2T":"ind","iso639-2B":"ind","iso639-3":"ind","iso639-6":" ","note":"","google_api":true},
//			{"lang_nation":"人工言語","wamei":"インターリング","lang_name":"Interlingue","iso639-1":"ie","iso639-2T":"ile","iso639-2B":"ile","iso639-3":"ile","iso639-6":" ","note":"エドガー・フォン・ヴァールが1922年に発表","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"アイルランド語","lang_name":"Gaeilge","iso639-1":"ga","iso639-2T":"gle","iso639-2B":"gle","iso639-3":"gle","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"イボ語","lang_name":"asụsụ Igbo","iso639-1":"ig","iso639-2T":"ibo","iso639-2B":"ibo","iso639-3":"ibo","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"エスキモー・アレウト語族","wamei":"イヌピアック語","lang_name":"Iñupiak,Iñupiatun","iso639-1":"ik","iso639-2T":"ipk","iso639-2B":"ipk","iso639-3":"ipk","iso639-6":" ","note":"マクロランゲージ","google_api":false},
//			{"lang_nation":"人工言語","wamei":"イド語","lang_name":"Ido","iso639-1":"io","iso639-2T":"ido","iso639-2B":"ido","iso639-3":"ido","iso639-6":"idos","note":"ルイ・ド・ボーフロンが1907年に発表","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"アイスランド語","lang_name":"íslenska","iso639-1":"is","iso639-2T":"isl","iso639-2B":"ice","iso639-3":"isl","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"イタリア語","lang_name":"Italiano","iso639-1":"it","iso639-2T":"ita","iso639-2B":"ita","iso639-3":"ita","iso639-6":"itas","note":"","google_api":true},
//			{"lang_nation":"エスキモー・アレウト語族","wamei":"イヌクティトゥット語","lang_name":"ᐃᓄᒃᑎᑐᑦ","iso639-1":"iu","iso639-2T":"iku","iso639-2B":"iku","iso639-3":"iku","iso639-6":" ","note":"マクロランゲージ","google_api":false},
//			{"lang_nation":"オーストロネシア語族","wamei":"ジャワ語","lang_name":"Basa Jawa,ꦧꦱꦗꦮ","iso639-1":"jv","iso639-2T":"jav","iso639-2B":"jav","iso639-3":"jav","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"エスキモー・アレウト語族","wamei":"グリーンランド語","lang_name":"kalaallisut","iso639-1":"kl","iso639-2T":"kal","iso639-2B":"kal","iso639-3":"kal","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"ドラヴィダ語族","wamei":"カンナダ語","lang_name":"ಕನ್ನಡ","iso639-1":"kn","iso639-2T":"kan","iso639-2B":"kan","iso639-3":"kan","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"ナイル・サハラ語族","wamei":"カヌリ語","lang_name":"Kanuri","iso639-1":"kr","iso639-2T":"kau","iso639-2B":"kau","iso639-3":"kau","iso639-6":" ","note":"マクロランゲージ","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"カシミール語","lang_name":"कॉशुर,کٲشُر‎","iso639-1":"ks","iso639-2T":"kas","iso639-2B":"kas","iso639-3":"kas","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"テュルク語族","wamei":"カザフ語","lang_name":"Қазақ тілі,Qazaq tili,قازاق ٴتىلى‎","iso639-1":"kk","iso639-2T":"kaz","iso639-2B":"kaz","iso639-3":"kaz","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"オーストロアジア語族","wamei":"クメール語","lang_name":"ភាសាខ្មែរ","iso639-1":"km","iso639-2T":"khm","iso639-2B":"khm","iso639-3":"khm","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"キクユ語","lang_name":"Gĩkũyũ","iso639-1":"ki","iso639-2T":"kik","iso639-2B":"kik","iso639-3":"kik","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"ルワンダ語","lang_name":"Kinyarwanda","iso639-1":"rw","iso639-2T":"kin","iso639-2B":"kin","iso639-3":"kin","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"テュルク語族","wamei":"キルギス語","lang_name":"Кыргызча,Кыргыз тили,قىرعىز تىلى‎","iso639-1":"ky","iso639-2T":"kir","iso639-2B":"kir","iso639-3":"kir","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"ウラル語族","wamei":"コミ語","lang_name":"Коми","iso639-1":"kv","iso639-2T":"kom","iso639-2B":"kom","iso639-3":"kom","iso639-6":" ","note":"マクロランゲージ","google_api":false},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"コンゴ語","lang_name":"Kikongo","iso639-1":"kg","iso639-2T":"kon","iso639-2B":"kon","iso639-3":"kon","iso639-6":" ","note":"マクロランゲージ","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"クルド語","lang_name":"Kurdî,كوردی‎","iso639-1":"ku","iso639-2T":"kur","iso639-2B":"kur","iso639-3":"kur","iso639-6":"","note":"マクロランゲージ","google_api":true},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"クワニャマ語","lang_name":"Oshikwanyama","iso639-1":"kj","iso639-2T":"kua","iso639-2B":"kua","iso639-3":"kua","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ラテン語","lang_name":"latina","iso639-1":"la","iso639-2T":"lat","iso639-2B":"lat","iso639-3":"lat","iso639-6":"lats","note":"古代言語","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ルクセンブルク語","lang_name":"Lëtzebuergesch","iso639-1":"lb","iso639-2T":"ltz","iso639-2B":"ltz","iso639-3":"ltz","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"ルガンダ語","lang_name":"Luganda","iso639-1":"lg","iso639-2T":"lug","iso639-2B":"lug","iso639-3":"lug","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"リンブルフ語","lang_name":"Limburgs","iso639-1":"li","iso639-2T":"lim","iso639-2B":"lim","iso639-3":"lim","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"リンガラ語","lang_name":"Lingála","iso639-1":"ln","iso639-2T":"lin","iso639-2B":"lin","iso639-3":"lin","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"タイ・カダイ語族","wamei":"ラーオ語","lang_name":"ພາສາລາວ","iso639-1":"lo","iso639-2T":"lao","iso639-2B":"lao","iso639-3":"lao","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"リトアニア語","lang_name":"lietuvių","iso639-1":"lt","iso639-2T":"lit","iso639-2B":"lit","iso639-3":"lit","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"ルバ・カタンガ語","lang_name":"Kiluba","iso639-1":"lu","iso639-2T":"lub","iso639-2B":"lub","iso639-3":"lub","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ラトビア語","lang_name":"latviešu","iso639-1":"lv","iso639-2T":"lav","iso639-2B":"lav","iso639-3":"lav","iso639-6":"","note":"マクロランゲージ","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"マン島語","lang_name":"Gaelg,Gailck","iso639-1":"gv","iso639-2T":"glv","iso639-2B":"glv","iso639-3":"glv","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"マケドニア語","lang_name":"македонски јазик","iso639-1":"mk","iso639-2T":"mkd","iso639-2B":"mac","iso639-3":"mkd","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"オーストロネシア語族","wamei":"マダガスカル語","lang_name":"Malagasy","iso639-1":"mg","iso639-2T":"mlg","iso639-2B":"mlg","iso639-3":"mlg","iso639-6":"","note":"マクロランゲージ","google_api":true},
//			{"lang_nation":"オーストロネシア語族","wamei":"マレー語","lang_name":"bahasa Melayu,بهاس ملايو‎","iso639-1":"ms","iso639-2T":"msa","iso639-2B":"may","iso639-3":"msa","iso639-6":"","note":"マクロランゲージ","google_api":true},
//			{"lang_nation":"ドラヴィダ語族","wamei":"マラヤーラム語","lang_name":"മലയാളം","iso639-1":"ml","iso639-2T":"mal","iso639-2B":"mal","iso639-3":"mal","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"アフロ・アジア語族","wamei":" マルタ語","lang_name":"Malti","iso639-1":"mt","iso639-2T":"mlt","iso639-2B":"mlt","iso639-3":"mlt","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"オーストロネシア語族","wamei":"マオリ語","lang_name":"reo Māori","iso639-1":"mi","iso639-2T":"mri","iso639-2B":"mao","iso639-3":"mri","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"マラーティー語","lang_name":"मराठी","iso639-1":"mr","iso639-2T":"mar","iso639-2B":"mar","iso639-3":"mar","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"オーストロネシア語族","wamei":"マーシャル語","lang_name":"Kajin M̧ajeļ","iso639-1":"mh","iso639-2T":"mah","iso639-2B":"mah","iso639-3":"mah","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"モンゴル語族","wamei":"モンゴル語","lang_name":"Монгол хэл,ᠮᠣᠨᠭᠭᠣᠯ ᠬᠡᠯᠡ","iso639-1":"mn","iso639-2T":"mon","iso639-2B":"mon","iso639-3":"mon","iso639-6":"","note":"マクロランゲージ","google_api":true},
//			{"lang_nation":"オーストロネシア語族","wamei":"ナウル語","lang_name":"dorerin Naoero","iso639-1":"na","iso639-2T":"nau","iso639-2B":"nau","iso639-3":"nau","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"ナ・デネ語族","wamei":"ナバホ語","lang_name":"Diné bizaad","iso639-1":"nv","iso639-2T":"nav","iso639-2B":"nav","iso639-3":"nav","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ノルウェー語(ブークモール)","lang_name":"norsk bokmål","iso639-1":"nb","iso639-2T":"nob","iso639-2B":"nob","iso639-3":"nob","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"北ンデベレ語","lang_name":"isiNdebele","iso639-1":"nd","iso639-2T":"nde","iso639-2B":"nde","iso639-3":"nde","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ネパール語","lang_name":"नेपाली भाषा","iso639-1":"ne","iso639-2T":"nep","iso639-2B":"nep","iso639-3":"nep","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"ンドンガ語","lang_name":"Oshiwambo,Owambo","iso639-1":"ng","iso639-2T":"ndo","iso639-2B":"ndo","iso639-3":"ndo","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ノルウェー語(ニーノシュク)","lang_name":"norsk nynorsk","iso639-1":"nn","iso639-2T":"nno","iso639-2B":"nno","iso639-3":"nno","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ノルウェー語","lang_name":"norsk","iso639-1":"no","iso639-2T":"nor","iso639-2B":"nor","iso639-3":"nor","iso639-6":"","note":"マクロランゲージ","google_api":true},
//			{"lang_nation":"シナ・チベット語族","wamei":"四川彝語","lang_name":"ꆈꌠ꒿","iso639-1":"ii","iso639-2T":"iii","iso639-2B":"iii","iso639-3":"iii","iso639-6":" ","note":"彝語の北部方言","google_api":false},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"南ンデベレ語","lang_name":"isiNdebele","iso639-1":"nr","iso639-2T":"nbl","iso639-2B":"nbl","iso639-3":"nbl","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"オック語","lang_name":"occitan,lenga d'òc","iso639-1":"oc","iso639-2T":"oci","iso639-2B":"oci","iso639-3":"oci","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"アルゴンキン語族","wamei":"オジブウェー語","lang_name":"ᐊᓂᔑᓈᐯᒧᐎᓐ","iso639-1":"oj","iso639-2T":"oji","iso639-2B":"oji","iso639-3":"oji","iso639-6":"","note":"マクロランゲージ","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"古代教会スラヴ語、教会スラヴ語","lang_name":"словѣньскъ,ⰔⰎⰑⰂⰡⰐⰠⰔⰍⰟ","iso639-1":"cu","iso639-2T":"chu","iso639-2B":"chu","iso639-3":"chu","iso639-6":"","note":"古代言語","google_api":false},
//			{"lang_nation":"アフロ・アジア語族","wamei":"オロモ語","lang_name":"Afaan Oromoo","iso639-1":"om","iso639-2T":"orm","iso639-2B":"orm","iso639-3":"orm","iso639-6":"","note":"マクロランゲージ","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"オリヤー語","lang_name":"ଓଡ଼ିଆ","iso639-1":"or","iso639-2T":"ori","iso639-2B":"ori","iso639-3":"ori","iso639-6":"","note":"マクロランゲージ","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"オセット語","lang_name":"ирон æвзаг","iso639-1":"os","iso639-2T":"oss","iso639-2B":"oss","iso639-3":"oss","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"パンジャーブ語","lang_name":"ਪੰਜਾਬੀ,پنجابی‎","iso639-1":"pa","iso639-2T":"pan","iso639-2B":"pan","iso639-3":"pan","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"パーリ語","lang_name":"पालि","iso639-1":"pi","iso639-2T":"pli","iso639-2B":"pli","iso639-3":"pli","iso639-6":"","note":"古代言語","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ペルシア語","lang_name":"فارسی","iso639-1":"fa","iso639-2T":"fas","iso639-2B":"per","iso639-3":"fas","iso639-6":"","note":"マクロランゲージ","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ポーランド語","lang_name":"język polski,polszczyzna","iso639-1":"pl","iso639-2T":"pol","iso639-2B":"pol","iso639-3":"pol","iso639-6":"pols","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"パシュトー語","lang_name":"پښتو","iso639-1":"ps","iso639-2T":"pus","iso639-2B":"pus","iso639-3":"pus","iso639-6":"","note":"マクロランゲージ","google_api":true},
//			{"lang_nation":"ケチュア語族","wamei":"ケチュア語","lang_name":"runa simi,Qhichwa simi","iso639-1":"qu","iso639-2T":"que","iso639-2B":"que","iso639-3":"que","iso639-6":"","note":"マクロランゲージ","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ロマンシュ語","lang_name":"rumantsch","iso639-1":"rm","iso639-2T":"roh","iso639-2B":"roh","iso639-3":"roh","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"ルンディ語","lang_name":"Ikirundi","iso639-1":"rn","iso639-2T":"run","iso639-2B":"run","iso639-3":"run","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ルーマニア語、モルドバ語[1]","lang_name":"moldovenească","iso639-1":"ro","iso639-2T":"ron","iso639-2B":"rum","iso639-3":"ron","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ロシア語","lang_name":"русский язык","iso639-1":"ru","iso639-2T":"rus","iso639-2B":"rus","iso639-3":"rus","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"サンスクリット","lang_name":"संस्कृतम्","iso639-1":"sa","iso639-2T":"san","iso639-2B":"san","iso639-3":"san","iso639-6":"","note":"古代言語（但し現在も話者がいる）","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"サルデーニャ語","lang_name":"sardu","iso639-1":"sc","iso639-2T":"srd","iso639-2B":"srd","iso639-3":"srd","iso639-6":"","note":"マクロランゲージ","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"シンド語","lang_name":"सिन्धी,سنڌي‎","iso639-1":"sd","iso639-2T":"snd","iso639-2B":"snd","iso639-3":"snd","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"ウラル語族","wamei":"北部サーミ語","lang_name":"davvisámegiella","iso639-1":"se","iso639-2T":"sme","iso639-2B":"sme","iso639-3":"sme","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"オーストロネシア語族","wamei":"サモア語","lang_name":"Gagana fa'a Sāmoa","iso639-1":"sm","iso639-2T":"smo","iso639-2B":"smo","iso639-3":"smo","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"クレオール言語","wamei":"サンゴ語","lang_name":"sängö","iso639-1":"sg","iso639-2T":"sag","iso639-2B":"sag","iso639-3":"sag","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"セルビア語","lang_name":"српски језик,srpski jezik","iso639-1":"sr","iso639-2T":"srp","iso639-2B":"srp","iso639-3":"srp","iso639-6":"","note":"かつてはISO 639-2/Bコードに[scc]が使用されていた[2]。","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"スコットランド・ゲール語","lang_name":"Gàidhlig","iso639-1":"gd","iso639-2T":"gla","iso639-2B":"gla","iso639-3":"gla","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"ショナ語","lang_name":"chiShona","iso639-1":"sn","iso639-2T":"sna","iso639-2B":"sna","iso639-3":"sna","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"シンハラ語","lang_name":"සිංහල","iso639-1":"si","iso639-2T":"sin","iso639-2B":"sin","iso639-3":"sin","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"スロバキア語","lang_name":"slovenčina,slovenský jazyk","iso639-1":"sk","iso639-2T":"slk","iso639-2B":"slo","iso639-3":"slk","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"スロベニア語","lang_name":"slovenščina,slovenski jezik","iso639-1":"sl","iso639-2T":"slv","iso639-2B":"slv","iso639-3":"slv","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"アフロ・アジア語族","wamei":"ソマリ語","lang_name":"af Soomaali","iso639-1":"so","iso639-2T":"som","iso639-2B":"som","iso639-3":"som","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"ソト語","lang_name":"Sesotho","iso639-1":"st","iso639-2T":"sot","iso639-2B":"sot","iso639-3":"sot","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"オーストロネシア語族","wamei":"スンダ語","lang_name":"Basa Sunda","iso639-1":"su","iso639-2T":"sun","iso639-2B":"sun","iso639-3":"sun","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"スワヒリ語","lang_name":"Kiswahili","iso639-1":"sw","iso639-2T":"swa","iso639-2B":"swa","iso639-3":"swa","iso639-6":"","note":"マクロランゲージ","google_api":true},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"スワジ語","lang_name":"siSwati","iso639-1":"ss","iso639-2T":"ssw","iso639-2B":"ssw","iso639-3":"ssw","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"スウェーデン語","lang_name":"svenska","iso639-1":"sv","iso639-2T":"swe","iso639-2B":"swe","iso639-3":"swe","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"ドラヴィダ語族","wamei":"タミル語","lang_name":"தமிழ்","iso639-1":"ta","iso639-2T":"tam","iso639-2B":"tam","iso639-3":"tam","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"ドラヴィダ語族","wamei":"テルグ語","lang_name":"తెలుగు","iso639-1":"te","iso639-2T":"tel","iso639-2B":"tel","iso639-3":"tel","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"タジク語","lang_name":"тоҷикӣ,tojikī,تاجیکی‎","iso639-1":"tg","iso639-2T":"tgk","iso639-2B":"tgk","iso639-3":"tgk","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"タイ・カダイ語族","wamei":"タイ語","lang_name":"ภาษาไทย","iso639-1":"th","iso639-2T":"tha","iso639-2B":"tha","iso639-3":"tha","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"アフロ・アジア語族","wamei":"ティグリニャ語","lang_name":"ትግርኛ","iso639-1":"ti","iso639-2T":"tir","iso639-2B":"tir","iso639-3":"tir","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"シナ・チベット語族","wamei":"チベット語","lang_name":"བོད་ཡིག","iso639-1":"bo","iso639-2T":"bod","iso639-2B":"tib","iso639-3":"bod","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"テュルク語族","wamei":"トルクメン語","lang_name":"Türkmençe,Türkmen dili,Түркмен дили","iso639-1":"tk","iso639-2T":"tuk","iso639-2B":"tuk","iso639-3":"tuk","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"オーストロネシア語族","wamei":"タガログ語","lang_name":"Wikang Tagalog","iso639-1":"tl","iso639-2T":"tgl","iso639-2B":"tgl","iso639-3":"tgl","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"ツワナ語","lang_name":"Setswana","iso639-1":"tn","iso639-2T":"tsn","iso639-2B":"tsn","iso639-3":"tsn","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"オーストロネシア語族","wamei":"トンガ語","lang_name":"lea faka-Tonga","iso639-1":"to","iso639-2T":"ton","iso639-2B":"ton","iso639-3":"ton","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"テュルク語族","wamei":"トルコ語","lang_name":"Türkçe","iso639-1":"tr","iso639-2T":"tur","iso639-2B":"tur","iso639-3":"tur","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"ツォンガ語","lang_name":"Xitsonga","iso639-1":"ts","iso639-2T":"tso","iso639-2B":"tso","iso639-3":"tso","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"テュルク語族","wamei":"タタール語","lang_name":"татар теле,tatar tele,تاتار تيلی‎","iso639-1":"tt","iso639-2T":"tat","iso639-2B":"tat","iso639-3":"tat","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"トウィ語","lang_name":"Twi","iso639-1":"tw","iso639-2T":"twi","iso639-2B":"twi","iso639-3":"twi","iso639-6":" ","note":"","google_api":false},
//			{"lang_nation":"オーストロネシア語族","wamei":"タヒチ語","lang_name":"reo Tahiti","iso639-1":"ty","iso639-2T":"tah","iso639-2B":"tah","iso639-3":"tah","iso639-6":"","note":"レオ・マーオヒの1つ","google_api":false},
//			{"lang_nation":"テュルク語族","wamei":"ウイグル語","lang_name":"Uyghur tili,ئۇيغۇرچە‎","iso639-1":"ug","iso639-2T":"uig","iso639-2B":"uig","iso639-3":"uig","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ウクライナ語","lang_name":"українська мова","iso639-1":"uk","iso639-2T":"ukr","iso639-2B":"ukr","iso639-3":"ukr","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ウルドゥー語","lang_name":"اردو","iso639-1":"ur","iso639-2T":"urd","iso639-2B":"urd","iso639-3":"urd","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"テュルク語族","wamei":"ウズベク語","lang_name":"Oʻzbek tili,Ўзбек тили,ئۇزبېك تیلى‎","iso639-1":"uz","iso639-2T":"uzb","iso639-2B":"uzb","iso639-3":"uzb","iso639-6":"","note":"マクロランゲージ","google_api":true},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"ヴェンダ語","lang_name":"TshiVenḓa","iso639-1":"ve","iso639-2T":"ven","iso639-2B":"ven","iso639-3":"ven","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"オーストロアジア語族","wamei":"ベトナム語","lang_name":"Tiếng Việt","iso639-1":"vi","iso639-2T":"vie","iso639-2B":"vie","iso639-3":"vie","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"人工言語","wamei":"ヴォラピュク","lang_name":"Volapük","iso639-1":"vo","iso639-2T":"vol","iso639-2B":"vol","iso639-3":"vol","iso639-6":"","note":"ヨハン・シュライヤーが1879年に発表","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ワロン語","lang_name":"walon","iso639-1":"wa","iso639-2T":"wln","iso639-2B":"wln","iso639-3":"wln","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"ウェールズ語","lang_name":"Cymraeg","iso639-1":"cy","iso639-2T":"cym","iso639-2B":"wel","iso639-3":"cym","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"ウォロフ語","lang_name":"Wolof","iso639-1":"wo","iso639-2T":"wol","iso639-2B":"wol","iso639-3":"wol","iso639-6":"","note":"","google_api":false},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"西フリジア語","lang_name":"Frysk","iso639-1":"fy","iso639-2T":"fry","iso639-2B":"fry","iso639-3":"fry","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"コサ語","lang_name":"isiXhosa","iso639-1":"xh","iso639-2T":"xho","iso639-2B":"xho","iso639-3":"xho","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"インド・ヨーロッパ語族","wamei":"イディッシュ語","lang_name":"ייִדיש","iso639-1":"yi","iso639-2T":"yid","iso639-2B":"yid","iso639-3":"yid","iso639-6":"","note":"マクロランゲージ","google_api":true},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"ヨルバ語","lang_name":"èdè Yorùbá","iso639-1":"yo","iso639-2T":"yor","iso639-2B":"yor","iso639-3":"yor","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"タイ・カダイ語族","wamei":"チワン語","lang_name":"Vahcuengh","iso639-1":"za","iso639-2T":"zha","iso639-2B":"zha","iso639-3":"zha","iso639-6":"","note":"マクロランゲージ","google_api":false},
//			{"lang_nation":"ニジェール・コンゴ語族","wamei":"ズールー語","lang_name":"isiZulu","iso639-1":"zu","iso639-2T":"zul","iso639-2B":"zul","iso639-3":"zul","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"オーストロネシア語族","wamei":"セブアノ語","lang_name":"Sinugboanon","iso639-1":"ceb","iso639-2T":"ceb","iso639-2B":"ceb","iso639-3":"ceb","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"オーストロネシア語族","wamei":"ハワイ語","lang_name":"ʻŌlelo Hawaiʻi","iso639-1":"haw","iso639-2T":"haw","iso639-2B":"haw","iso639-3":"haw","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"ミャオ・ヤオ語族","wamei":"ミャオ語","lang_name":"Hmong","iso639-1":"hmn","iso639-2T":"hmn","iso639-2B":"hmn","iso639-3":"hmn","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"アフロ・アジア語族のセム語派","wamei":"ヘブライ語,iw","lang_name":"עברית, Ivrit","iso639-1":"iw","iso639-2T":"iw","iso639-2B":"iw","iso639-3":"iw","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"オーストロネシア語族","wamei":"ジャワ語","lang_name":"Basa Jawa、꧋ꦧꦱꦗꦮ","iso639-1":"jw","iso639-2T":"jav","iso639-2B":"jav","iso639-3":"jav","iso639-6":"","note":"","google_api":true},
//			{"lang_nation":"日本語族","wamei":"日本語","lang_name":"日本語","iso639-1":"ja","iso639-2T":"jpn","iso639-2B":"jpn","iso639-3":"jpn","iso639-6":"","note":"","google_api":true},

			];
		
		// google transrate apiに対応している言語のみにフィルタイングする。
		var langData2 = [];
		for(var i in langData){
			var ent = langData[i];
			if(ent.google_api == true){
				langData2.push(ent);
			}
		}
		return langData2;
	}
	
	
}
/**
 * 列表示切替クラス 
 * 
 * 初期化(init)を実行すると、対象HTMLテーブルの列から、列表示切替チェックボックスを自動生成します。
 * 列表示切替チェックボックスにチェックを入れると列の表示を切り替えられます。
 * 
 * ◇主なメソッド
 * - init 初期化
 * - refresh 一覧テーブルをリフレッシュする
 * 
 * @version 1.5
 * 
 * 
 * @author k-uehara 
 */
var ClmShowHide =function(){


	/// コールバック関数用
	var my=this;
	
	/// プロパティ
	this.props={};

	/// デフォルト列データ
	this.defClmData={};
	
	// アクティブ列データ
	this.actClmData={};
	
	
	/**
	 * 初期化
	 * @param tblId 対象テーブルのID属性
	 * @param chBoxsId 列表示切替チェックボックス群を出力する要素を指定
	 * @param iniClmData 初期列表示配列 例→iniClmData=[-1,1,0,0,0,1];// -1:機能無効  0:非表示  1:表示
	 * @param unique 画面毎に異なる一意なコード。省略時は引数tblIdを使用する。
	 *
	 */
	this.init=function(tblId,chBoxsId,iniClmData,unique){

		//引数をメンバのプロパティにセットする。
		this.props['tblId']=tblId;
		this.props['chBoxsId']=chBoxsId;
		this.props['unique']=unique;


		if(unique==null){
			unique=tblId;
		}
		
		// デフォルト列データを作成する
		var defClmData=[];
		for(var i=0;i < iniClmData.length ;i++){
			var show_flg=iniClmData[i];

			var clm_ent={'clm_name':null,'show_flg':show_flg};
			defClmData[i]=clm_ent;
			

		}
		
		
		// テーブルヘッダー要素から列名を取得して、デフォルト列データにセットする。
		var i=0;
		$.each($('#' + tblId + " thead tr th"), function() {

			var clm_name=$(this).html();
			try{
				defClmData[i]['clm_name']=clm_name;
			}catch( e ){
				return;
			}

			i++;
		});


		// ローカルストレージから列JSONを取得する
		var j_clmData=localStorage.getItem(unique + '_clmData');
		

		
		// ローカルストレージに列JSONが存在しない場合、デフォルトをアクティブ列データにコピーする
		var actClmData={};// アクティブ列データ
		if(j_clmData =='' || j_clmData==null){
			actClmData = $.extend(true, {}, defClmData);
		}
		
		// ローカルストレージに列JSONが存在する場合、列JSONをパースしてアクティブ列データにセットする
		else{
			actClmData=JSON.parse(j_clmData);
		}


		// メンバへ列データをセットする
		this.defClmData = defClmData;
		this.actClmData = actClmData;


		//列表示チェックボックスを作成
		createClmShowCheckBox_csh(tblId,chBoxsId,actClmData);


		//列表示チェックボックスのクリックイベント。
		$(".csh_cb").click(function(event){
			var checked=$(this).prop('checked');
			var index=$(this).attr('index');

			//列表示の切替処理
			if(checked==true){
				my.clm_show_csh(tblId,index);//列表示
			}else{
				my.clm_hide_csh(tblId,index);//列非表示
			}

		});


		//列表示切替
		for (var i in actClmData) {
			var clm_ent=actClmData[i];

			//表示フラグ＝0ならその列を非表示にする。
			if(clm_ent.show_flg==0){

				this.clm_hide_csh(tblId,i);//インデックスに紐づく列を非表示にする
			}

		}



		//保存ボタンにイベントを追加。
		$("#" + tblId + "_save_btn").click(function(event){

			//列の表示状態をローカルストレージに保存
			saveClmData(tblId,chBoxsId,unique);

		});

		//「すべてチェック」ボタンにイベントを追加。
		$("#" + tblId + "_all_checked_btn").click(function(event){

			//すべての列表示チェックボックスにチェックを入れる。
			allChecked(tblId,chBoxsId,my.actClmData);

		});

		//「初期に戻す」ボタンにイベントを追加。
		$("#" + tblId + "_default_btn").click(function(event){

			//列表示チェックボックスを初期状態に戻す。
			defaultClmCb(tblId,chBoxsId,unique);

		});


	};
	
	/**
	 * 列表示配列を取得
	 * 
	 * 列表示チェックボックスから列表示配列を取得する。
	 * @return 列表示配列
	 * 
	 */
	this.getCshAry = function(){
		
		// チェックボックス群要素のjQueyオブジェクトを取得する
		var chBox = $('#' + my.props.chBoxsId);
		
		

		var csh_ary=[];

		//列表示切替チェックボックス群から列データの表示フラグにセットする。
		for (var i in this.defClmData) {

			// チェックボックス要素を取得する
			var cb = chBox.find("[index=" + i + "]");
			if(cb[0]){
				var checked= cb.prop('checked');
	
				if(checked==true){
					csh_ary.push(1);
				}else{
					csh_ary.push(0);
				}
			}
		}
		
		return csh_ary;
	};
	
	/**
	 * 列表示切替情報を初期状態にリセットする
	 * 
	 * ローカルストレージ内の値もクリアする。
	 */
	this.reset=function(){
		
		//列表示チェックボックスを初期状態に戻す。
		defaultClmCb(this.props.tblId,this.props.chBoxsId,this.props.unique);

	};
	
	/**
	 * 一覧テーブルをリフレッシュする。
	 * 何らかの処理で崩れたテーブルを、現在の列表示状態に戻す。
	 */
	this.refresh=function(){
		
		var tblId = this.props.tblId;
		
		//一旦、列をすべて表示する
		for (var i in this.defClmData) {
			this.clm_show_csh(tblId,i);//列を表示
		}
		
		var clmData = getClmDataFromCheckbox();//列表示切替チェックボックス群から列データを取得する。
		
		for (var i in clmData) {
			
			var show_flg=clmData[i].show_flg;
			
			if(show_flg==1){
				this.clm_show_csh(tblId,i);//列表示
			}else if(show_flg==0){
				this.clm_hide_csh(tblId,i);//列非表示
			}

		}
		
		
	}
	


	/**
	 * 列表示チェックボックスを初期状態に戻す
	 */
	function defaultClmCb(tblId,chBoxsId,unique){
		
		// チェックボックス群要素のjQueyオブジェクトを取得する
		var chBox = $('#' + my.props.chBoxsId);
		
		for(var i in my.defClmData){

			
			var ent = my.defClmData[i]
			var show_flg = ent.show_flg;
			
			var cb = chBox.find("[index=" + i + "]");

			if(cb[0]){
				if(show_flg==1){
					cb.prop('checked',true);
					my.clm_show_csh(tblId,i);//列表示
				}else if(show_flg==0){
					cb.prop('checked',false);
					my.clm_hide_csh(tblId,i);//列非表示
				}
			}


		}

		//ローカルストレージの列データをクリア
		var storage = localStorage;
		storage.removeItem(unique + '_clmData');


	};


	/**
	 * すべての列表示チェックボックスにチェックを入れる
	 */
	function allChecked(tblId,chBoxsId,clmData){
		
		// チェックボックス群要素のjQueyオブジェクトを取得する
		var chBox = $('#' + my.props.chBoxsId);
		
		for (var i in clmData) {

			// チェックボックス要素を取得する
			var cb = chBox.find("[index=" + i + "]");

			if(cb[0]){
				var checked= cb.prop('checked');
	
				if(checked==false){
					cb.prop('checked',true);//列表示チェックボックスにチェックを入れる。
					my.clm_show_csh(tblId,i);//列を表示
				}
			}


		}

	};


	/**
	 * 列の表示状態をローカルストレージに保存
	 */
	function saveClmData(tblId,chBoxsId,unique){

		var clmData = getClmDataFromCheckbox(); //列表示切替チェックボックス群から列データを取得する。

		//ローカルストレージに列データを保存
		var j_clmData=JSON.stringify(clmData);
		localStorage.setItem(unique + '_clmData',j_clmData);

		$('#csh_msg').show();
		$('#csh_msg').fadeOut(3000);
	};




	/**
	 * チェックボックス群を生成する
	 * @param tblId テーブルのID属性
	 * @param chBoxsId チェックボックス群要素のID属性
	 * @param clmData 列データ
	 */
	function createClmShowCheckBox_csh(tblId,chBoxsId,clmData){
		var cbs=$("#" + chBoxsId);
		cbs.empty();
		for (var i in clmData) {
			
			var clm_ent=clmData[i];
			
			if(clm_ent.show_flg == -1){
				continue;
			}

			var checked='';
			if(clm_ent.show_flg==1){
				checked='checked'
			}

			var cb="<div class='csh_cb_div'><input type='checkbox' class='csh_cb' " + checked + " index='" + i + "' /><label>"  + clm_ent['clm_name'] + "</label></div>";

			cbs.append(cb);
		}

		cbs.append("<div style='clear:both'></div>");

		//列表示保存ボタンを作成
		var saveBtn="<div class='csh_func_btn'><input type='button' value='列表示を保存' id='" + tblId + "_save_btn' class='btn btn-primary btn-xs' /></div>";
		cbs.append(saveBtn);

		//すべてチェックボタンを作成
		var allCheckedBtn="<div class='csh_func_btn'><input type='button' value='すべてチェック' id='" + tblId + "_all_checked_btn' class='btn btn-primary btn-xs' /></div>";
		cbs.append(allCheckedBtn);

		//「初期に戻す」ボタンを作成
		var defaultBtn="<div class='csh_func_btn'><input type='button' value='初期に戻す' id='" + tblId + "_default_btn' class='btn btn-primary btn-xs' /></div>";
		cbs.append(defaultBtn);


		cbs.append("<div id='csh_msg' class='csh_func_btn' style='display:none;color:#de5246'>列の表示状態を記憶しました。</div>");

	};

	//列表示
	this.clm_show_csh=function(tblId,index){


		var th=$("#" + tblId + " thead tr th").eq(index);
		th.show();

		$.each($("#" + tblId + " tbody tr"), function() {

			var td=$(this).children();
			td.eq(index).show();

		});

	};



	//列非表示
	this.clm_hide_csh=function(tblId,index){
		var th=$("#" + tblId + " thead tr th").eq(index);
		th.hide();

		$.each($("#" + tblId + " tbody tr"), function() {

			var td=$(this).children();
			td.eq(index).hide();

		});
	};

	/**
	 * 列表示切替チェックボックス群から列データを取得する。
	 */
	function getClmDataFromCheckbox(){

		// チェックボックス群要素のjQueyオブジェクトを取得する
		var chBox = $('#' + my.props.chBoxsId);

		// アクティブ列データを取得する
		var clmData = my.actClmData;

		//列表示切替チェックボックス群から列データの表示フラグにセットする。
		for (var i in clmData) {

			// チェックボックス要素を取得する
			var cb = chBox.find("[index=" + i + "]");
			
			// チェック状態を取得し、列データにセットする
			if(cb[0]){
				var checked= cb.prop('checked');
	
				if(checked==true){
					clmData[i]['show_flg'] = 1;
				}else{
					clmData[i]['show_flg'] = 0;
				}
			}
		}
		
		return clmData;
		
		
	};

};













/**
 * CrudBase.js
 * 
 * @note
 * CRUDのベース。
 * デフォルトでは、削除、編集、新規追加するたびにAjax通信を行う仕様である。
 * 削除、編集、新規追加するたびに更新するのが重い場合、適用ボタンで一括適用するモードも備える。
 * 
 * 
 * 
 * 課題
 * td内部へのSetやGetは、先頭要素とtd直下にしか対応していない。
 * 複雑なtd内部にも対応するとなるとコールバックを検討しなければならない。
 * 
 * @date 2016-9-21 | 2019-1-25
 * @version 2.7.4
 * @histroy
 * 2018-10-21 v2.6.6 検索をGETクエリ方式にする
 * 2018-10-21 v2.6.0 フォームをアコーディオン形式にする。
 * 2018-10-9 v2.5.6 ノート詳細開き機能
 * 2018-10-9 v2.5.1 経由ディレクトリパスに対応
 * 2018-10-2 v2.5.0 フォームドラッグとリサイズ
 * 2018-9-19 v2.4.5 ファイルアップロード機能：DnDに対応
 * 2018-9-18 v2.4.4 フォームフィット機能を追加
 * v2.0 CrudBase.jsに名称変更、およびES6に対応（IE11は非対応）
 * v1.7 WordPressに対応
 * 2016-9-21 v1.0.0
 * 
 * @param object param
 *  - src_code	画面コード（スネーク記法）
 *  - src_code_c	画面コード（キャメル記法）
 *  - tbl_slt	CRUD対象テーブルセレクタ
 *  - edit_form_slt	編集フォームセレクタ
 *  - new_form_slt	新規フォームセレクタ
 *  - delete_form_slt	削除フォームセレクタ
 *  - contents_slt	コンテンツセレクタ	コンテンツ全体を表すセレクタでフォームの位置調整で利用する。省略時すると画面windowを基準に位置調整する。
 *  - edit_reg_url	編集登録サーバーURL
 *  - new_reg_url	新規登録サーバーURL
 *  - delete_reg_url	削除登録サーバーURL
 *  - auto_save_url	自動保存サーバーURL
 *  - form_position	フォーム位置 auto:自動, left:左側表示, center:中央表示, right:右側表示,max:横幅いっぱい
 *  - form_width	フォーム横幅	数値で指定。未指定（null)である場合、autoと同様になる。ただしform_positionがmaxなら横幅最大になる。
 *  - form_height	フォーム縦幅	上記と同じ
 *  - form_z_index	重なり順序(cssのz-indexと同じ)
 *  - valid_msg_slt	バリデーションメッセージセレクタ
 *  - auto_close_flg	自動閉フラグ	0:自動で閉じない（デフォルト）  1:フォームの外側をクリックすると自動的に閉じる
 *  - ni_tr_place	新規入力追加場所フラグ 0:末尾(デフォルト） , 1:先頭
 *  - drag_and_resize_flg フォームドラッグとリサイズのフラグ 0:OFF , 1:ON(デフォルト)
 *  - form_mode フォームモード 0:ダイアログモード , 1:アコーディオンモード(デフォルト）
 *  
 *  @param array fieldData フィールドデータ（フィールド名の配列。フィード名の順番は列並びと一致していること）
 */

class CrudBase{

	/**
	 * コンストラクタ
	 * 
	 * @param param
	 * - flg
	 */
	constructor(param,fieldData){

		// --- 初期化: CrudBaseBaseクラスのメンバを初期化する ----
		
		// パラメータに空プロパティがあれば、デフォルト値をセットする
		this.param = this._setParamIfEmpty(param);

		// フォーム情報の取得と初期化
		this.formInfo = this._initFormInfo(this.param);

		// フィールドデータにプロパティを追加する
		this.fieldData = this._addMoreFieldData(this.param.tbl_slt,this.fieldData);

		// フィールドデータへフォーム内の要素情報をセットする
		this.fieldData = this._setFieldDataFromForm(this.fieldData,this.formInfo,'new_inp');
		this.fieldData = this._setFieldDataFromForm(this.fieldData,this.formInfo,'edit');
		this.fieldData = this._setFieldDataFromForm(this.fieldData,this.formInfo,'delete');

		// フォーム要素オブジェクトを取得する
		var editForm = this.getForm('edit');
		var newInpForm = this.getForm('new_inp');
		
		// フィールドハッシュテーブルをフィールドデータから生成する。
		this.fieldHashTable = this._createFieldHashTable(this.fieldData);

		// デフォルト新規入力エンティティを新規入力フォームから取得する
		this.defNiEnt = this._getEntByForm('new_inp');
		
		// テーブルオブジェクト
		this.tbl = jQuery('#' + this.param.tbl_slt);
		
		// 自動保存機能・コンポーネント
		this.autoSave = this._factoryCrudBaseAutoSave(); 

		// 行入替機能・コンポーネント
		this.rowExchange = this._factoryCrudBaseRowExchange();

		// 列表示切替機能・コンポーネント
		this.csh = this._factoryClmShowHide(); 

		// CrudBase・ファイルアップロードコンポーネント
		this.cbFileUploadComp = this._factoryCbFileUploadComponent();
		
		// カレンダー日付ピッカー・ラッパーコンポーネント
		this.datepickerWrap = this._factoryDatepickerWrap();
		
		// ボタンサイズ変更コンポーネント
		this.cbBtnSizeChanger = this._factoryCbBtnSizeChanger();
		
		// カレンダービュー
		this.calendarViewK = this._factoryCalendarViewK();
		
		// CrudBase用リアクティブ機能
		this.crudBaseReact = this._factoryCrudBaseReact();
		
		// 一括追加機能
		this.crudBaseBulkAdd = new CrudBaseBulkAdd(this.fieldData);
		
		// パスワード編集機能
		this.crudBasePasswordEdit = new CrudBasePasswordEdit(newInpForm, editForm);
		
		// Google翻訳API・キャッシュ機能拡張
		this.cbGtaCash = new CbGtaCash({
			'slt':'#cb_gta_cash',
			'ajax_url':'cb_gta_cash',
		});
		
		this.fueIdCash; // file要素のid属性データ（キャッシュ）
		
		// テーブル変形
		if(this.param.device_type == 'sp') this.tableTransform(1);
		
		// フォームをドラッグ移動およびリサイズできるようにする。
		this._formDragAndResizeSetting();
		
		// エラータイプリストによるエラー処理
		this._errByErrTypes();

		this.actEditForm; // アクティブ編集フォームオブジェクト
		
		this.activeTr; // アクティブTR要素
		
		this.hiddensElm; // 埋込データ要素
		
		this.formKjsElm; // 検索条件フォーム要素
		
		
		// 初期戻しボタンにURLをセットする
		this._iniRtnSetUrl();
		
		// 検索関連の入力要素にEnterイベントを組み込む
		this._addEventForKjsEnter();
		
	}


	/**
	 * パラメータに空プロパティがあれば、デフォルト値をセットする
	 * @param object param パラメータ
	 */
	_setParamIfEmpty(param){

		if(param == null){
			param = {};
		}

		// 画面コード（スネーク記法）
		if(param['src_code'] == null){
			throw new Exception("'src_code' is empty!")
		}

		// 画面コード （キャメル）
		if(param['src_code_c'] == null){
			param['src_code_c'] = this._snakeToCamel(param.src_code);
		}
		
		// CRUD対象テーブルセレクタ
		if(param['tbl_slt'] == null){
			param['tbl_slt'] = param.src_code + '_tbl';
		}

		// 編集フォームセレクタ
		if(param['edit_form_slt'] == null){
			param['edit_form_slt'] = 'ajax_crud_edit_form';
		}

		// 新規フォームセレクタ
		if(param['new_form_slt'] == null){
			param['new_form_slt'] = 'ajax_crud_new_inp_form';
		}

		// 削除フォームセレクタ
		if(param['delete_form_slt'] == null){
			param['delete_form_slt'] = 'ajax_crud_delete_form';
		}

		// 抹消フォームセレクタ
		if(param['eliminate_form_slt'] == null){
			param['eliminate_form_slt'] = 'ajax_crud_eliminate_form';
		}

		// コンテンツセレクタ
		if(param['contents_slt'] == null){
			param['contents_slt'] = null;
		}

		// 編集登録サーバーURL
		if(param['edit_reg_url'] == null){
			param['edit_reg_url'] = param.src_code + '/ajax_reg';
		}

		// 新規登録サーバーURL
		if(param['new_reg_url'] == null){
			param['new_reg_url'] = param.src_code + '/ajax_reg';
		}

		// 削除登録サーバーURL
		if(param['delete_reg_url'] == null){
			param['delete_reg_url'] = param.src_code + '/ajax_delete';
		}

		// 自動保存サーバーURL
		if(param['auto_save_url'] == null){
			param['auto_save_url'] = param.src_code + '/auto_save';
		}

		// ファイルアップロードデータ
		if(param['file_uploads'] == null){
			param['file_uploads'] = null;
		}

		// フォーム横幅
		if(param['form_width'] == null){
			param['form_width'] = null; // nullはフォーム幅がauto
		}

		// フォーム縦幅
		if(param['form_height'] == null){
			param['form_height'] = null; // nullはフォーム幅がauto
		}

		// フォーム位置
		if(param['form_position'] == null){
			param['form_position'] = 'auto';
		}


		// フォームの前面深度(z-index)
		if(param['form_z_index'] == null){
			param['form_z_index'] = 9;
		}

		// バリデーションメッセージセレクタ
		if(param['valid_msg_slt'] == null){
			param['valid_msg_slt'] = '.err';
		}

		// 自動閉フラグ
		if(param['auto_close_flg'] == null){
			param['auto_close_flg'] = 0;
		}

		// 新規入力追加場所フラグ
		if(param['ni_tr_place'] == null){
			param['ni_tr_place'] = 0;
		}

		// 表示フィルターデータ
		if(param['disFilData'] == null){
			param['disFilData'] = null;
		}

		// 検索条件情報
		if(param['kjs'] == null){
			param['kjs'] = null;
		}

		// デバイスタイプ
		if(param['device_type'] == null){
			param['device_type'] = this.judgDeviceType(); // デバイスタイプ（PC/SP）の判定
		}

		// エラータイプリスト
		if(param['errTypes'] == null){
			var err_types_json = jQuery('#err_types_json').val();
			param['errTypes'] = jQuery.parseJSON(err_types_json);
		}
		
		
		if(param['drag_and_resize_flg'] == null) param['drag_and_resize_flg'] = 1;
		
		// フォームモード
		if(param['form_mode'] == null) param['form_mode'] = 1
		
		
		return param;
	}
	
	
	/**
	 * 自動保存機能・コンポーネントのファクトリーメソッド
	 * @return CrudBaseAutoSave 自動保存機能・コンポーネント
	 */
	_factoryCrudBaseAutoSave(){
		var autoSave;
		
		// クラス（JSファイル）がインポートされていない場合、「空」の実装をする。
		var t = typeof CrudBaseAutoSave;
		if(t == null || t == 'undefined'){
			// 「空」実装
			autoSave = {
					'saveRequest':function(){},
			}
			return autoSave
		}
		
		// 自動保存機能の初期化
		autoSave = new CrudBaseAutoSave(this);
		
		return autoSave;
		
	}
	
	
	/**
	 * 行入替機能・コンポーネントのファクトリーメソッド
	 * @reutrn CrudBaseRowExchange 行入替機能・コンポーネント
	 */
	_factoryCrudBaseRowExchange(){
		var rowExchange;
		
		// クラス（JSファイル）がインポートされていない場合、「空」の実装をする。
		var t = typeof CrudBaseRowExchange;
		if(t == null || t == 'undefined'){
			// 「空」実装
			rowExchange = {
					'showForm':function(){},
			}
			return rowExchange
		}
		
		// 行入替機能の初期化
		rowExchange = new CrudBaseRowExchange(this,null,()=>{
			this.rowExchangeAfter();
		});
		
		// 行入替機能のボタン表示切替
		var row_exc_flg = jQuery('#row_exc_flg').val();
		this.rowExcBtnShow(row_exc_flg);
		
		return rowExchange;
	}
	
	/**
	 * 列表示切替機能・コンポーネントのファクトリーメソッド
	 * @return ClmShowHide 列表示切替機能・コンポーネント
	 */
	_factoryClmShowHide(){
		
		var csh;
		
		// クラス（JSファイル）がインポートされていない場合、「空」の実装をする。
		var t = typeof ClmShowHide;
		if(t == null || t == 'undefined'){
			// 「空」実装
			csh = {}
			return csh
		}
		
		// 列表示切替機能の初期化
		csh=new ClmShowHide();//列表示切替
		var csh_json = jQuery('#csh_json').val();
		var iniClmData = JSON.parse(csh_json);//列表示配列  1:初期表示   0:初期非表示
		var csh_unique_key = 'rkt_' + this.param.src_code + '_index'; // 画面別ユニークキー
		csh.init(this.param.tbl_slt,'clm_cbs',iniClmData,csh_unique_key);
		return csh;
		
	}

	
	/**
	 * CrudBase・ファイルアップロードコンポーネントのファクトリーメソッド
	 * @return CbFileUploadComponent CrudBase・ファイルアップロードコンポーネント
	 */
	_factoryCbFileUploadComponent(){
		
		var cbFileUploadComp;
		
		// クラス（JSファイル）がインポートされていない場合、「空」の実装をする。
		var t = typeof CbFileUploadComponent;
		if(t == null || t == 'undefined'){
			// 「空」実装
			cbFileUploadComp = {
					'addEvent':function(){},
					'getFileParams':function(){},
					'uploadByAjax':function(){},
					'getFileNames':function(){},
					'setFilePaths':function(){},
			}
			return cbFileUploadComp;
		}
		
		// フォームからfile要素のid属性
		var nFuIds = this._getFueIds('new_inp');
		var eFuIds = this._getFueIds('edit');
		var fuIds = nFuIds.concat(eFuIds);// 配列結合
		
		// オプションに「ファイルプレビュー後コールバック」をセットする
		var option = {
				'pacb':this._fukPrevAfterCallback,
				'pacb_param':{'self':this},
				};
		
		cbFileUploadComp = new CbFileUploadComponent(fuIds,option);
		
		return cbFileUploadComp;
	}
	
	
	/**
	 * カレンダー日付ピッカー・ラッパーコンポーネントのファクトリーメソッド
	 * @return DatepickerWrap カレンダー日付ピッカー・ラッパーコンポーネント
	 */
	_factoryDatepickerWrap(){
		var datepickerWrap;
		
		// クラス（JSファイル）がインポートされていない場合、「空」の実装をする。
		var t = typeof DatepickerWrap;
		if(t == null || t == 'undefined'){
			// 「空」実装
			datepickerWrap = {
					'tukishomatu':function(){},
			}
			return datepickerWrap
		}
		
		// 自動保存機能の初期化
		datepickerWrap = new DatepickerWrap(this);
		
		return datepickerWrap;
		
	}
	
	
	/**
	 * ボタンサイズ変更コンポーネントのファクトリーメソッド
	 * @return CbBtnSizeChanger ボタンサイズ変更コンポーネント
	 */
	_factoryCbBtnSizeChanger(){
		var cbBtnSizeChanger;
		
		// クラス（JSファイル）がインポートされていない場合、「空」の実装をする。
		var t = typeof CbBtnSizeChanger;
		if(t == null || t == 'undefined'){
			// 「空」実装
			cbBtnSizeChanger = {
					'dummy':function(){},
			}
			return cbBtnSizeChanger
		}
		
		// 自動保存機能の初期化
		cbBtnSizeChanger = new CbBtnSizeChanger();
		
		return cbBtnSizeChanger;
		
	}
	
	
	/**
	 * カレンダービューのファクトリーメソッド
	 * @return CalendarViewK カレンダービュー
	 */
	_factoryCalendarViewK(){
		var calendarViewK;
		
		// クラス（JSファイル）がインポートされていない場合、「空」の実装をする。
		var t = typeof CalendarViewK;
		if(t == null || t == 'undefined'){
			// 「空」実装
			calendarViewK = {
					'create':function(){},
			}
			return calendarViewK
		}
		
		// 自動保存機能の初期化
		calendarViewK = new CalendarViewK();
		
		return calendarViewK;
		
	}
	
	
	/**
	 * CrudBase用リアクティブ機能のファクトリーメソッド
	 * @return CrudBaseReact CrudBase用リアクティブ機能
	 */
	_factoryCrudBaseReact(){
		var crudBaseReact;
		
		// クラス（JSファイル）がインポートされていない場合、「空」の実装をする。
		var t = typeof CrudBaseReact;
		if(t == null || t == 'undefined'){
			// 「空」実装
			crudBaseReact = {
					'init':function(){},
					'reactivatingOfRow':function(){},
			}
			return crudBaseReact
		}
		
		// 自動保存機能の初期化
		crudBaseReact = new CrudBaseReact();
		
		return crudBaseReact;
		
	}
	
	/**
	 * 新規入力フォームからfile要素のid属性
	 * @param string form_type フォーム種別
	 * @param object option
	 *  - cash_flg キャッシュフラグ 0:キャッシュから取得しない , 1 キャッシュから取得する（デフォルト）
	 * @return array fueIds:file要素のid属性リスト
	 */
	_getFueIds(form_type,option){
		
		if(option == null) option = {};
		if(option['cash_flg'] == null) option['cash_flg'] = 1;
		
		// キャッシュがあるならそれを返す。
		if(option['cash_flg'] == 1 && this.fueIdCash){
			if(this.fueIdCash[form_type] != null){
				return this.fueIdCash[form_type];
			}
		}
		
		var fuIds = []; // id属性リスト
		for(var i in this.fieldData){
			var fEnt = this.fieldData[i];
			var inp_key = 'inp_' + form_type;
			if(fEnt[inp_key] == null) continue;
			var inp = fEnt[inp_key];
			
			if(inp['type_name'] == null) continue;
			if(inp['type_name'] != 'file') continue;
			if(inp['elm'] == null) continue;
			
			var elm = inp['elm'];
			var xid = elm.attr('id');
			
			fuIds.push(xid);
		}
		
		// キャッシュとして保存する。
		if(this.fueIdCash == null) this.fueIdCash = {};
		this.fueIdCash[form_type] = fuIds;
		
		return fuIds;
	}
	


	/**
	 * 新規入力フォームを表示
	 * @param option オプション
	 * - ni_tr_place 新規行の追加場所 add_to_top:一覧の上に新規行を追加 , add_to_bottom:一覧の下に新規行を追加
	 * @param callBack フォームに一覧の行データを自動セットしたあとに呼び出されるコールバック関数(省略可）
	 */
	newInpShow(elm,option,callBack){
		
		if(option == null) option = {};
		
		// 新規行を上に追加するか、下に追加するかを決定する。
		if(option['ni_tr_place'] == 'add_to_top'){
			this.param.ni_tr_place = 1;
		}else if(option['ni_tr_place'] == 'add_to_bottom'){
			this.param.ni_tr_place = 0;
		}
		
		var info = this.formInfo['new_inp'];

		info.show_flg=1; // 表示制御フラグを表示中にする

		// デフォルト新規入力エンティティを新規入力フォームにセットする
		this.setFieldsToForm('new_inp',this.defNiEnt);

		var form = this.getForm('new_inp');// フォーム要素を取得

		// フォーム種別をフォーム内の指定入力要素へセット
		this.setValueToFrom(form,'form_type','new_inp');

		// バリデーションエラーメッセージをクリアする
		this._clearValidErr(form);

		// コールバックを実行する
		if(callBack){
			var c_param ={'form':form};
			callBack(c_param);
		}

		if(this.param.form_mode == 1){
			
			// フォームのcolspan属性に列数をセットする。
			form = this._setColspanToForm(form);
			

			// tdのcolspan属性に表示中の列数をセットする
			var td = form.find('td');
			
			// ▼ SPモードの場合はblock, PCモードの場合はtable系にする。
			if(this.param.device_type == 'sp'){
				td.attr('colspan', 1);
				td.css('display','block');
				form.css('display','block');
			}else{
				// 現在表示中の列数を取得する
				var clm_cnt = this._getClmCntByActive();
				td.attr('colspan', clm_cnt);
				td.css('display','table-cell');
				form.css('display','table-row');
			}
			
			// ▼ フォームの位置を指定場所に移動する
			if(option['ni_tr_place'] == 'add_to_top'){
				var firstTr = this.tbl.find('tbody tr').eq(0); // 一覧テーブルから先頭行を取得する
				form.insertBefore(firstTr); // 先頭行の上にフォームを表示する
				
			}else if(option['ni_tr_place'] == 'add_to_bottom'){
				var endTr = this.tbl.find('tbody tr').eq(-1); // 一覧テーブルから末尾行を取得する
				form.insertAfter(endTr); // 末尾行の下にフォームを表示する
			
			}else{			
				// 表示とついでにtrとtd要素をblockにする。
				td.css('display','block');
				form.css('display','block');
				form.insertAfter('#new_inp_form_point');
				
			}

		}else{
			// triggerElm要素の下付近に入力フォームを表示する。
			this._showForm(form,elm,option);
			
		}
		
		// パスワード編集機能
		this.crudBasePasswordEdit.showForm('new_inp');
		
	}


	/**
	 * 編集フォームを表示
	 * 
	 * @param elm 編集ボタン要素
	 * @param option オプション（省略可）
	 * @param callBack フォームに一覧の行データを自動セットしたあとに呼び出されるコールバック関数(省略可）
	 */
	editShow(elm,option,callBack){
		
		if(option == null) option = {};

		var tr = jQuery(elm).parents('tr'); // 先祖をさかのぼりtr要素を取得する

		this.activeTr = tr;; // アクティブTR要素にセット

		var info = this.formInfo['edit'];

		info.show_flg=1; // 表示制御フラグを表示中にする

		// TR要素からエンティティを取得する
		var ent = this.getEntityByTr(tr);

		// フォームに親要素内の各フィールド値をセットする。
		this.setFieldsToForm('edit',ent,option);
		
		// 編集フォーム要素を取得
		var form = this.getForm('edit');
		form.show();
		
		// バリデーションエラーメッセージをクリアする
		this._clearValidErr(form);

		// コールバックを実行する
		if(callBack){
			callBack(tr,form,ent);
		}

		
		if(this.param.form_mode == 1){
			
			// フォームのcolspan属性に列数をセットする。
			form = this._setColspanToForm(form);
			
			// TR要素の下に編集フォームを移動する
			form.insertAfter(tr);
		}
		else{
			// triggerElm要素の下付近に入力フォームを表示する。
			this._showForm(form,elm,option);			
		}

		// パスワード編集機能
		this.crudBasePasswordEdit.showForm('edit');

	}


	/**
	 * 複製による新規入力フォーム表示
	 * 
	 * @note
	 * 複製元のデータがあらかじめ入力された状態で新規入力フォームを表示する。
	 * 
	 * @param elm 複製ボタン要素
	 * @param option オプション（省略可）
	 *           -  upload_file_dirアップロードファイルディレクトリ
	 * @param callBack フォームに一覧の行データを自動セットしたあとに呼び出されるコールバック関数(省略可）
	 * 
	 */
	copyShow(elm,option,callBack){

		var tr=jQuery(elm).parents('tr'); // 先祖をさかのぼりtr要素を取得する
		this.activeTr = tr;; // アクティブTR要素にセット

		var info = this.formInfo['new_inp'];

		info.show_flg=1; // 表示制御フラグを表示中にする

		// TR要素からエンティティを取得する
		var ent = this.getEntityByTr(tr);

		var form = this.getForm('copy');

		// フォーム種別をフォーム内の指定入力要素へセット
		this.setValueToFrom(form,'form_type','copy');

		// 行番を取得し、要素にセットする
		var row_index = tr.index(); // 行番（インデックス）を取得する
		this.setValueToFrom(form,'row_index',row_index);

		// フォームにエンティティの値をセットする
		this.setFieldsToForm('new_inp',ent,option);

		// バリデーションエラーメッセージをクリアする
		this._clearValidErr(form);

		// コールバックを実行する
		if(callBack){
			callBack(tr,form,ent);
		}
		
		if(this.param.form_mode == 1){
			
			// フォームのcolspan属性に列数をセットする。
			form = this._setColspanToForm(form);
			

			// tdのcolspan属性に表示中の列数をセットする
			var td = form.find('td');
			
			// SPモードの場合はblock, PCモードの場合はtable系にする。
			if(this.param.device_type == 'sp'){
				td.attr('colspan', 1);
				td.css('display','block');
				form.css('display','block');
			}else{
				// 現在表示中の列数を取得する
				var clm_cnt = this._getClmCntByActive();
				td.attr('colspan', clm_cnt);
				td.css('display','table-cell');
				form.css('display','table-row');
			}
			
			form.insertAfter(tr);
			
		}else{
			// triggerElm要素の下付近に入力フォームを表示する。
			this._showForm(form,elm,option);
			
		}
		
		// パスワード編集機能
		this.crudBasePasswordEdit.showForm('copy');



	}


	/**
	 * 削除アクション
	 * @param elm 削除ボタン要素
	 * @param option
	 *  - upload_file_dirアップロードファイルディレクトリ
	 *  - form_show_flg 削除フォーム表示フラグ 0:削除フォームを表示しない（デフォ） , 1:表示する
	 *  - cbBeforeFormShow(tr,form,ent)   削除フォームを表示する前に実行するコールバック
	 *  - cbBeforeReg(ent) 削除登録前に実行するコールバック
	 *  - cbAfterReg(ent) 削除登録後に実行するコールバック
	 */
	deleteAction(elm,option){
		
		if(!(elm instanceof jQuery)) elm = jQuery(elm);

		if(option == null) option = {};
		if(option['form_show_flg'] == null) option['form_show_flg'] = 0;

		var tr = elm.parents('tr'); // 先祖をさかのぼりtr要素を取得する
		this.activeTr = tr;; // アクティブTR要素にセット

		// 削除フォーム表示フラグが1(表示）であるなら、削除フォームを表示する
		if(option['form_show_flg'] == 1){
			option['tr'] = tr;
			this.deleteShow(elm,option); // 削除フォーム表示
		}else{
			option['caller_type'] = 1; // 呼び出し元タイプ   1:直接呼出し
			this.deleteReg(option); // 削除登録
		}
	}


	/**
	 * 有効アクション
	 * @param elm 有効ボタン要素
	 * @param option
	 *  - cbBeforeReg(ent) 有効登録前に実行するコールバック
	 *  - cbAfterReg(ent) 有効登録後に実行するコールバック
	 */
	enabledAction(elm,option){
		
		if(!(elm instanceof jQuery)) elm = jQuery(elm);

		if(option == null) option = {};

		var tr = elm.parents('tr'); // 先祖をさかのぼりtr要素を取得する
		this.activeTr = tr;; // アクティブTR要素にセット

		this.enabledReg(option); // 有効登録
	}


	/**
	 * 抹消フォーム表示
	 * 
	 * @param elm 抹消ボタン要素
	 * @param option オプション（省略可）
	 *           -  upload_file_dirアップロードファイルディレクトリ
	 * @param callBack フォームに一覧の行データを自動セットしたあとに呼び出されるコールバック関数(省略可）
	 * 
	 */
	eliminateShow(elm,option,callBack){
		
		if(!(elm instanceof jQuery)) elm = jQuery(elm);
		var tr = elm.parents('tr'); // 先祖をさかのぼりtr要素を取得する
		this.activeTr = tr;; // アクティブTR要素にセット

		var info = this.formInfo['eliminate'];

		info.show_flg=1; // 表示制御フラグを表示中にする

		// TR要素からエンティティを取得する
		var ent = this.getEntityByTr(tr);

		var form = jQuery(info.slt);// 抹消フォーム要素を取得

		// フォームに親要素内の各フィールド値をセットする。
		this.setFieldsToForm('eliminate',ent,option);

		// コールバックを実行する
		if(callBack) callBack(tr,form,ent);

		// triggerElm要素の下付近に入力フォームを表示する。
		this._showForm(form,elm,option);

	}



	/**
	 * 新規入力登録
	 * @param beforeCallBack Ajax送信前のコールバック（送信データを編集できる）
	 * @param afterCallBack Ajax送信後のコールバック
	 * @param option オプション 
	 * - add_row_index 追加行インデックス :テーブル行の挿入場所。-1にすると末尾へ追加。-1がデフォルト。
	 * - wp_action WPアクション: WordPressでは必須
	 * - wp_nonce  WPノンス: WordPressのトークン的なもの（なくても動くがセキュリティが下がる）
	 */
	newInpReg(beforeCallBack,afterCallBack,option){

		var form = this.getForm('new_inp'); // 入力フォーム要素のオブジェクトを取得する

		// バリデーション
		var res = this._validationCheckForm('new_inp');
		if(res == false) return;

		if(this._empty(option)) option = {};

		// 登録ボタンを押せなくする
		this._toggleRegBtn('new_inp',0);
		
		// FDにファイルオブジェクトをセットする。
		var fd = new FormData();
		fd = this.cbFileUploadComp.setFilesToFd(fd,'new_inp');

		// 新規入力フォームからエンティティを取得およびJSON化し、FormDataにセットする
		var ent = this._getEntByForm('new_inp');

		// idに値がセットされ編集扱いとなっている場合、IDフラグをtrueにする。
		var id_flg = false;
		if(!this._empty(ent['id'])){
			id_flg = true;
		}

		// Ajax送信前のコールバックを実行する
		if(beforeCallBack){

			var bcRes = beforeCallBack(ent,fd);
			if(bcRes['err']){
				this._errShow(bcRes['err'],'new_inp');// エラーを表示
				return;
			}else if(bcRes['ent']){
				ent = bcRes['ent'];
				fd = bcRes['fd'];
			}else{
				ent = bcRes;
			}
		}

		var json = JSON.stringify(ent);//データをJSON文字列にする。
		fd.append( "key1", json );

		
		var regParam = {}; // 登録パラメータ
		
		// WordPressの場合
		if(option['wp_action']){
			regParam['action'] = option['wp_action'];
			if(option['wp_nonce']) regParam['nonce'] = option['wp_nonce'];
		}

		// 登録パラメータにセット
		var form_type = this.getValueFromForm(form,'form_type');// フォーム種別 (新規入力 or 複製)
		regParam['form_type'] = form_type;
		regParam['ni_tr_place'] = this.param.ni_tr_place;// 新規入力追加場所フラグ
	
		var reg_param_json = JSON.stringify(regParam);
		fd.append('reg_param_json',reg_param_json);

		// 諸パラメータから追加行インデックスを決定する
		var add_row_index = this._decAddRowIndex(form,form_type,option);


		jQuery.ajax({
			type: "post",
			url: this.param.new_reg_url,
			data: fd,
			cache: false,
			dataType: "text",
			processData: false,
			contentType : false,
		})
		.done((str_json, type) =>{
			this._toggleRegBtn('new_inp',1);// 登録ボタンを押せるようにする
			var ent;
			try{
				ent =jQuery.parseJSON(str_json);//パース

			}catch(e){
				alert('エラー');
				jQuery("#err").html(str_json);
				return;
			}

			if(ent['err']){

				// エラーをフォームに表示する
				this._showErrToForm(ent['err'],'new_inp');

			}else{

				// IDがセットされて、編集扱いとなっている場合はリロードする。
				if(id_flg==true){
					location.reload(true);
				}
				
				this.closeForm('new_inp');// フォームを閉じる

				// 新しい行を作成する
				var tr = this._addTr(ent,add_row_index);
				
				// ボタン群の表示切替
				this._switchBtnsDisplay(tr,ent)

				// 登録後にコールバック関数を非同期で実行する
				if(afterCallBack != null){
					window.setTimeout(()=>{
						afterCallBack(ent);
						}, 1);
				}


			}

		})
		.fail((jqXHR, statusText, errorThrown) =>{
			this._toggleRegBtn('new_inp',1);// 登録ボタンを押せるようにする
			jQuery('#err').html(jqXHR.responseText);//詳細エラーの出力
			alert(statusText);
		});

	}


	
	
	/**
	 * 編集登録
	 * @param beforeCallBack Ajax送信前のコールバック（送信データを編集できる）
	 * @param afterCallBack Ajax送信後のコールバック
	 * @param option オプション
	 * - wp_action :WPアクション	WordPressでは必須
	 * - wp_nonce  :WPノンス	WordPressのトークン的なもの（なくても動くがセキュリティが下がる）
	 * 
	 */
	editReg(beforeCallBack,afterCallBack,option){
		// バリデーション
		var res = this._validationCheckForm('edit');
		if(res == false) return;

		if(this._empty(option)) option = {};

		// 登録ボタンを押せなくする
		this._toggleRegBtn('edit',0);

		// 編集フォームからエンティティを取得する。
		var ent = this._getEntByForm('edit');
		
		// FDにファイルオブジェクトをセットする。
		var fd = new FormData();
		fd = this.cbFileUploadComp.setFilesToFd(fd,'edit');
		
		// Ajax送信前のコールバックを実行する
		if(beforeCallBack){

			var bcRes = beforeCallBack(ent,fd);
			if(bcRes['err']){
				this._errShow(bcRes['err'],'edit');// エラーを表示
				return;
			}else if(bcRes['ent']){
				ent = bcRes['ent'];
				fd = bcRes['fd'];
			}else{
				ent = bcRes;
			}
		}

		var regParam = {}; // 登録パラメータ
		
		var json = JSON.stringify(ent);//データをJSON文字列にする。
		fd.append( "key1", json );

		// WordPressの場合
		if(option['wp_action']){
			regParam['action'] = option['wp_action'];
			if(option['wp_nonce']) regParam['nonce'] = option['wp_nonce'];
		}

		// 登録パラメータにセット
		regParam['form_type'] = 'edit';
		
		var reg_param_json = JSON.stringify(regParam);
		fd.append('reg_param_json',reg_param_json);
		
		jQuery.ajax({
			type: "post",
			url: this.param.edit_reg_url,
			data: fd,
			cache: false,
			dataType: "text",
			processData: false,
			contentType: false,

		}).done((str_json, type) => {

			this._toggleRegBtn('edit',1);// 登録ボタンを押せるようにする
			
			var ent = null;
			try{
				var ent =jQuery.parseJSON(str_json);//パース

			}catch(e){
				alert('エラー:' + str_json);
				console.log(str_json);
				jQuery("#err").html(str_json);
			}

			// 編集中の行にエンティティを反映する。
			if(ent){
				if(ent['err']){

					// エラーをフォームに表示する
					this._showErrToForm(ent['err'],'edit');
					return;
				}

				// 編集中のTR要素を取得する
				var tr = this._getTrInEditing();
				
				// 削除フラグがONである場合、削除中の行を一覧から隠す
				if(this.param['kj_delete_flg'] == 0 && ent['delete_flg']==1){
					tr.hide();
				}

				// エンティティのIDとTR要素のIDが不一致である場合、ブラウザをリロードする
				if(ent['id'] !=tr.find('.id').text()){
					location.reload(true);
				}

				// TR要素にエンティティの値をセットする
				this._setEntityToEditTr(ent,tr);


				// 登録後にコールバック関数を非同期で実行する
				if(afterCallBack != null){
					window.setTimeout(()=>{
						afterCallBack(ent);
					}, 1);
				}

				// 編集後の行は青くする
				tr.css('background-color','#d7e6fd');
	
				this.closeForm('edit');// フォームを閉じる
			}

		}).fail((jqXHR, statusText, errorThrown) => {
			this._toggleRegBtn('edit',1);// 登録ボタンを押せるようにする
			jQuery('#err').html(jqXHR.responseText);//詳細エラーの出力
			alert(statusText);
		});
	}



	/**
	 * 行番号を指定して削除登録を行う。
	 * @param row_index 行番号
	 * @param option
	 *  - cbBeforeReg(ent) 削除登録前に実行するコールバック
	 *  - cbAfterReg(ent) 削除登録後に実行するコールバック
	 */
	deleteRegByRowIndex(row_index,option){

		// HTMLテーブルから行番を指定してエンティティを取得する
		var ent = this.getEntity(row_index);

		// 削除を実行
		var delete_flg = 1;
		this._deleteRegBase(ent,delete_flg,option)

	}



	/**
	 * 抹消登録
	 * 
	 * @param option オプション
	 *  - caller_type 呼び出し元タイプ 0:抹消フォールから呼び出し（デフォ） , 1:直接呼出し , 
	 *  - wp_action :WPアクション	WordPressでは必須
	 *  - wp_nonce  :WPノンス	WordPressのトークン的なもの（なくても動くがセキュリティが下がる）
	 *  - cbBeforeReg(ent) 抹消登録前に実行するコールバック
	 *  - cbAfterReg(ent) 抹消登録後に実行するコールバック
	 */
	eliminateReg (option){

		if(option == null) option = {};

		var ent = this._getEntByForm('eliminate');// 抹消フォームからエンティティを取得する
		option['eliminate_flg'] = 1; // 抹消フラグをONにする
		
		// 抹消を実行
		var delete_flg = 1;
		this._deleteRegBase(ent,delete_flg,option);

	}


	/**
	 * フォームを閉じる
	 * @parma string form_type new_inp:新規入力 edit:編集 delete:削除
	 */
	closeForm(form_type){

		// フォーム情報を取得
		var fi = this.formInfo[form_type];

		// フォームのオブジェクトを取得する
		var form = fi.form;
		
		jQuery('#crud_base_forms').append(form);

		// フォームを隠す
		form.hide();

	}
	
	
	/**
	 * 行入替機能のフォームを表示
	 * @param btnElm ボタン要素
	 */
	rowExchangeShowForm(btnElm){
		this.rowExchange.showForm(btnElm);
	}
	
	/**
	 * 行入替ボタンの表示切替
	 * @param int row_exc_flg 行入替機能フラグ 0:ボタン非表示 , 1:ボタン表示
	 */
	rowExcBtnShow(row_exc_flg){
		
		if(row_exc_flg == 1){
			jQuery('.row_exc_btn').show();
		}else{
			jQuery('.row_exc_btn').hide();
		}
	}
	
	
	/**
	 * 検索条件をリセット
	 * 
	 * すべての検索条件入力フォームの値をデフォルトに戻します。
	 * リセット対象外を指定することも可能です。
	 * @param array exempts リセット対象外フィールド配列（省略可）
	 */
	resetKjs(exempts){

		if(exempts==null) exempts=[];
		
		//デフォルト検索条件JSONを取得およびパースする。
		var def_kjs_json=$('#def_kjs_json').val();
		var defKjs=jQuery.parseJSON(def_kjs_json);
		
		for(var key in defKjs){
			
			//リセット対象外でなければ、検索条件入力フォームをリセットする。
			if(exempts.indexOf(key) < 0){
				$('#' + key).val(defKjs[key]);
			}
			
		}
		
		// 検索条件要素の各種ガシェットをリセットする
		this.cbGadgetKj.reset();
		
	}
	
	
	/**
	 * コンテナのGetter
	 * 
	 * @note コンテナには当クラスのメンバを格納している。
	 * 
	 * @return コンテナ
	 */
	getContainer(){
		var container = {
				'param':this.param , //  パラメータ
				'fieldData':this.fieldData , //  フィールドデータ
				'fieldHashTable':this.fieldHashTable , //  フィールドハッシュテーブル key:フィールド名  val:列インデックス
				'formInfo':this.formInfo , //  フォーム情報
				'defNiEnt':this.defNiEnt , //  デフォルト新規入力エンティティ
				'formNewInp':this.formNewInp , // 新規入力フォーム
				'formEdit':this.formEdit , // 編集フォーム
				'formDelete':this.formDelete , // 削除フォーム
				'showFormStrategy':this.showFormStrategy , //  入力フォーム表示ストラテジー
				'react':this.react , //  CrudBaseのリアクティブ機能クラス | CrudBaseReact.js
		}
		return container;
	}


	/**
	 * テーブルの行数を取得する
	 * 
	 * @note
	 * 入れ子のテーブルが存在していても正確に行数を数える。
	 * 
	 */
	getTblRowCount(){
		var tbl = jQuery('#' + this.param.tbl_slt);
		var tBody = tbl.children('tbody');
		var rowCnt = tBody.children('tr').length;
		return rowCnt;
	}



	/**
	 * 諸パラメータから追加行インデックスを決定する
	 * @param form フォーム要素
	 * @param form_type フォーム種別
	 * @param option
	 * @returns 追加行インデックス
	 */
	_decAddRowIndex(form,form_type,option){

		// オプション内の追加行インデックスがセット済みでならそれを返す。
		if(option['add_row_index'] != null){
			return option['add_row_index'];
		}

		var add_row_index = -1;// 末尾行への追加を表す
		if(this.param.ni_tr_place == 1){
			add_row_index = 0;// 先頭行への追加を表す
		}
		
		// フォーム種別が複製である場合、フォームから行番を取得してセットする。
		if(form_type == 'copy'){
			add_row_index = this.getValueFromForm(form,'row_index');
			add_row_index = add_row_index * 1;
			add_row_index++;
		}

		return add_row_index;

	}
	
	
	
	
	/**
	 * 削除フォーム表示
	 * 
	 * @param elm 削除ボタン要素
	 * @param option オプション（省略可）
	 *  - upload_file_dirアップロードファイルディレクトリ
	 *  - cbBeforeFormShow(tr,form,ent)   削除フォームを表示する前に実行するコールバック）
	 * 
	 */
	deleteShow(elm,option){
		
		if(!(elm instanceof jQuery)) elm = jQuery(elm);

		var tr = option['tr'];
		if(tr==null) tr=jQuery(elm).parents('tr'); // 先祖をさかのぼりtr要素を取得する
		
		var info = this.formInfo['delete'];

		info.show_flg=1; // 表示制御フラグを表示中にする

		// TR要素からエンティティを取得する
		var ent = this.getEntityByTr(tr);

		var form = jQuery(info.slt);// 削除フォーム要素を取得

		// フォームに親要素内の各フィールド値をセットする。
		this.setFieldsToForm('delete',ent,option);
		
		// コールバックを実行する
		var callback = option['cbBeforeFormShow'];
		if(callback) callback(tr,form,ent);

		// triggerElm要素の下付近に入力フォームを表示する。
		this._showForm(form,elm,option);

	}



	/**
	 * 削除登録
	 * 
	 * @param option オプション
	 *  - caller_type 呼び出し元タイプ 0:削除フォールから呼び出し（デフォ） , 1:直接呼出し , 
	 *  - wp_action :WPアクション	WordPressでは必須
	 *  - wp_nonce  :WPノンス	WordPressのトークン的なもの（なくても動くがセキュリティが下がる）
	 *  - cbBeforeReg(ent) 削除登録前に実行するコールバック
	 *  - cbAfterReg(ent) 削除登録後に実行するコールバック
	 */
	deleteReg (option){

		if(option == null) option = {};
		if(option['caller_type']==null) option['caller_type'] = 0;

		var ent;
		if(option['caller_type'] == 0){
			ent = this._getEntByForm('delete');// 削除フォームからエンティティを取得する
		}else{
			ent = this.getEntity();
		}

		// 削除を実行
		var delete_flg = 1;
		this._deleteRegBase(ent,delete_flg,option);

	}



	/**
	 * 有効登録
	 * 
	 * @param option オプション
	 *  - wp_action :WPアクション	WordPressでは必須
	 *  - wp_nonce  :WPノンス	WordPressのトークン的なもの（なくても動くがセキュリティが下がる）
	 *  - cbBeforeReg(ent) 有効登録前に実行するコールバック
	 *  - cbAfterReg(ent) 有効登録後に実行するコールバック
	 */
	enabledReg (option){

		if(option == null) option = {};
		var ent = this.getEntity();

		// 有効を実行
		var delete_flg = 0;
		this._deleteRegBase(ent,delete_flg,option);

	}
	
	
	

	/**
	 * 基本的な削除機能
	 * 
	 * @param ent idを含むエンティティ
	 * @param delete_flg 削除フラグ
	 * @param cbBeforeReg Ajax送信前(削除前）のコールバック（送信データを編集できる）
	 * @param afterCallBack 削除後に実行するコールバック関数（省略可）
	 * @param option オプション
	 * - cbBeforeReg Ajax通信前コールバック
	 * - cbAfterReg Ajax通信後のコールバック
	 * - wp_action :WPアクション	WordPressでは必須
	 * - wp_nonce  :WPノンス	WordPressのトークン的なもの（なくても動くがセキュリティが下がる）
	 * - eliminate_flg :抹消フラグ
	 * @returns void
	 */
	_deleteRegBase(ent, delete_flg, option){

		if(!ent['id']) throw new Error('Not id');
		
		// 抹消フラグ
		var eliminate_flg = 0;
		if(option['eliminate_flg']) eliminate_flg = option['eliminate_flg'];
		
		// フォーム種別を取得する
		var form_type = 'delete';
		if(eliminate_flg) form_type = 'eliminate';
		
		ent['delete_flg'] = delete_flg;
		if(option==null) option = {};
		
		// ファイルアップロード関連のエンティティをFormDataに追加する
		var fd = new FormData();
		

		// 登録パラメータに各種値をセット
		var regParam = {}; // 登録パラメータ
		regParam['form_type'] = form_type; // フォーム種別
		if(option['wp_action']){// WordPress関連
			regParam['action'] = option['wp_action'];
			if(option['wp_nonce']) regParam['nonce'] = option['wp_nonce'];
		}
		if(eliminate_flg) regParam['eliminate_flg'] = eliminate_flg; // 抹消フラグ
		var reg_param_json = JSON.stringify(regParam);
		fd.append('reg_param_json',reg_param_json);
		
		// Ajax送信前のコールバックを実行する
		var beforeCallBack = option['cbBeforeReg'];
		if(beforeCallBack){

			var bcRes = beforeCallBack(ent,fd);
			if(bcRes['err']){
				this._errShow(bcRes['err'],form_type);// エラーを表示
				return;
			}else if(bcRes['ent']){
				ent = bcRes['ent'];
				fd = bcRes['fd'];
			}else{
				ent = bcRes;
			}
		}

		var json = JSON.stringify(ent);//データをJSON文字列にする。
		fd.append( "key1", json );



		
		jQuery.ajax({
			type: "post",
			url: this.param.delete_reg_url,
			data: fd,
			cache: false,
			dataType: "text",
			processData: false,
			contentType: false,

		}).done((str_json, type) => {

			var ent;
			try{
				ent =jQuery.parseJSON(str_json);//パース

			}catch(e){
				alert('エラー');
				jQuery("#err").html(str_json);
			}

			if(!ent){return;}

			// 削除フラグが0(有効)である場合、HTMLテーブルの行を削除する
			if(this.param.kjs.kj_delete_flg === 0 || this.param.kjs.kj_delete_flg === '0' || eliminate_flg == 1){

				this.activeTr.remove(); // アクティブ行を削除
			}else{
				
				var tr = this._getTrInEditing();// 削除中の行要素を取得する
				this._setEntityToEditTr(ent,tr);// TR要素にエンティティの値をセットする
			}

			// 登録後にコールバック関数を非同期で実行する
			var afterCallBack = option['cbAfterReg'];
			if(afterCallBack){
				window.setTimeout(()=>{
					afterCallBack(ent);
					}, 1);
			}

			this.closeForm(form_type);// フォームを閉じる

		}).fail((jqXHR, statusText, errorThrown) => {
			jQuery('#err').html(jqXHR.responseText);//詳細エラーの出力
			alert(statusText);
		});

	}


	/**
	 * 行番を指定してTR要素を取得する
	 * @param row_index 行番 (-1を指定すると末尾を取得）
	 * @return TR要素
	 */
	getTr(row_index){
		
		if(row_index == null) return this.activeTr;
		
		var slt = '#' + this.param.tbl_slt + ' tbody tr';
		var tr = jQuery(slt).eq(row_index);

		return tr;
	}


	/**
	 * 末尾のTR要素を取得する
	 * @return TR要素
	 */
	getLastTr(){

		var slt = '#' + this.param.tbl_slt + ' tbody tr';
		var tr = jQuery(slt).eq(-1);

		return tr;
	}


	/**
	 * 現在編集中の行要素を取得する
	 * @return TR要素
	 */
	_getTrInEditing(){

		var tr = this.activeTr;

		return tr;
	}


	/**
	 * 行番とフィールド名からTD要素を取得する
	 * @param row_index 行番(-1で末行を指定）
	 * @param field フィールド名
	 * @return TD要素
	 */
	getTd(row_index,field){

		var tr = this.getTr(row_index); // 行番を指定してTR要素を取得する

		var elm = tr.find('.' + field);
		if(!elm[0]){
			return null;
		}

		var td = elm.parents('td');

		return td;

	}


	/**
	 * 現在編集中の行から、指定したフィールドに紐づくTD要素を取得する
	 * @param フィールド
	 * @return TD要素
	 */
	getTdInEditing(field){

		var tr = this._getTrInEditing(); // 現在編集中のTR要素を取得する

		var elm = tr.find('.' + field);
		if(!elm[0]){
			return null;
		}

		var td = elm.parents('td');

		return td;
	}


	/**
	 * 一覧テーブルの行番からエンティティを取得する
	 * @param row_index 行番(-1は末行) 省略時はアクティブTR要素を取得
	 * @return object エンティティ
	 */
	getEntity(row_index){

		// 行番を指定してTR要素を取得する
		var tr = this.getTr(row_index);

		// TR要素からエンティティを取得する
		var ent = this.getEntityByTr(tr);

		return ent;
	}


	/**
	 * TR要素からエンティティを取得する
	 * @param TR要素
	 * @return object エンティティ
	 */
	getEntityByTr(tr){

		var ent = {};
		for(var i in this.fieldData){
			var f = this.fieldData[i].field;
			var elm = tr.find("[name='" + f + "']");
			ent[f] = elm.val();
		}

		return ent;
	};


	/**
	 * 行中の任意要素を指定して、エンティティを取得する
	 * @param elm 行内（TD要素内部）の任意要素
	 * @return エンティティ
	 */
	getEntityByInnerElm(elm){

		// 先祖をさかのぼりtr要素を取得する
		var tr=jQuery(elm).parents('tr');

		// 行番（インデックス）を取得する
		var index = tr.index();

		// 一覧行から行番にひもづくエンティティを取得する
		var ent = this.getEntity(index);

		return ent;
	};

	/**
	 * Htmlテーブルからデータを取得する
	 * 
	 * @note
	 * 旧メソッド名:getDataHTbl
	 * 
	 * @param tbl HTMLテーブル要素(省略可)
	 * @return object データ
	 */
	getDataFromTbl(tbl){
		
		if(tbl == null){
			tbl = this.tbl;
		}
		if(!(tbl instanceof jQuery)){
			tbl = jQuery(tbl);
		}
		var trs = tbl.find('tbody tr');
		var data = [];

		// テーブルの行をループする
		trs.each((i,elm) => {
			var tr = jQuery(elm);
			
			// TR要素からエンティティを取得する
			var ent = this.getEntityByTr(tr);

			data.push(ent);
		});

		return data;
	};

	/**
	 * フィールドリストを指定して、Htmlテーブルからデータを取得する
	 * @return object データ
	 */
	getDataFromTblByFields(fields){

		var slt = '#' + this.param.tbl_slt + ' tbody tr';

		var data = [];

		// テーブルの行をループする
		jQuery(slt).each((i,elm)=>{
			var tr = jQuery(elm);

			// TR要素からフィールド名を検索し、値を取得する
			var ent = {};
			for(var i in fields){
				var f = fields[i];
				var elm = tr.find('.' + f);
				ent[f] = this._getValueEx(elm);

			}

			data.push(ent);
		});

		return data;
	};

	/**
	 * タグ種類を問わずに要素から値を取得する
	 * @param elm 要素
	 * @returns 要素の値
	 */
	_getValueEx(elm){
		var tagName = elm.prop("tagName"); 

		if(tagName == 'INPUT' || tagName == 'SELECT' || tagName=='TEXTAREA'){
			return elm.val();
		}else{
			return elm.html();
		}
	}

	/**
	 * フォーム内のフィールドで指定した入力要素から、値を取得する。
	 * @param form フォーム要素
	 * @param field フィールド： 入力要素のフィールド名(name属性名あるいはclass属性名）
	 * @returns フィールドで指定した入力要素からの値。
	 *  - 入力要素が存在しない場合はnullを返す
	 */
	getValueFromForm(form,field){

		var inpElm = this._formFind(form,field); // 入力要素を取得
		var v = null;
		if(inpElm[0]){
			v = this._getValueEx(inpElm); // 入力要素から値を取得
		}

		return v;
	}


	/**
	 * フォーム内のフィールドで指定した入力要素へ値をセットする。
	 * @param form フォーム要素
	 * @param field フィールド： 入力要素のフィールド名(name属性名あるいはclass属性名）
	 * @param value セットする値
	 */
	setValueToFrom(form,field,value){
		var inpElm = this._formFind(form,field); // 入力要素を取得
		if(inpElm[0]){
			this._setValueEx(inpElm,value); // 要素の種類を問わずに値をセットする
		}
	}



	/**
	 * エラーをフォームに表示する
	 * @param err エラー情報
	 * @param form_type フォーム種別 new_inp:新規入力 edit:編集
	 * 
	 */
	_showErrToForm(err,form_type){

		// エラー情報が配列であれば、値を改行で連結して１つのエラーメッセージにする。
		var err1 = err;
		if(Array.isArray(err1)){
			err1 = err1.join('<br>');
		}

		// フォーム種別からフォーム要素を取得
		var info = this.formInfo[form_type];
		var form = jQuery(info.slt);

		// フォーム要素からエラー要素を取得
		var errElm = form.find('.err');

		// エラー要素にエラーメッセージを埋め込む。
		errElm.html(err1);
	}


	/**
	 * バリデーションエラーメッセージをクリアする
	 * @param form_type フォーム種別 new_inp:新規入力 edit:編集
	 */
	_clearValidErr(form){

		var errElm = form.find(this.param.valid_msg_slt);
		errElm.html("");

		for(var i in this.fieldData){
			var field = this.fieldData[i]['field'];
			var label = form.find("[for='" + field + "']");
			if(label[0]){
				label.html("");
				label.hide();
			}
		}
	}


	/**
	 * フォームのバリデーション
	 * @param form_type フォーム種別 new_inp:新規入力 edit:編集
	 * @return validFlg バリデーションフラグ true:正常 false:入力エラー
	 */
	_validationCheckForm(form_type){

		var validFlg = true; // バリデーションフラグ

		// フォーム種別からフォーム要素を取得
		var info = this.formInfo[form_type];
		var form = jQuery(info.slt);

		form.find('.valid').each((i,elm)=>{
			var elm = jQuery(elm);
			var field = this._getFieldByNameOrClass(elm);

			// 入力要素単位でバリデーションを行う
			var res = this._validationCheck(elm,field);

			if(res == false){
				validFlg = false;
			}

		});

		return validFlg;
	};


	/**
	 * 入力要素単位でバリデーションを行う
	 * @param elm 入力要素
	 * @param field 入力要素のフィールド名
	 * @return validFlg バリデーションフラグ true:正常 false:入力エラー
	 */
	_validationCheck(elm,field){

		var validFlg = true; // バリデーションフラグ

		var label = jQuery("[for='" + field + "']");
		var title = elm.attr('title');

		try{
			validFlg=elm[0].checkValidity();

			if(validFlg == true){
				label.attr('class','text-success');
				label.html('');
			}else{
				label.attr('class','text-danger');
				label.html(title);
				label.show();
			}

		}catch( e ){

			throw e;
		}

		return validFlg;
	}


	// ファイルアップロード要素のクリア
	_resetFileUpload(fuEnt){
		fuEnt.evt = null;
		var fileElm = fuEnt.elm;
		try {
			fileElm.val("");
		} catch (e) {
			console.log('It can not be reset in IE ');
		}

		// Reset a thubnail preview.
		var imgElm = jQuery('#' + fuEnt.preview_slt);
		imgElm.attr('src','');
		imgElm.hide();

		return fuEnt;
	}
	
	/**
	 * 新しい行を作成する。 | 外部公開用のメソッド
	 * @param ent 行エンティティ
	 * @param add_row_index 追加行インデックス :テーブル行の挿入場所。-1にすると末尾へ追加。-1がデフォルト。
	 * @param option 拡張予定
	 * @return jQuery_Object 新行要素
	 */
	addTr(ent,add_row_index,option){
		this._addTr(ent,add_row_index,option)
	}


	/**
	 * 新しい行を作成する
	 * @param ent 行エンティティ
	 * @param add_row_index 追加行インデックス :テーブル行の挿入場所。-1にすると末尾へ追加。-1がデフォルト。
	 * @param option 拡張予定
	 * @return jQuery_Object 新行要素
	 */
	_addTr(ent,add_row_index,option){

		if(add_row_index == null) add_row_index = -1;
		add_row_index *= 1; // 数値型に変換する。
		
		if(!option) option = {};

		// テーブルのtbody要素を取得する
		var tbl_slt = '#' + this.param.tbl_slt;
		var trs = jQuery(tbl_slt + ' tbody tr'); // TR群要素

		// 先頭行が空ならブラウザリロードを行う。
		if(trs.length == 0){
			location.reload(true);
		}
		
		var tr0 = trs.eq(0);// 先頭行を取得

		// 先頭行から新行を作成する
		var new_tr_html = "<tr style='background-color:#fdeaea'>" + tr0.html() + "</tr>";

		// TR要素をテーブルの指定行に挿入する
		var newTr = this._insertTr(tbl_slt,add_row_index,new_tr_html);

		// 新行要素にエンティティをセットする
		option['form_type'] = 'new_inp';
		this.setEntityToTr(newTr,ent,option);
		
		return newTr;

	}

	
	/**
	 * TR要素をテーブルの指定行に挿入する
	 * @note
	 * tbodyは必須
	 * 
	 * @param string tbl_slt テーブル要素のセレクタ
	 * @param int row_index 挿入行インデックス (1行目に挿入する場合は0を指定する。末尾に追加する場合は行数以上の数字を指定）
	 * @param string tr_html 挿入TR要素
	 * @returns 新規追加TR要素
	 */
	_insertTr(tbl_slt,row_index,tr_html){
		var tbody = jQuery(tbl_slt + " tbody");
		var trs = tbody.find("tr");
		var tr_len = trs.length;
		var new_index = null;
	
		// 行数が1件以上である場合
		if(tr_len > 0){
			
			// 追加行番が行数未満である場合
			if(row_index < tr_len && row_index > -1){
				// 行番にひもづくTR要素を取得
				var tr = trs[row_index];
				
				// TR要素の上に新TR要素を追加
				jQuery(tr).before(tr_html);// × → tr.before(tr_html);
				new_index = row_index;
			}
			// 追加行番が行数以上である場合
			else{
				// 最後のTR要素を取得
				var tr = trs[tr_len-1];
				
				// TR要素の下に新TR要素を追加する
				jQuery(tr).after(tr_html);
				new_index = tr_len;
			}
		}
		// 行数が0件である場合,tbody要素にtr要素を追加する。
		else{
			tbody.append(tr_html);
			new_index = 0;
		}
		
		trs = tbody.find("tr");
		var newTr = trs[new_index];
		
		return jQuery(newTr); 
	}


	/**
	 * 編集中の行にエンティティを反映する。
	 * @param ent 行エンティティ
	 * @param <jQuery object> tr 編集中の行要素
	 * @param option 拡張予定
	 */
	_setEntityToEditTr(ent,tr,option){

		if(ent==null) return;
		if(!option) option = {};

		// 現在編集中の行要素を取得する
		if(tr==null){
			var tr = this._getTrInEditing();
		}

		// TR要素にエンティティをセットする
		option['form_type'] = 'edit';
		this.setEntityToTr(tr,ent,option);
		
		// ボタン群の表示切替
		this._switchBtnsDisplay(tr,ent);

	};
	
	/**
	 * ボタン群の表示切替
	 * @param tr 行要素
	 * @param ent 行エンティティ
	 */
	_switchBtnsDisplay(tr,ent){
		// 削除状態のボタン表示切替
		if(ent['delete_flg'] == 1){
			this._switchBtnDisp(tr,'.row_delete_btn',0);
			this._switchBtnDisp(tr,'.row_enabled_btn',1);
			this._switchBtnDisp(tr,'.row_eliminate_btn',1);
		}
		
		// 有効状態のボタン表示切替
		else{
			this._switchBtnDisp(tr,'.row_delete_btn',1);
			this._switchBtnDisp(tr,'.row_enabled_btn',0);
			this._switchBtnDisp(tr,'.row_eliminate_btn',0);
		}
	}
	
	/**
	 * ボタン表示切替
	 * @param jQuery_Object tr 行要素
	 * @param string btn_slt ボタン要素セレクタ
	 * @param int show_flg 表示フラグ    0:非表示 , 1:表示
	 */
	_switchBtnDisp(tr,btn_slt,show_flg){
		var btn = tr.find(btn_slt);
		if(!btn[0]) return;
		
		if(show_flg){
			btn.show();
		}else{
			btn.hide();
		}
	}
	
	
	
	/**
	 * テーブル要素にデータをセットする
	 * 
	 * @note
	 * 少々、重い処理なので注意。
	 * 
	 * @param tbl テーブル要素（省略可）
	 * @param data セットするデータ
	 * @param option
	 *  - form_type フォーム種別 new_inp,edit,del
	 * 
	 */
	setDataToTbl(tbl,data,option){
		
		if(tbl == null) tbl = this.tbl;
		
		var trs = tbl.find('tbody tr');
		trs.each((i,tr)=>{

			if(data[i] == null) return; // 次のループへ
			tr = jQuery(tr);
			var ent = data[i];
			this.setEntityToTr(tr,ent,option); // TR要素にエンティティをセットする
		});
	}


	/**
	 * TR要素にエンティティをセットする
	 * @param tr TR要素オブジェクト
	 * @param ent エンティティ
	 * @param option
	 *  - form_type フォーム種別 new_inp,edit,del
	 *  - xss_flg XSSサニタイズフラグ 0:実行しない , 1:実行する(デフォ）
	 */
	setEntityToTr(tr,ent,option){

		if(ent==null) return;
		if(option == null) option = {};
		
		// XSSサニタイズ
		var xss_flg = 1;
		if(option['xss_flg'] != null) xss_flg = option['xss_flg'];
		
		if(xss_flg == 1){
			ent = this._xssSanitaizeEncode(ent);
		}
		
		
		this.entToBinds(tr,ent,'class',option);// エンティティをclass属性バインド要素群へセットする
		this.entToBinds(tr,ent,'name',option);// エンティティをname属性バインド要素群へセットする

	}

	_nl2brEx(v){
		if(v == null || v == '' || v=='0'){
			return v;
		}

		if (typeof v != 'string'){
			return v;
		}

		v = v.replace(/\r\n|\n\r|\r|\n/g,'<br>');
		return v;
	}


	/**
	 * フォームからエンティティを取得する
	 * @param string form_type フォーム種別  edit,new_inp,delete
	 * @return エンティティ
	 */
	_getEntByForm(form_type){

		// 現在編集中の行要素を取得する
		var tr = this._getTrInEditing();

		// TR要素からエンティティを取得する
		var ent = {};

		// フォーム要素を取得する
		var form = this.getForm(form_type);

		if(form_type=='edit' || form_type=='delete'){
			ent = this.getEntityByTr(tr);
		}

		// フォームからエンティティを取得
		var ent2 = {};
		for(var i in this.fieldData){

			// フィールドデータからフィールド名を取得する
			var f = this.fieldData[i].field;

			// name属性またはclass属性を指定して入力要素を取得する。
			var inps = this._formFind(form,f);

			// 該当する入力要素の件数を取得する
			var cnt=inps.length;

			var v = null;// 取得値

			// 0件である場合、該当する入力要素は存在しないため、何もせず次へ。
			if(cnt==0){
				continue;
			}
			// 入力要素が1件である場合、その要素から値を取得する。
			else if(cnt==1){

				v = this._getEntByForm2(inps,form,f);
			}
			// 入力要素が2件以上である場合、最初の1件のみ取得
			else{
				inps.each((i,elm)=>{
					var inp = jQuery(elm);
					v = this._getEntByForm2(inp,form,f);
					return;
				});
			}
			

			

			
			ent2[f] = v;
		}

		jQuery.extend(ent, ent2);

		return ent;
	}

	/**
	 * フォーム要素を取得する
	 * @param form_type フォーム種別
	 * @param cache キャッシュフラグ 0:キャッシュから取得しない , 1:キャッシュがあればそこから取得(デフォルト）
	 * @returns フォーム要素
	 */
	getForm(form_type,cache){

		if(cache == null) cache = 1;

		var form;
		if(form_type=='new_inp' || form_type=='copy'){
			if(cache == 1){
				if(this.formNewInp != null){
					form = this.formNewInp;
				}else{
					form = jQuery('#' + this.param.new_form_slt);
				}
			}else{
				form = jQuery('#' + this.param.new_form_slt);
			}
			this.formNewInp = form;

		}else if(form_type=='edit'){

			if(cache == 1){
				if(this.formEdit != null){
					form = this.formEdit;
				}else{
					form = jQuery('#' + this.param.edit_form_slt);
				}
			}else{
				form = jQuery('#' + this.param.edit_form_slt);
			}
			this.formEdit = form;
			
			

		}else if(form_type=='delete'){

			if(cache == 1){
				if(this.formDelete != null){
					form = this.formDelete;
				}else{
					form = jQuery('#' + this.param.delete_form_slt);
				}
			}else{
				form = jQuery('#' + this.param.delete_form_slt);
			}
			this.formDelete = form;

		}else if(form_type=='eliminate'){

			if(cache == 1){
				if(this.formEliminate != null){
					form = this.formEliminate;
				}else{
					form = jQuery('#' + this.param.eliminate_form_slt);
				}
			}else{
				form = jQuery('#' + this.param.eliminate_form_slt);
			}
			this.formEliminate = form;

		}else{
			throw new Error('Uknown form_type!');
		}

		return form;
	}


	/**
	 * 様々な入力要素から値を取得する
	 * @param inp 入力要素<jquery object>
	 * @param form フォーム要素<jquery object>
	 * @param f フィールド名
	 * @return 入力要素の値
	 */
	_getEntByForm2(inp,form,f){

		var tagName = inp.get(0).tagName; // 入力要素のタグ名を取得する
		
		// 入力拡張コードを取得する
		var inp_ex = inp.attr('data-inp-ex');
		
		if(inp_ex){
			switch(inp_ex){
				case 'image1': // 画像1型
					return inp.attr('data-fp');
				case 'image_fuk': // 画像1型
					return inp.attr('data-fp');
			}
		}

		// 値を取得する
		var v = null;
		if(tagName == 'INPUT' || tagName == 'SELECT' || tagName == 'TEXTAREA'){

			// type属性を取得する
			var typ = inp.attr('type');

			if(typ=='file'){

				var fue_id = inp.attr('id');
				if(this.cbFileUploadComp){
					// file要素のidを指定してファイル名を取得する。
					var fns = this.cbFileUploadComp.getFileNames(fue_id);
					if(fns[0] != null) v = fns[0];
				}
				
			}

			else if(typ=='checkbox'){
				v = 0;
				if(inp.prop('checked')){
					v = 1;
				}
			}

			else if(typ=='radio'){
				var opElm = form.find("[name='" + f + "']:checked");
				v = 0;
				if(opElm[0]){
					v = opElm.val();
				}
			}

			else{
				v = inp.val();
			}
		}

		// IMGタグへのセット
		else if(tagName == 'IMG'){

			//IMG系である場合、ひもづいているlabel要素から値を取得する。
			v = this._getValFromLabel(form,f);

		}

		else{
			v = inp.html();
		}

		return v;
	}




	/**
	 * フィールドを指定してlabel要素から値を取得する
	 * @param form フォーム要素オブジェクト
	 * @param field フィールド名
	 * @return labelから取得した値
	 */
	_getValFromLabel(form,field){
		var v = null;
		var label = form.find("[for='" + field + "']");
		if(label[0]){
			v = label.html();
		}

		return v;
	}

	/**
	 * name属性またはclass属性でフォーム内を探し、入力要素を取得する
	 * @param form	フォーム要素オブジェクト
	 * @param string フィールド名（name属性またはclass属性でもある）
	 * @return jquery_object 入力要素
	 */
	_formFind(form,feild){

		var inp = form.find("[name='" + feild + "']");
		if(inp[0]==null){
			inp = form.find('.' + feild);
		}

		return inp;
	}


	/**
	 * 入力フォームをダイアログ化する
	 * @param formInfo フォーム情報
	 * @param form_z_index 深度 
	 * @returns
	 */
	_convertFormToDlg(formInfo,form_z_index){
		var param = this.param;

		if(form_z_index==null){
			form_z_index = param.form_z_index
		}

		// フォームのオブジェクトを取得する
		var form = formInfo.form;

		//デフォルトCSSデータ
		var cssData = {
			'z-index':form_z_index,
			'position':'absolute',

		}

		// フォームにCSSデータをセットする
		form.css(cssData);

		//ツールチップの外をクリックするとツールチップを閉じる
		if(this.param.auto_close_flg==1){
			jQuery(document).click(
					 ()=>{

						// フォーム表示ボタンが押されたときは、フォームを閉じないようにする。（このイベントはフォームボタンを押した時にも発動するため）
						if(formInfo.show_flg==1){
							formInfo.show_flg=0;
						}else{
							jQuery(formInfo.slt).hide();
						}

					});

			//領域外クリックでツールチップを閉じるが、ツールチップ自体は領域内と判定させ閉じないようにする。
			form.click((e) => {
				e.stopPropagation();
			});
		}

		form.hide();//フォームを隠す

	}
	
	
	/**
	 * デバイスタイプ（PC/SP）の判定
	 * @return string デバイスタイプ pc,sp
	 */
	judgDeviceType(){
		var device = 'pc';
		if (screen.width <= 480) {
			device = 'sp';
		}
		return device;
	}
	


	/**
	 * フィールドデータへ新規入力フォーム内の要素情報をセットする
	 * @param fieldData フィールドデータ
	 * @param formInfo フォーム情報
	 * @param form_type フォームタイプ new_inp,edit
	 * @return フィールドデータ
	 */
	_setFieldDataFromForm(fieldData,formInfo,form_type){

		// フォーム要素オブジェクトを取得する
		var info = formInfo[form_type];
		var form = info.form;

		for(var i in fieldData){

			// エンティティからフィールドを取得する
			var ent = fieldData[i];
			var f = ent.field;

			// 入力要素エンティティ
			var inp_ent = {
					'elm':null,
					'tag_name':null,
					'type_name':null,
					'accept':'',
			};

			// name属性またはclass属性を指定して入力要素を取得する。
			var inp = this._formFind(form,f);
			inp_ent['elm'] = inp;

			// 入力要素が取得できなければcontinueする。
			if(inp[0]==null){
				continue;
			}

			var tag_name = inp.get(0).tagName; // 入力要素のタグ名を取得する
			inp_ent['tag_name'] = tag_name;

			// 値を取得する
			var v = null;
			if(tag_name == 'INPUT' || tag_name == 'SELECT' || tag_name == 'TEXTAREA'){

				// type属性を取得する
				var typ = inp.attr('type');
				inp_ent['type_name'] = typ;

				if(typ=='file'){

					// 受け入れファイルタイプを取得
					var accept = inp.attr('accept');
					inp_ent['accept'] = accept;

				}

			}

			ent['inp_' + form_type] = inp_ent;

		}

		return fieldData;
	}

	
	
	
	/**
	 * TRからDIVへ反映
	 * @param par(string or jQuery object) 親要素オブジェクトまたはセレクタ
	 * @parma row_index 行インデックス	省略した場合アクティブTRの行インデックスになる。
	 * @param option
	 *  - form_type フォーム種別
	 *  - xss サニタイズフラグ 0:サニタイズしない , 1:xssサニタイズを施す（デフォルト）
	 */
	trToDiv(par,row_index,option){
		var ent = this.getEntity(row_index); // アクティブTR要素からエンティティを取得する
		this.entToBinds(par,ent,'class',option);// エンティティをclass属性バインド要素群へセットする
		this.entToBinds(par,ent,'name',option);// エンティティをname属性バインド要素群へセットする
		
	}
	
	/**
	 * エンティティをバインド要素群へセットする
	 * 
	 * @note
	 * entのフィールドに紐づく値がundefinedならバインド要素にセットしない。nullならセットする。
	 * 
	 * @param par(string or jQuery object) 親要素オブジェクトまたはセレクタ
	 * @param ent エンティティ
	 * @param bind_attr バインド属性	'class' or 'name'
	 * @param option
	 *  - form_type フォーム種別
	 *  - xss サニタイズフラグ 0:サニタイズしない , 1:xssサニタイズを施す（デフォルト）
	 *  - disFilData object[フィールド]{フィルタータイプ,オプション} 表示フィルターデータ
	 */
	entToBinds(par,ent,bind_attr,option){
		var bindElms = this.getBindElms(par,bind_attr,option); // class属性に紐づくバインド要素リストを親要素から取得する
		
		if(!option) option = {};
		
		// class属性である場合、表示フィルターをONにする。name属性であるならOFFにする。
		if(bind_attr == 'class'){
			option['dis_fil_flg'] = 1;
		}else if (bind_attr == 'name'){
			option['dis_fil_flg'] = 0;
		}

		// バインド要素リストにエンティティをセットする
		for(var i in this.fieldData){
			var field = this.fieldData[i].field;

			if(ent[field] === undefined) continue;

			var elms = bindElms[field];
			for(var e_i in elms){
				var elm = elms[e_i];
				this.setValueToElement(elm,field,ent[field],ent,option); // バインド要素リストを取得する
			}
		}
	}
	
	
	/**
	 * バインド要素リストを取得する
	 * @param par(string or jQuery object) 親要素
	 * @param bind_attr バインド属性	'class' or 'name'
	 * @return object[s][n] バインド属性リスト  
	 */
	getBindElms(par,bind_attr){
		
		
		var bindElms = {}; 
		
		if(!(par instanceof jQuery)){
			par = jQuery(par);
		}
		
		for(var i in this.fieldData){
			
			var fEnt = this.fieldData[i];
			
			//要素を取得する
			var bElms;
			if(bind_attr == 'class'){
				bElms = par.find('.' + fEnt.field);
			}else if(bind_attr == 'name'){
				bElms = par.find(`[name='${fEnt.field}']`);
			}else{
				continue;
			}

			if(!bElms[0]) continue;// 要素が取得できなかったら次へ
			
			// 2層構造でバインド要素リストに取得要素をセットする
			var bElms2 = [];
			for(var be_i=0;be_i<bElms.length;be_i++){
				bElms2.push(bElms.eq(be_i));
			}
			bindElms[fEnt.field] = bElms2;
		}
		return bindElms;
	}


	/**
	 * フォームにエンティティをセットする
	 * @param string form_type フォーム種別
	 * @param object ent エンティティ
	 * @param option 省略可
	 *  - disFilData object[フィールド]{フィルタータイプ,オプション} 表示フィルターデータ
	 */
	setFieldsToForm(form_type,ent,option){

		var form = this.getForm(form_type);// フォーム要素を取得
		
		if(option==null) option = {};
		option['par'] = form;
		option['form_type'] = form_type;
		
		this.entToBinds(form,ent,'class',option);// エンティティをclass属性バインド要素群へセットする
		this.entToBinds(form,ent,'name',option);// エンティティをname属性バインド要素群へセットする
		
	}
	
	
	/**
	 * 様々なタイプの要素へ値をセットする
	 * @param elm(string or jQuery object) 要素オブジェクト、またはセレクタ
	 * @param field フィールド
	 * @param val1 要素にセットする値
	 * @param ent エンティティ
	 * @param option
	 *  - par 親要素(jQuery object)
	 *  - form_type フォーム種別
	 *  - xss サニタイズフラグ 0:サニタイズしない , 1:xssサニタイズを施す（デフォルト）
	 *  - disFilData object[フィールド]{フィルタータイプ,オプション} 表示フィルターデータ
	 *  - dis_fil_flg 表示フィルター適用フラグ 0:OFF(デフォルト) , 1:ON
	 */
	setValueToElement(elm,field,val1,ent,option){
		
		if(!(elm instanceof jQuery)) elm = jQuery(elm);// 要素がjQueryオブジェクトでなければ、jQueryオブジェクトに変換。
		
		// オプションの初期化
		if(option == null) option = {};
		
		// サニタイズフラグを取得する
		var xss = 0;
		if(option['xss']==null){
			xss = 1;
		}else{
			xss = option['xss'];
		}
		
		var tag_name = elm.get(0).tagName; // 入力要素のタグ名を取得する
		
		// 値に表示フィルターをかける
		if(option['dis_fil_flg']){
			var res = this.displayFilter(val1,field,option.disFilData,xss);
			val1 = res.val1;
			xss = res.xss;
		}
		
		// 拡張型の入力要素への反映
		var inp_ex = elm.attr('data-inp-ex');
		if(inp_ex){
			switch(inp_ex){
			case 'image1':
				this._setEntToImage1(elm, field, val1); // 画像1型
				break;
			case 'image_fuk':
				this._setEntToImageFuk(elm, field, val1); // 画像FUK型
				break;
			}
			return;
		}
		
		// 値を入力フォームにセットする。
		if(tag_name == 'INPUT' || tag_name == 'SELECT'){

			// type属性を取得
			var typ = elm.attr('type');

			if(typ=='checkbox'){
				if(val1 ==0 || val1==null || val1==''){
					elm.prop("checked",false);
				}else{
					elm.prop("checked",true);
				}

			}

			else if(typ=='radio'){
				var opElm = option.par.find("[name='" + field + "'][value='" + val1 + "']");
				if(opElm[0]){
					opElm.prop("checked",true);
				}else{
					// 値が空である場合、ラジオボタンのすべての要素からチェックをはずす。
					if(this._empty(val1)){
						var radios = option.par.find("[name='" + field + "']");
						radios.prop("checked",false);
					}
				}

			}

			else{
				val1 = this._xssSanitaizeDecode(val1);// XSSサニタイズを解除
				elm.val(val1);
			}

		}

		// テキストエリア用のセット
		else if(tag_name == 'TEXTAREA'){

			if(val1!="" && val1!=null){
				val1=val1.replace(/<br>/g,"\r");
				val1 = this._xssSanitaizeDecode(val1);
			}
			elm.val(val1);
		}

		
		else{
			if( typeof val1 == 'string'){
				val1=val1.replace(/<br>/g,"\r");
				// XSSサニタイズを施す
				if(option.xss == 1){
					val1 = this._xssSanitaizeEncode(val1); 
				}
				val1 = this._nl2brEx(val1);// 改行コートをBRタグに変換する
			}
			elm.html(val1);
		}
		
		
	}
	
	
	/**
	 * 画像1型
	 * @param jQuery elm 入力要素
	 * @param string field フィールド
	 * @param string fp 画像パス
	 */
	_setEntToImage1(elm, field, fp){
		
		// 画像1型のHTML構造
		//	<td>
		//		<input type='hidden' name='{$field}' value='{$orig_fp}' data-inp-ex='image1' data-fp='' >
		//		<label for='{$field}'>
		//			<a href='{$href}' target='brank'>
		//				<img src='{$thum_src}' >
		//			</a>
		//		</label>
		//	</td>
		
		elm.val(fp);
		
		var orig_href = '';
		var img_src = '';
		if(this._empty(fp)){
			orig_href = "javascript void(0)";
			img_src = "img/icon/none.gif";
		}else{
			orig_href = fp;
			img_src = fp.replace('/orig/', '/thum/');
		}
		
		// 弟要素のlabelを取得
		var label = elm.next();
		
		// アンカー要素をlabelから取得し、ファイルパスをセットする
		var aElm = label.find('a');
		aElm.attr('href', orig_href);
		
		// IMG要素にサムネイルパスをセットする
		var imgElm = aElm.children().eq(0);	// IMG要素を取得
		imgElm.attr('src', img_src);
		
		elm.attr('data-fp', fp); // 「type='file'」に対応

	}
	
	
	/**
	 * 画像FUK型
	 * @param jQuery elm 入力要素
	 * @param string field フィールド
	 * @param string fp 画像パス
	 */
	_setEntToImageFuk(elm, field, fp){
		
		elm.attr('data-fp', fp); // 「type='file'」に対応

		var fue_id = elm.attr('id');

		// file要素にファイルパスをセットする
		this.cbFileUploadComp.setFilePaths(fue_id, fp);

	}
	
	
	/**
	 * 値に表示フィルターをかける
	 * @param val1 値
	 * @param field フィールド
	 * @param disFilData 表示フィルターデータ
	 * @param xss XSSサニタイズフラグ
	 * @return object
	 *  - [val1] フィルター後の値
	 *  - [xss] XSSサニタイズフラグ
	 */
	displayFilter(val1,field,disFilData,xss){
		
		
		 var res = {'val1':val1,'xss':xss};

		if(!disFilData) disFilData = this.param.disFilData;
		if(!disFilData) return res;
		if(!disFilData[field]) return res;
		
		var filEnt = disFilData[field];
		var xss = 0 ; // xssサニタイズフラグ
		
		switch (filEnt.fil_type) {
		case 'select':


			res.val1 = this.disFilSelect(val1,field,filEnt.option);// 表示フィルター・SELECTリスト
			

			break;
			
		case 'delete_flg':

			res.val1 = this.disFilDeleteFlg(val1,field,filEnt.option);// 表示フィルター・削除フラグ
			res.xss = 0;
			break;
			
		case 'flg':

			res.val1 = this.disFilFlg(val1,field,filEnt.option);// 表示フィルター・フラグ
			res.xss = 0;

			break;
			
		case 'money':

			res.val1 = this.disFilMoney(val1,field,filEnt.option);// 表示フィルター・金額
			res.xss =0;
			break;

		default:
			break;
		}
		
		return res;
	}
	
	/**
	 * 表示フィルターデータのSetter
	 * @param disFilData 表示フィルターデータ
	 */
	setDisplayFilterData(disFilData){
		this.param['disFilData'] = disFilData;
	}
	
	/**
	 * 表示フィルター・SELECTリスト
	 * @param val1 フィルターをかける値
	 * @param field フィールド
	 * @param option 
	 * 
	 */
	disFilSelect(val1,field,option){
		
		if(val1 == null) return val1;
		
		var list = {};
		if(option){
			if(option['list']){
				list = option['list'];
			}
		}
		
		var display_value = ""; // 表示する値
		if(list[val1] != null){
			display_value = list[val1];
		}
		return display_value;

	}
	
	/**
	 * 表示フィルター・削除フラグ
	 * @param val1 フィルターをかける値
	 * @param field フィールド
	 * @param option 
	 * 
	 */
	disFilDeleteFlg(val1,field,option){

		if(val1 == null) return val1;
		
		if(val1 == 1){
			return '<span style="color:#b4b4b4;">削除</span>';
		}else{
			return '<span style="color:#23d6e4;">有効</span>';
		}

	}
	
	/**
	 * 表示フィルター・フラグ
	 * @param val1 フィルターをかける値
	 * @param field フィールド
	 * @param option 
	 * 
	 */
	disFilFlg(val1,field,option){

		if(val1 == null || val1 == '' || val1 == false) val1 = 0;
		if(val1 > 0) val1 = 1;
		var val2 = option.list[val1];
		
		if(val1 == 1){
			return '<span style="color:#23d6e4;">' + val2 + '</span>';
		}else{
			return '<span style="color:#b4b4b4;">' + val2 + '</span>';
		}

	}
	
	/**
	 * 表示フィルター・金額
	 * @param val1 フィルターをかける値
	 * @param field フィールド
	 * @param option 
	 * 
	 */
	disFilMoney(val1,field,option){
		
		if(val1 == null) return val1;
		
		var currency = "&yen;";
		if(option){
			if(option['currency']){
				currency = option['currency'];
			}
		}
		return currency + String(val1).replace( /(\d)(?=(\d\d\d)+(?!\d))/g, '$1,');

	}


	/**
	 * フィールド名を指定してフィールドエンティティを取得する
	 */
	_getFieldEntByField(field){
		var index = this.fieldHashTable[field];
		var ent = this.fieldData[index];

		return ent;
	}


	/**
	 * 入力フォームを表示する
	 * 
	 * @param object form フォーム要素オブジェクト
	 * @param string triggerElm トリガー要素  ボタンなど
	 * @param option
	 *  - form_position フォーム位置フラグ:  auto(空）:基本位置 , left:トリガーの左側にフォームを表示 , center:横中央 , right:右側  , max:フルサイズ
	 *  - use_show_form_strategy 入力フォームストラテジーの使用:  入力フォームストラテジーがセットされている場合、利用するか。デフォルトは使用する。
	 */
	_showForm(form,triggerElm,option){

		if(option == null) option = {};
		
		// フォーム位置フラグをセットする。SP(スマホ）である場合は、max(横幅いっぱい）とする。
		if(option['form_position'] == null){
			option['form_position'] = this.param.form_position;
			if(this.param.device_type=='sp'){
				option['form_position'] = 'max';
			}
		}
		
		// SPである場合、ＳＰ版のスタイルを適用する
		if(this.param.device_type == 'sp'){
			var tblElm = form.find('table');
			tblElm.addClass('tbl_sp'); // ＳＰ版スタイルを適用
			tblElm.find('label.text-danger').hide(); // レイアウトが崩れるのでlabel要素を隠す
		}
		

		// 入力フォームストラテジーの使用
		if(option['use_show_form_strategy'] == null){
			option['use_show_form_strategy'] = 1;
		}

		// 複数のフォームを開いてフォームが重なった時、新しく開いたフォームが上になるようにする。
		if(this.param.auto_close_flg == 0){
			this.param.form_z_index ++;
			// ※ z_indexの最大値は32bit整数,あるいは64bit整数の最大値である。
			form.css('z-index',this.param.form_z_index);

		}

		form.show();

		// 入力フォームストラテジーがセットされている場合、こちらの処理を実行する。（ストラテジーパターンによる拡張である）
		if(option.use_show_form_strategy == 1 && this.showFormStrategy != null){
			var res = this.showFormStrategy.showForm(form,triggerElm);
			if(res==true){
				return;
			}
		}

		//トリガー要素の右上位置を取得
		if(!(triggerElm instanceof jQuery)){
			triggerElm = jQuery(triggerElm);
		}
		var offset=triggerElm.offset();
		var left = offset.left;
		var top = offset.top;

		var ww = jQuery(window).width();// Windowの横幅（ブラウザの横幅）

		// フォームのサイズを取得する。パラメータでサイズ指定されていない場合、フォームからサイズを取得する
		var form_width = this.param.form_width;// フォームの横幅
		var form_height = this.param.form_height;// フォームの縦幅
		if(this._empty(form_width)){
			form_width = form.outerWidth();
		}
		if(this._empty(form_height)){
			form_height = form.outerHeight();
		}

		// フォーム位置Yをセット
		var trigger_height = triggerElm.outerHeight();
		var tt_top = top + trigger_height;

		var tt_left=0;// フォーム初期位置X
		var full_w = ww; // コンテンツのフル横幅

		// コンテンツ要素が指定されている場合、コンテンツ要素の初期位置Xと横幅をセットする。
		if(!this._empty(this.param.contents_slt)){
			var conElm = jQuery(this.param.contents_slt);
			if(conElm[0]){
				tt_left = conElm.offset.left;
				full_w = conElm.width();
			}
		}


		// フォーム位置の種類毎にフォーム位置Xを算出する。
		switch (option.form_position) {

		case 'left':

			// トリガーの左側にフォームを表示する。
			tt_left=left - form_width;
			break;

		case 'center':

			// フォームを中央にする。
			tt_left=(full_w / 2) - (form_width / 2);
			break;

		case 'right':

			// トリガーの右側にフォームを表示する
			tt_left=left;
			break;

		case 'max':

			var  adjust_v = 2; // 調整値。 左右のborderの幅
			form_width = full_w - adjust_v;

			break;

		default:// auto

			// 基本的にトリガーの右側にフォームを表示する。
			// ただし、トリガーが右端付近にある場合、フォームは外側にでないよう左側へ寄せる。
			tt_left=left;
			if(tt_left + form_width > full_w){
				tt_left = full_w - form_width;
			}

			break;
		}

		if(tt_left < 0){
			tt_left = 0;
		}

		//フォーム要素に位置をセット
		form.offset({'top':tt_top,'left':tt_left });

		if(!this._empty(form_width)){
			form.width(form_width);
		}

		if(!this._empty(form_height)){
			form.height(form_height);
		}
		
		this._fitForm(form); // フォームを内容にフィットさせるようにリサイズする。
	}


	// フィールドデータにプロパティを追加する
	_addMoreFieldData(tbl_slt,fieldData){

		// フィールドデータが空であるなら一覧テーブルのth要素からフィールド名を取得する
		if(!fieldData){
			fieldData = this._getFieldDataFromTh();

			if(!fieldData){
				throw new Error('fieldDataを取得できません。th要素のclass属性にフィールド名を指定してください。');
			}
		}

		var fieldData2 = [];

		// thループ
		var i=0;
		jQuery('#' + tbl_slt + ' th').each((i,elm)=>{

			var wamei = jQuery(elm).text();

			var field = null;
			if(fieldData[i]){
				field = fieldData[i];
			}

			if(field != null){
				var ent = {
						'index':i,
						'field':field,
						'wamei':wamei,
					};

				fieldData2.push(ent);

				i++;
			}
		});

		return fieldData2;
	}

	// th要素からフィールド情報を取得する
	_getFieldDataFromTh(){

		var fieldData = [];

		var slt = '#' + this.param.tbl_slt + ' th';
		jQuery(slt).each((i,elm)=>{
			var thElm = jQuery(elm);
			var field = this._getFieldByClassOrName(thElm);////class属性またはname属性からフィールド名を取得する
			if(field){
				fieldData.push(field);
			};
		});
		return fieldData;
	}


	// フィールドハッシュテーブルをフィールドデータから生成する。
	_createFieldHashTable(fieldData){

		var hashTable = {};

		for(var i in fieldData){
			var fEnt = fieldData[i];

			hashTable[fEnt.field] = i;

		}

		return hashTable;
	}


	// フォーム情報の初期化
	_initFormInfo(param){

		var formInfo = {};// フォーム情報

		// 新規フォーム情報の設定
		var res = this._classifySlt(param['new_form_slt']);
		var newInpForm = jQuery(res['slt']);
		formInfo['new_inp'] = {
			'xid':res['xid'],	// ID属性
			'slt':res['slt'],	// フォーム要素のセレクタ
			'show_flg':0,		// 表示制御フラグ（閉じるイベント制御用）
			'form':newInpForm,	// フォーム要素
		};
		// フォームモードがダイアログ型であるならフォームをダイアログ化する。
		if(this.param.form_mode == 0){
			this._convertFormToDlg(formInfo.new_inp);// フォームをダイアログ化する。
		}

		// 編集フォーム情報の設定
		res = this._classifySlt(param['edit_form_slt']);
		var editForm = jQuery(res['slt']);
		formInfo['edit'] = {
			'xid':res['xid'],	// ID属性
			'slt':res['slt'],	// フォーム要素のセレクタ
			'show_flg':0,		// 表示制御フラグ（閉じるイベント制御用）
			'form':editForm,	// フォーム要素
		};
		// フォームモードがダイアログ型であるならフォームをダイアログ化する。
		if(this.param.form_mode == 0){
			this._convertFormToDlg(formInfo.edit);
		}


		// 削除フォーム情報の設定
		var res = this._classifySlt(param['delete_form_slt']);
		var deleteForm = jQuery(res['slt']);
		formInfo['delete'] = {
			'xid':res['xid'],	// ID属性
			'slt':res['slt'],	// フォーム要素のセレクタ
			'show_flg':0,		// 表示制御フラグ（閉じるイベント制御用）
			'form':deleteForm,	// フォーム要素
		};
		this._convertFormToDlg(formInfo['delete']);// フォームをダイアログ化する。


		// 抹消フォーム情報の設定
		var res = this._classifySlt(param['eliminate_form_slt']);
		var eliminateForm = jQuery(res['slt']);
		formInfo['eliminate'] = {
			'xid':res['xid'],	// ID属性
			'slt':res['slt'],	// フォーム要素のセレクタ
			'show_flg':0,		// 表示制御フラグ（閉じるイベント制御用）
			'form':eliminateForm,	// フォーム要素
		};
		this._convertFormToDlg(formInfo['eliminate']);// フォームをダイアログ化する。

		return formInfo;

	};

	/**
	 * バリデーションによるエラーを表示する
	 * @param errData エラーデータ
	 *  - 文字列型<string>	エラーメッセージのみ
	 *  - エラー出力指定型(単一) <{'err_slt','err_msg'}>		出力先セレクタとエラーメッセージ
	 *  - エラー出力指定型（複数） <[{'err_slt','err_msg'}]>	上記の配列
	 * @param form_type フォーム種別
	 * @returns void
	 */
	_errShow(errData,form_type){

		// フォーム種別からフォーム要素を取得する
		var form = this.getForm(form_type);

		// 一旦、バリデーションエラーメッセージをクリアする
		this._clearValidErr(form);

		// エラーメッセージのみである場合
		if (typeof errData == 'string'){
			var errElm = form.find(this.param.valid_msg_slt);
			if(errElm[0]){
				if(errElm.length > 1){
					errElm = errElm.eq(0);
				}
				errElm.html(errData.err_msg);
			}
			errElm.html(errData);

		}

		// エラーセレクタによってエラー出力先が指定されている場合
		else{

			// 複数エラータイプである場合
			if(errData[0]){
				for(var i in errData){
					var errEnt = errData[i];
					var errElm = form.find(errEnt.err_slt);
					errElm.html(errEnt.err_msg);
				}
			}

			// 単一エラータイプである場合
			else{
				var errElm = form.find(errData.err_slt);
				errElm.html(errData.err_msg);
			}
		}
	}


	/**
	 * 検索実行
	 */
	searchKjs(){

		// URLからパラメータを取得する
		var param = this._getUrlQuery();

		var formElm = this._getFormKjsElm(); // 検索条件フォーム要素を取得する
		
		// form要素内の入力要素群をループする。
		var kjs = {}; // 検索条件情報
		var removes = []; // 除去リスト（入力が空の要素のフィールド）
		
		formElm.find('.kjs_inp').each((i,elm)=>{

			// 要素から選択値を取得する
			var kjsElm = jQuery(elm);
			var val = kjsElm.val();

			// 選択値が空でない場合（0も空ではない扱い）
			var field = kjsElm.attr('id'); // 要素のID属性から検索条件フィールドを取得する
			if(!this._emptyNotZero(val)){
				val = encodeURIComponent(val); // 要素の値をURLエンコードする
				kjs[field] = val; // 検索条件情報にセットする
			}else{
				removes.push(field);
			}
		});

		// パラメータに検索条件情報をマージする
		jQuery.extend(param, kjs);

		// パラメータから除去リストのフィールドを削除する。
		for(var i in removes){
			var rem_field = removes[i];
			delete param[rem_field];
		}

		// 1ページ目をセットする
		param['page_no'] = 0;

		// パラメータからURLクエリを組み立てる
		var query = '';
		for(var field in param){
			var val = param[field];
			query += field + '=' + val + '&';
		}

		// URLの組み立て
		var url;
		if(query != ''){
			query = query.substr(0,query.length-1); // 末尾の一文字を除去する
			url = '?' + query;
		}

		// URLへ遷移
		window.location.href = url;
	}



	/**
	 * 現在の検索条件がデフォルトの検索条件を比較し、検索初期状態であるかチェックする。
	 * 
	 * @param outFields 比較対象外フィールド配列
	 * @param kjs 検索条件情報(省略可）
	 * @param defKjs デフォルト検索条件（省略可）
	 * @returns 検索初期状態 0:初期状態でない , 1:初期状態
	 */
	isDefaultKjs(outFields,kjs,defKjs){

		// 検索条件情報が省略されている場合はHTMLの埋込JSONから取得する。
		if(kjs==null){
			var kjs_json = $('#kjs_json').html();
			kjs = JSON.parse(kjs_json);
		}

		// デフォルト検索条件が省略されている場合はHTMLの埋込JSONから取得する。
		if(defKjs==null){
			var def_kjs_json = $('#def_kjs_json').val();
			defKjs = JSON.parse(def_kjs_json);
		}

		// 比較対象外フィールドマッピング
		var outFieldMap = {};
		for(var i in outFields){
			var field = outFields[i];
			outFieldMap[field] = 1;
		}

		var is_def_flg = 1; // 検索初期状態

		for(var field in defKjs){

			// 対象外フィールドに存在するフィールドであればコンテニュー。
			if(outFieldMap[field]){
				continue;
			}

			if(kjs[field] === null){
				continue;
			}else{

				// null,null,空文字はnullとして扱う。
				var kjs_value = kjs[field];
				if(this._emptyNotZero(kjs_value)){
					kjs_value = null;
				}
				
				var def_value = defKjs[field];
				if(this._emptyNotZero(def_value)){
					def_value = null;
				}

				// 値が異なるのであれば検索初期状態 は初期状態でないと判定する。
				if(kjs_value != def_value){

					is_def_flg = 0;
					break
				}
				
			}

		}

		return is_def_flg;

	}



	/**
	* name属性またはclass属性からフィールド名を取得する
	* 
	* @note
	* class属性が複数である場合、先頭のclass属性を取得する
	*
	* @parma elm 入力要素オブジェクト
	* @return フィールド名
	*/
	_getFieldByNameOrClass(elm){

		var field = elm.attr('name');
		if(!field){
			field = elm.attr('class');
		}

		if(!field){
			return field;
		}

		field = field.trim();
		var a = field.indexOf(' ');
		if(a != -1){
			field = field.substr(0,field.length - a);
		}

		return field;
	}


	/**
	* class属性またはname属性からフィールド名を取得する
	* 
	* @note
	* class属性が複数である場合、先頭のclass属性を取得する
	*
	* @parma elm 入力要素オブジェクト
	* @return フィールド名
	*/
	_getFieldByClassOrName(elm){

		var field = elm.attr('class');
		if(!field){
			field = elm.attr('name');
		}

		if(!field){
			return field;
		}

		field = field.trim();
		var a = field.indexOf(' ');
		if(a != -1){
			field = field.substr(0,field.length - a);
		}

		return field;
	}

	/**
	 * 対象文字列をID属性とセレクタに分類する
	 * @param slt 対象文字列
	 * @returns res
	 *  - xid ID属性
	 *  - slt セレクタ
	 */
	_classifySlt(slt){

		var xid='';
		var slt2 = '';

		if(!slt){
			return res = {
					'xid':xid,
					'slt':slt2
			}
		}

		var s1 = slt.charAt(0);
		if(s1=='#'){
			xid = slt.replace('#','');
			slt2 = slt;
		}else{
			xid = slt;
			slt2 = '#' + slt;
		}

		var res = {
				'xid':xid,
				'slt':slt2
		}

		return res;
	}

	/**
	 * XSSサニタイズ
	 * 
	 * @note
	 * 「<」と「>」のみサニタイズする
	 * 
	 * @param any data サニタイズ対象データ | 値および配列を指定
	 * @returns サニタイズ後のデータ
	 */
	_xssSanitaizeEncode(data){
		if(typeof data == 'object'){
			for(var i in data){
				data[i] = this._xssSanitaizeEncode(data[i]);
			}
			return data;
		}
		
		else if(typeof data == 'string'){
			return data.replace(/</g, '&lt;').replace(/>/g, '&gt;');
		}
		
		else{
			return data;
		}
	}
	
	
	/**
	 * XSSサニタイズ・デコード
	 * 
	 * @note
	 * 「<」と「>」のサニタイズ化を元に戻す
	 * 
	 * @param any data サニタイズ対象データ | 値および配列を指定
	 * @returns サニタイズ後のデータ
	 */
	_xssSanitaizeDecode(data){
		if(typeof data == 'object'){
			for(var i in data){
				data[i] = this._xssSanitaizeDecode(data[i]);
			}
			return data;
		}
		
		else if(typeof data == 'string'){
			return data.replace(/&lt;/g, '<').replace(/&gt;/g, '>');
		}
		
		else{
			return data;
		}
	}
	

	// 改行をBRタグに変換
	_nl2br(str) {
		if(typeof str == 'string'){
			return str.replace(/[\n\r]/g, "<br>");
		}else{
			return str;
		}
	}

	// 空判定
	_empty(v){
		if(v == null || v == '' || v=='0'){
			return true;
		}else{
			if(typeof v == 'object'){
				if(Object.keys(v).length == 0){
					return true;
				}
			}
			return false;
		}
	}

	/**
	 * 空判定 | ただし「0」はfalseを返す
	 * @param v
	 */
	_emptyNotZero(v){
		var res = this._empty(v);
		if(res){
			if(v===0 || v==='0'){
				res = false;
			}
		}
		return res;
	}

	/**
	 * URLクエリデータを取得する
	 * 
	 * @return object URLクエリデータ
	 */
	_getUrlQuery(){
		query = window.location.search;

		if(query =='' || query==null){
			return {};
		}
		var query = query.substring(1,query.length);
		var ary = query.split('&');
		var data = {};
		for(var i=0 ; i<ary.length ; i++){
			var s = ary[i];
			var prop = s.split('=');

			data[prop[0]]=prop[1];

		}	
		return data;
	}


	/**
	 * 入力フォームストラテジーのセッター
	 * @param obj 入力フォームストラテジーのオブジェクト
	 */
	setShowFormStrategy(obj){
		this.showFormStrategy = obj;
	}



	/**
	 * 要素の種類を問わずに値をセットする
	 * @param elm 要素(jQueryオブジェクト）
	 * @pramm v 値
	 * @version 1.0
	 */
	_setValueEx(elm,v){

		if(!elm[0]){
			return;
		}

		var tagName = elm.get(0).tagName; // 入力要素のタグ名を取得する

		// 値を入力フォームにセットする。
		if(tagName == 'INPUT' || tagName == 'SELECT'){

			// type属性を取得
			var typ = elm.attr('type');

			if(typ=='checkbox'){
				if(v ==0 || v==null || v==''){
					elm.prop("checked",false);
				}else{
					elm.prop("checked",true);
				}
			}

			else if(typ=='radio'){
				var f = elm.attr('name');
				var parElm = elm.parent();
				var opElm = parElm.find("[name='" + f + "'][value='" + v + "']");
				if(opElm[0]){
					opElm.prop("checked",true);
				}
			}
			else{

				if(typeof v == 'string'){
					v = v.replace(/&lt;/g, '<').replace(/&gt;/g, '>');
				}
				elm.val(v);
			}
		}

		// テキストエリア用のセット
		else if(tagName == 'TEXTAREA'){

			if(v!="" && v!=null){
				v=v.replace(/<br>/g,"\r");

				if(typeof v == 'string'){
					v = v.replace(/&lt;/g, '<').replace(/&gt;/g, '>');
				}
			}

			elm.val(v);

		}

		// IMGタグへのセット
		else if(tagName == 'IMG'){
			// IMG要素用の入力フォームセッター
			elm.attr('src',v);

		}

		// audioタグへのセット
		else if(tagName == 'AUDIO'){
			elm.attr('src',v);

		}else{
			if(v!="" && v!=null){
				v=v.replace(/<br>/g,"\r");
				if(typeof v == 'string'){
					v = v.replace(/</g, '&lt;').replace(/>/g, '&gt;');
				}
				v = v.replace(/\r\n|\n\r|\r|\n/g,'<br>');// 改行コートをBRタグに変換する
			}

			elm.html(v);
		}

	}
	
	
	/**
	 * 自動保存の依頼をする
	 * 
	 * @note
	 * バックグランドでHTMLテーブルのデータをすべてDBへ保存する。
	 * 二重処理を防止するメカニズムあり。
	 * 
	 * @param data 保存対象データ   省略した場合、HTMLテーブルのデータを保存する。
	 * @parma option 
	 *  - reflect_on_tbl 0:HTMLテーブルにdataを反映しない , 1:HTMLテーブルにdataを反映する
	 */
	saveRequest(data,option){
		this.autoSave.saveRequest(data,option);// 保存依頼
	}
	
	
	/**
	 * Ajax送信データ用エスケープ。実体参照（&lt; &gt; &amp; &）を記号に戻す。
	 * 
	 * @param any data エスケープ対象 :文字列、オブジェクト、配列を指定可
	 * @returns エスケープ後
	 */
	escapeForAjax(data){
		if (typeof data == 'string'){
			if ( data.indexOf('&') != -1) {
				data = data.replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&amp;/g,'&');
				return encodeURIComponent(data);
			}else{
				return data;
			}
		}else if (typeof data == 'object'){
			for(var i in data){
				data[i] = this.escapeForAjax(data[i]);
			}
			return data;
		}else{
			return data;
		}
	}
	
	/**
	 * 行入替後の処理
	 */
	rowExchangeAfter(){

		var data = this.getDataFromTbl();// Htmlテーブルからデータを取得
		
		var page_no = jQuery("#page_no").val() * 1;
		var limit = jQuery("#row_limit").val() * 1;

		// データに順番をセットする
		var sort_no = (page_no * limit) + 1;
		
		for(var i in data){
			var ent = data[i];
			ent['sort_no'] = sort_no;
			sort_no ++;
		}
		
		var option = {
				'reflect_on_tbl':1, // 1:HTMLテーブルにdataを反映する
		}
		this.saveRequest(data,option);// 自動保存の依頼をする
	}
	
	
	/**
	 * 登録ボタン切替
	 * @param string フォーム種別 new_inp,edit
	 * @param int active_flg アクティブフラグ 0:押せなくする , 1:押せるようにする
	 */
	_toggleRegBtn(form_type,active_flg){
		
		var form = this.getForm(form_type);// フォーム要素を取得
		
		var regBtns = form.find('.reg_btn');
		var regBtnMsgs = form.find('.reg_btn_msg');
		if(active_flg == 0){
			regBtns.prop('disabled',true);
			regBtnMsgs.html('　登録中・・・');
			
		}else{
			regBtns.prop('disabled',false);
			regBtnMsgs.html('');
			
		}

	}
	
	/**
	 * スネーク記法をキャメル記法に変換する
	 * (例) big_cat_test → BigCatTest
	 */
	_snakeToCamel(str){
		//_+小文字を大文字にする(例:_a を A)
		str = str.replace(/_./g,
			(s) => {
				return s.charAt(1).toUpperCase();
			}
		);

		// 先頭を大文字化する
		str = str.charAt(0).toUpperCase() + str.slice(1);
		
		return str;
	};
	
	
	
	
	/**
	 * 検索条件入力要素リストを取得する
	 */
	getKjElms(){
		var kjElms = {};
		jQuery('.kj_wrap').each((i,elm) => {
			elm = jQuery(elm);
			var field = elm.attr('data-field');
			kjElms[field] = elm;
		});
		
		return kjElms;
	}
	
	/**
	 * テーブル変形
	 * @param mode_no モード番号  0:テーブルモード , 1:区分モード
	 * @returns
	 */
	tableTransform(mode_no){

		if(mode_no == 1){
			this.tbl.addClass('table_transform');
			jQuery("#table_transform_tbl_mode").show();
			jQuery("#table_transform_div_mode").hide();
		}else{
			this.tbl.removeClass('table_transform');
			jQuery("#table_transform_tbl_mode").hide();
			jQuery("#table_transform_div_mode").show();
		}
	}
	

	
	
	/**
	 * FileUploadK | ファイルプレビュー後コールバック
	 * @param object box データボックス（FileUploadK.jsのプロパティ）
	 */
	_fukPrevAfterCallback(fue_id,box,cbParam){

		if(fue_id == null) return;
		
		// fue_idの末尾の2文字からフォーム種別を判定する。
		var end_str = fue_id.slice(-2); // 末尾の2文字を取得
		var form_type = null; // フォーム種別
		if(end_str == '_n'){
			form_type = 'new_inp';
		}else if(end_str == '_e'){
			form_type = 'edit';
		}else{
			return;
		}
		
		var self = cbParam.self;
		self._fitFormByFormType(form_type); // フォームを内容にフィットさせるようにリサイズする。

	}
	
	/**
	 * フォームを内容にフィットさせるようにリサイズする。
	 * @param string form_type フォーム種別
	 */
	_fitFormByFormType(form_type){
		
		var form = this.getForm(form_type);
		this._fitForm(form);

	}
	
	/**
	 * フォームを内容にフィットさせるようにリサイズする。
	 * @param jQuery form フォームオブジェクト
	 */
	_fitForm(form){
		
		if(this.param.form_mode == 1){
			form.css({
				'width':'auto',
				'height':'auto',
			});
			
		}else{
			form.css({
				'width':'auto',
				'height':'auto',
				'display':'inline-block',
			});
			
		}
	}
	
	

	
	/**
	 * フォームをドラッグ移動およびリサイズできるようにする。
	 */
	_formDragAndResizeSetting(){
		

		if(this.param.form_mode == 0){
			this._formDragAndResizeSetting2('new_inp');
			this._formDragAndResizeSetting2('edit');
		}
		
		this._formDragAndResizeSetting2('delete');
		this._formDragAndResizeSetting2('eliminate');

	}
	

	/**
	 * フォームをドラッグ移動およびリサイズできるようにする。
	 * @param string form_type フォーム種別
	 */
	_formDragAndResizeSetting2(form_type){
		
		
		if(this.param['drag_and_resize_flg'] != 1) return;
		
		var form = this.getForm(form_type);
		if(form==null) return;
		if(form.draggable == null) return;
		
		// フォームのドラッグ移動を有効にする。
		var draggableDiv = form.draggable();
		
		//ドラッグ移動を組み込むとテキスト選択ができなくなるので、パネルボディ部分をテキスト選択可能にする。
		$('.panel-body',draggableDiv).mousedown((ev) => {
			  draggableDiv.draggable('disable');
			}).mouseup((ev) => {
			  draggableDiv.draggable('enable');
			});
		
		//リサイズ機能を組み込む
		form.resizable();

	}
	
	/**
	 * エラータイプリストによるエラー処理
	 */
	_errByErrTypes(){

		// 検索条件エラーが存在する場合、詳細検索フォームを表示する
		if(this.param.errTypes.indexOf('kjs_err') >= 0){
			jQuery('.cb_kj_detail').show();
		}
	}
	
	/**
	 * ノート詳細を開く
	 * @param btnElm 詳細ボタン要素
	 */
	openNoteDetail(btnElm,field){
		
		if(field == null) field = 'note';
		
		// 親要素であるTD要素を取得する
		var td = btnElm.parents('td');
		
		// フィールド要素を取得する
		var fieldElm = td.find("[name='" + field + "']");
		
		// 短文要素を取得する
		var shortElm = td.find('.' + field);
		
		// ノート詳細要素を作成および取得する
		var maked = 1; // 作成済みフラグ  0:未作成 , 1:作成済み
		var noteDetailElm = td.find('.note_detail');
		if(!noteDetailElm[0]){
			maked = 0;
			var note_detail_html = "<div class='note_detail'></div>";
			td.append(note_detail_html);
			noteDetailElm = td.find('.note_detail');
		}
		
		// 短文要素が隠れている場合（ノート詳細が開かれている状態である場合）
		if(shortElm.css('display') == 'none'){
			shortElm.show();
			noteDetailElm.hide();
			btnElm.val('...');
			return;
		}
		
		// ノート詳細が作成済みである場合
		if(maked){
			shortElm.hide();
			noteDetailElm.show();
			btnElm.val('閉じる');
			return;
		}

		// ノートのフルテキストを取得する
		var text1 = td.find("[name='" + field + "']").val();
		if(text1 == null || text1 == '') return;
		
		// XSSサニタイズ
		text1 = this._xssSanitaizeEncode(text1);
		
		// 改行コードをBRタグに変換する
		text1 = text1.replace(/\r\n|\n\r|\r|\n/g,'<br>');
		
		// ノート詳細にテキストをセットする
		noteDetailElm.html(text1);
		
		// 短文要素を隠し、詳細ボタン名も変更する
		shortElm.hide();
		btnElm.val('閉じる');
		
	}
	
	
	/**
	 * フォームのcolspan属性に列数をセットする
	 * @param jQuery form フォーム
	 * @return 列数をセット後のjQueryフォーム
	 */
	_setColspanToForm(form){

		// 現在表示中の列数を取得する
		var clm_cnt = this._getClmCntByActive();
		
		// フォーム内のTD要素・colspan属性に列数をセットする。
		form.find('td').attr('colspan',clm_cnt);
		
		return form;
	}
	
	/**
	 * 現在表示中の列数を取得する
	 * @return int 列数
	 */
	_getClmCntByActive(){
		// 表示中の列数を取得する
		var cshAry = this.csh.getCshAry();
		var clm_cnt = 1; // 列数 (最初の1はボタン類の列を表す）
		for(var i in cshAry){
			if(cshAry[i]) clm_cnt ++;
		}
		return clm_cnt;
	}
	
	/**
	 * フォームのcolspan属性に列数をセットする
	 * @param jQuery form フォーム
	 * @return 列数をセット後のjQueryフォーム
	 */
	_setColspanToTd(td){
		
		// 表示中の列数を取得する
		var cshAry = this.csh.getCshAry();
		var clm_cnt = 1; // 列数 (最初の1はボタン類の列を表す）
		for(var i in cshAry){
			if(cshAry[i]) clm_cnt ++;
		}
		
		// フォーム内のTD要素・colspan属性に列数をセットする。
		form.find('td').attr('colspan',clm_cnt);
		
		return form;
	}
	
	
	/**
	 * 初期戻しボタンにURLをセットする
	 */
	_iniRtnSetUrl(){
		
		var hiddensElm = this._getHiddensElm(); // hiddenデータ要素を取得（埋込データ要素）

		var referer_url = hiddensElm.find('#referer_url').val(); // リファラURL
		var now_url = hiddensElm.find('#now_url').val(); // 現在URL
		
		// GETクエリ部分を取り除いたURLを取得する
		var r_url_b = this._stringLeft(referer_url, '?', 1);
		var now_url_b = this._stringLeft(now_url, '?', 1);

		var ini_rtn_url = ''; // 初期戻りURL
		
		// クエリ部分を除いたリファラURLと現在URLが一致するなら、ローカルストレージに保存してある初期戻りURLを取得する。
		if(r_url_b == now_url_b){
			ini_rtn_url = localStorage.getItem("crud_base_ini_rtn_url");
			if(ini_rtn_url == null) ini_rtn_url =  now_url;
		}else{
			// 一致しないなら現在URLを初期戻りURLとして取得。またローカルストレージに保存する。
			ini_rtn_url = now_url;
			localStorage.setItem("crud_base_ini_rtn_url",ini_rtn_url);
		}
		
		// 初期戻りボタンに初期戻りURLをセットする
		jQuery('.ini_rtn').attr('href', ini_rtn_url);
		
	}
	
	/**
	 * hiddenデータ要素を取得（埋込データ要素）
	 */
	_getHiddensElm(){
		if(this.hiddensElm == null){
			this.hiddensElm = jQuery('#hiddens_data');
		}
		return this.hiddensElm;
	}
	
	/**
	 * 文字列を左側から印文字を検索し、左側の文字を切り出す。
	 * @date 2016-12-8 | 2018-11-28
	 * @version 1.1
	 * 
	 * @param s 対象文字列
	 * @param mark 印文字
	 * @param not_find_flg 0:印文字が見つからないなら空を返す[デフォルト] , 1:見つからないならそのまま対象文字列を返す
	 * @return 印文字から左側の文字列
	 */
	_stringLeft(s, mark, not_find_flg){

		if (s==null || s=="") return s;
		
		var a=s.indexOf(mark);
		if(a== -1){
			if(not_find_flg == 1) return s;
		}
		
		var s2=s.substring(0,a);
		return s2;
		
	}
	
	/**
	 * 検索関連の入力要素にEnterイベントを組み込む
	 */
	_addEventForKjsEnter(){
		
		var formKjsElm = this._getFormKjsElm(); // 検索条件フォーム要素を取得
		
		// 新規入力フォームのinput要素にEnterキー押下イベントを組み込む。
		formKjsElm.find('input').keypress((e) => {
			if(e.which==13){ // Enterキーが押下された場合
				this.searchKjs(); // 検索実行
			}
		});
		
		
	}
	
	/**
	 * 検索条件フォーム要素を取得
	 */
	_getFormKjsElm(){
		if(this.formKjsElm == null){
			this.formKjsElm = jQuery('.form_kjs');
		}
		return this.formKjsElm;
	}
	
	
	
	/**
	 * カレンダービューを生成
	 * @param string date_field 日付フィールド
	 */
	calendarViewCreate(date_field){

		// 一覧テーブルからデータを取得する
		var data = this.getDataFromTbl();
		
		// カレンダービューを生成
		this.calendarViewK.create(data, date_field);
		
	}
	
	/**
	 * リアクト機能の初期化
	 * @param string hyo_elm_id 表要素ID   複数の表IDを指定するときはコンマで連結する
	 */
	reactInit(hyo_elm_id){		

		var d1 = new Date();
		var t1 = d1.getTime();

		// フィールド配列を取得する
		var fields = this._getFields();
		
		this.crudBaseReact.init(fields, hyo_elm_id);
		
		// ■■■□□□■■■□□□■■■□□□
		var d2 = new Date();
		var t2 = d1.getTime();
		var t3 = t2 - t1;

	}
	
	/**
	 * 行のリアクティビング
	 */
	reactivatingOfRow(){
		this.crudBaseReact.reactivatingOfRow();
	}

	/**
	 * フィールド配列を取得する
	 * @return array フィールド配列
	 */
	_getFields(){
		
		if(this.fields != null) return this.fields;
		
		var fields = [];
		for(var i in this.fieldData){
			var fEnt = this.fieldData[i];
			fields.push(fEnt.field);
		}
		this.fields = fields;
		return this.fields;

	}
	
	
	/**
	 * Google翻訳API・キャッシュ機能拡張の初期化
	 * @param string page_code ページコード
	 * @param string xids ID属性リスト
	 */
	initCbGtaCash(page_code, xids){
		if(this.cbGtaCash == null) return;
		this.cbGtaCash.init(page_code, xids);
	}
	
}



/**
 * CrudBase 自動保存機能
 * @version 1.0
 * @date 2018-3-2
 */
class CrudBaseAutoSave{
	
	
	/**
	 * コンストラクタ
	 * @param crudBase CrudBaseオブジェクト
	 */
	constructor(crudBase){

		this.crudBase = crudBase; // Htmlテーブルからデータを取得する関数
		this.fieldData = crudBase.fieldData;
		this.tbl = crudBase.tbl;
		this.msgElm = jQuery('#crud_base_auto_save_msg'); // 自動保存メッセージ要素
		this.data; // 保存するデータ
		this.set_timeout_hdl; // setTimeout関数のハンドラ

	}
	
	/**
	 * 自動保存の依頼をする
	 * 
	 * @note
	 * HTMLテーブルのデータをバックグランドで自動保存する。
	 * 
	 * @param data 保存対象データ   省略した場合、HTMLテーブルのデータを保存する。
	 * @parma option 
	 *  - reflect_on_tbl 0:HTMLテーブルにdataを反映しない , 1:HTMLテーブルにdataを反映する
	 */
	saveRequest(data,option){
		
		this.data = data; // 保存対象データを更新する

		// オプションの初期化
		if(option==null) option = {};
		if(option['reflect_on_tbl']==null) option['reflect_on_tbl'] = 0;
		if(option['interval']==null) option['interval'] = 3000;

		
		// setTimeoutの処理を一旦キャンセルする。
		if(this.set_timeout_hdl != null){
			clearTimeout(this.set_timeout_hdl);
		}
		
		// バックグラウンドで自動保存を実行する。(数秒後の遊びを設ける）
		this.set_timeout_hdl = setTimeout(()=>{
			this._autoSave(this.data);// 自動保存
			if(option['reflect_on_tbl']==1){
				this.crudBase.setDataToTbl(null,data); // データをHTMLテーブルに再セットする
			}
		}, option.interval);

	}
	
	/**
	 * 自動保存処理
	 * 
	 * @param data 保存対象データ   省略した場合、HTMLテーブルのデータを保存する。
	 */
	_autoSave(data){
	
		this.msgElm.html('保存中...');
		console.log('自動保存');
		if(data == null){
			var data = this.crudBase.getDataHTbl();// Htmlテーブルからデータを取得
		}
		data = this.crudBase.escapeForAjax(data); // Ajax送信データ用エスケープ。実体参照（&lt; &gt; &amp; &）を記号に戻す。
		var json_str = JSON.stringify(data);//データをJSON文字列にする。
		var url = this.crudBase.param.auto_save_url; // 自動保存サーバーURL
		
		// AJAX
		jQuery.ajax({
			type: "POST",
			url: url,
			data: "key1="+json_str,
			cache: false,
			dataType: "text",
		})
		.done((str_json, type) => {
			var res;
			try{
				res =jQuery.parseJSON(str_json);
				this.msgElm.html('');

			}catch(e){
				this.msgElm.html('自動保存のエラー1');
				jQuery("#err").html(str_json);
				return;
			}
		})
		.fail((jqXHR, statusText, errorThrown) => {
			this.msgElm.html('自動保存のエラー2');
			jQuery('#err').html(jqXHR.responseText);
		});
		
	}
	
}
/**
 * CrudBase一括追加機能
 * 
 * @date 2019-1-3 | 2019-1-17
 * @version 1.0.1
 * 
 */
class CrudBaseBulkAdd{
	
	
	/**
	 * コンストラクタ
	 * @param array fieldData
	 */
	constructor(fieldData){
		
		this.fieldData = fieldData;
		
	}
	
	
	/**
	 * 初期化
	 * @param array inpFields 入力フィールドリスト
	 *  - entity エンティティ
	 *   - field フィールド名
	 *   - inp_type 入力タイプ
	 *    - 'textarea' テキストエリア型
	 *    - 'select'   SELECT型
	 *    - 'date'     日付選択型
	 *    - 'text'     テキスト型
	 *   - list SELECTリスト 
	 *
	 * @param object param 
	 *  - string ajax_url			非同期通信先URL
	 *  - string ta_placeholder		テキストエリアのプレースホルダー
	 *  - string ta_height			テキストエリア縦幅
	 */
	init(inpFields, param){
		
		// フィールドデータから和名を取得して、入力フィールドリストにセットする。
		for(var i in inpFields){
			var ent = inpFields[i];
			ent['wamei'] = this._getWameiFromFieldData(ent.field);
		}
		
		this.inpFields = inpFields;
		
		this.param = this._initParam(param);
		
	}
	
	/**
	 * フィールドデータから和名を取得する
	 * @param string field フィールド
	 * @return string 和名
	 */
	_getWameiFromFieldData(field){
		var wamei = field;
		
		for(var i in this.fieldData){
			var fEnt = this.fieldData[i];
			if(field == fEnt.field){
				wamei = fEnt.wamei;
				break;
			}
		}
		
		return wamei;
	}

	/**
	 * パラメータの初期化
	 * @param object param
	 * @return 初期化したparam
	 */
	_initParam(param){
		
		if(param == null) param = {};
		
		if(param['ajax_url'] == null){
			throw new Error('Not empty ajax_url in param!');
		}

		if(param['ta_placeholder'] == null){
			param['ta_placeholder'] = "Excelからコピーした行列を貼り付けてください。\n(例)\nネコ名A\t100\nネコ名B\t101\n";
		}
		
		if(param['ta_height'] == null) param['ta_height'] ='20rem';
		
		if(param['test_mode'] == null) param['test_mode'] = 0;
		
		return param;
	}
	
	/**
	 * フォーム表示
	 */
	showForm(){
		if(this.form){
			this.form.show();
			this.form.find('#cbba_inps_div').show();
			this.form.find('#cbba_preview_div').hide();
			return;
		}
		
		var param = this.param;
		
		// 同適用の入力HTMLを作成
		var same_applys_html = this._makeSameApplysHtml();
		
		// テストモードがONであるならテスト用テキストを取得
		var test_text = '';
		if(this.param.test_mode) test_text = this._getTestText();
		
		var html = `
			<div id="cbba_div" >
				<div id="cbba_head" >
					<h4>一括追加</h4>
					<div id="cbba_close_btn_w" style="">
						<input id="cbba_close_btn" type='button' value="閉じる" class="btn btn-primary btn-xs" onclick="" />
					</div>
				</div>
				<div style="clear:both"></div>
				
				<div id="cbba_inps_div">
					<textarea id="cbba_ta" placeholder="${param.ta_placeholder}" style='height:${param.ta_height}'>${test_text}</textarea>
					<div id="cbba_same_applys_w">${same_applys_html}</div>
					<div id="cbba_preview_btn_w">
						<input id="cbba_preview_btn" type="button" value="プレビュー" class="btn btn-success" />
					</div>
				</div>
				
				<div id="cbba_preview_div" style="display:none">
					<div id="cbba_preview_div2">
					</div>
					<input id="cbba_reg_btn" type="button" value="一括追加" class="btn btn-danger" />
					<input id="cbba_rtn_btn" type="button" value="戻る" class="btn btn-primary" />
				</div>
				
				<div id="cbba_err" class="text-danger"></div>
			</div>
		`;
		
		var form = jQuery('#crud_base_bulk_add');
		form.html(html);
		
		// 閉じるボタンのイベントを組み込む
		var closeBtn = form.find('#cbba_close_btn');
		closeBtn.click( (e)=>{
			this.form.hide();
		});
		
		// 一括追加ボタンにイベントを組み込む
		var previewBtn = form.find('#cbba_reg_btn');
		previewBtn.click( (e)=>{
			this._bulkAdd();
		});
		
		// 戻るボタンにイベントを組み込む
		var rtnwBtn = form.find('#cbba_rtn_btn');
		rtnwBtn.click( (e)=>{
			this._returnToInput(); // 入力へ戻る
		});
		
		// プレビューボタンにイベントを組み込む
		var previewBtn = form.find('#cbba_preview_btn');
		previewBtn.click( (e)=>{
			this._preview();
		});
		
		this.form = form;
		this.form.show();
		
	}

	/**
	 * 入力へ戻る
	 */
	_returnToInput(){
		
		this.form.find('#cbba_preview_div').hide();
		this.form.find('#cbba_inps_div').show();
	}
	
	
	/**
	 * テスト用テキストを取得する
	 * @return string テスト用テキスト
	 */
	_getTestText(){
		return "ロイヤルアナロスタン\t101\nロード・ゴート\t102\nツィッツァ\t103\nイッパイアッテナ\t104\n<input />\t105\nおキャット様.'\"\t106";
	}
	

	/**
	 * 同適用の入力HTMLを作成
	 */
	_makeSameApplysHtml(){
		
		var html = ''; // 同適用の入力HTML
		
		var inpFields = this.inpFields;// 入力フィールドリスト
		for(var i in inpFields){
			var ent = inpFields[i];
			switch(ent.inp_type){
			case 'text':
				html += this._makeSameApplyTypeText(ent);
				break;
			case 'date':
				html += this._makeSameApplyTypeDate(ent);
				break;
			case 'select':
				html += this._makeSameApplyTypeSelect(ent);
				break;
			case 'sort_no':
				html += this._makeSameApplyTypeSortNo(ent);
				break;
			}
		}
		
		return html;
	}
	
	/**
	 * 同適用の入力HTML作成：text型
	 * @parma object ent 入力フィールドエンティティ
	 */
	_makeSameApplyTypeText(ent){
		
		var def = '';
		if(ent['def'] != null) def = ent.def;
		
		var html = `
			<div class="same_apply_w">
				<label>${ent.wamei}</label>
				<input type="text" class="same_apply ${ent.field}" value="${def}" />
			</div>
		`;
		
		return html;
	}
	
	/**
	 * 同適用の入力HTML作成：date型
	 * @parma object ent 入力フィールドエンティティ
	 */
	_makeSameApplyTypeDate(ent){
		
		var def = '';
		if(ent['def'] != null){
			def = ent.def;
			def = this._convDateTo_yyyymmdd(def);
		}

		var html = `
			<div class="same_apply_w">
				<label>${ent.wamei}</label>
				<input type="date" class="same_apply ${ent.field}" value="${def}" />
			</div>
		`;
		
		return html;
	}
	
	/**
	 * 同適用の入力HTML作成：select型
	 * @parma object ent 入力フィールドエンティティ
	 */
	_makeSameApplyTypeSelect(ent){

		// 初期値
		var def = null;
		if(ent['def'] != null) def = ent.def;
		
		// SELECTのoption部分を組み立てる
		var sel_opt_html = '';
		for(var value in ent.list){
			var name = ent.list[value];
			
			var selected = '';
			if(def == value) selected = 'selected';

			sel_opt_html += `<option value='${value}' ${selected}>${name}</option>`;
		}

		var html = `
			<div class="same_apply_w">
				<label>${ent.wamei}</label>
				<select class="same_apply ${ent.field}">${sel_opt_html}</select>
			</div>
		`;
		
		return html;
	}
	
	/**
	 * 同適用の入力HTML作成：ソート型
	 * @parma object ent 入力フィールドエンティティ
	 */
	_makeSameApplyTypeSortNo(ent){

		
		var checked0 = '';
		var checked1 = '';
		if(ent['def'] == 1){
			checked1 = 'checked';
		}else{
			checked0 = 'checked';
		}
		
		var html = `
			<div class="same_apply_w">
				<label>追加場所</label>
				<label class='cbba_sort_no_label'>
					<input type="radio" name="cbba_sort_no" value="0" ${checked0}>
					先頭に追加
				</label>
				<label class='cbba_sort_no_label'>
					<input type="radio" name="cbba_sort_no" value="1" ${checked1}>
					末尾に追加
				</label>
			</div>
		`;
		
		return html;
	}
	
	/**
	 * 日付の書式を「yyyy-mm-dd」形式に変換する
	 * @param mixed date1 日付
	 * @returns string 「yyyy-mm-dd」形式の日付文字列
	 */
	_convDateTo_yyyymmdd(date1){
		
		// 引数が文字列型であれば日付型に変換する
		if((typeof date1) == 'string'){
			date1 = new Date(date1);
			if(date1 == 'Invalid Date'){
				return null;
			}
		}
		
		var year = date1.getFullYear();
		var month = date1.getMonth() + 1;
		month = ("0" + month).slice(-2); // 2桁の文字列に変換する
		var day = date1.getDate();
		day = ("0" + day).slice(-2);
		var date_str = year + '-' + month + '-' + day;
		return date_str;
	}
	
	
	/**
	 * プレビュー
	 */
	_preview(){

		var data = [];
		
		// テキストエリアからデータを取得する
		data = this._getDataFromTextArea(data);
		
		this._err(''); // エラー表示をクリア
		if(data.length == 0){
			this._err('テキストエリアが空です。');
			return;
		}
		
		// 同適用・入力からデータを取得する。
		data = this._getDataFromSameApplys(data);
		
		var data2 = jQuery.extend(true, {}, data);// データのクローン
		data2 = this._xss_sanitize(data2); // クローンしたデータにXSSサニタイズ
		
		// プレビューHTMLを作成する
		var html = this._makePrviewHtml(data2);

		// プレビュー区分の表示
		var previewDiv = this.form.find('#cbba_preview_div');
		previewDiv.find('#cbba_preview_div2').html(html);
		previewDiv.show();
		this.form.find('#cbba_inps_div').hide(); // 入力区分は隠す
		

		this.data = data;
		
	}
	
	
	/**
	 * テキストエリアからデータを取得する
	 * @param array data
	 * @return data
	 */
	_getDataFromTextArea(data){
		
		// ▼ テキストエリアのテキストからアルファデータを作成する。
		var ta_text = this.form.find('#cbba_ta').val();
		var aData = this._makeADataFromTaText(ta_text);
		
		// ▼ 入力フィールドリストから「入力タイプ=textarea」の条件でフィルタリングし、TA入力フィールドにセット。
		var taInpFields = this._filteringToTaInpFields();

		// ▼ アルファデータとTA入力リストからデータを組み立てる
		for(var i in aData){
			var aEnt = aData[i];
			var ent = {}; // データのエンティティ
			
			for(var f_i in taInpFields){
				var field = taInpFields[f_i].field;
				
				if(aEnt[f_i] == null){
					ent[field] = '';
				}else{
					ent[field] = aEnt[f_i];
				}
			}

			data.push(ent);
		}
		
		return data;
	}
	
	/**
	 * テキストエリアのテキストからアルファデータを作成する。
	 * @param string ta_text テキストエリアのテキスト
	 * @return array アルファデータ
	 */
	_makeADataFromTaText(ta_text){
		
		var aData = [];
		var list = ta_text.split("\n");

		for(var i in list){
			var line = list[i];
			if(line == '') continue;
			var row = line.split("\t");
			aData.push(row);
		}

		return aData;
		
	}
	
	/**
	 * 入力フィールドリストから「入力タイプ=textarea」の条件でフィルタリングしたデータである、TA入力フィールドを取得する。
	 */
	_filteringToTaInpFields(){
		var inpFields = this.inpFields; // 入力フィールドリスト
		var taInpFields = []; // TA入力フィールド
		for(var i in inpFields){
			var ent = inpFields[i];
			if(ent.inp_type == 'textarea'){
				taInpFields.push(ent);
			}
		}
		return taInpFields;
	}
	
	
	/**
	 * 同適用・入力からデータを取得する。
	 * @param array data
	 * @return data
	 */
	_getDataFromSameApplys(data){
		
		// 同適用・入力リスト
		var inpTypes = ['text', 'date', 'select'];
		
		// 入力フィールドリストを同適用・入力リストで絞り込み、SA入力フィールドリストをして取得する。
		var saInpFields = this._filteringInpFieldsByInpTypes(inpTypes);
		
		// ▼ 同適用・入力からデータを取得する。
		for(var i in saInpFields){
			var field = saInpFields[i].field;

			// 入力フォームから値を取得する。
			var value = '';
			var inpElm = this.form.find('.' + field);
			if(inpElm[0]){
				value = inpElm.val();
			}
			
			// dataの縦要素に値をセットする。
			for(var d_i in data){
				var ent = data[d_i];
				ent[field] = value;
			}
		}
		
		return data;
	}
	
	/**
	 * 入力フィールドリストを入力タイプリストで絞り込む
	 * @param array inpTypes 入力タイプリスト
	 * @return array 絞り込んだ入力フィールドリスト
	 */
	_filteringInpFieldsByInpTypes(inpTypes){
		var inpFields = this.inpFields; // 入力フィールドリスト
		var filList = []; // 絞り込んだ入力フィールドリスト
		for(var i in inpFields){
			var ent = inpFields[i];
			if(inpTypes.indexOf(ent.inp_type) >= 0){
				filList.push(ent);
			}
		}
		return filList;
	}
	
	/**
	 * プレビューHTMLを作成する
	 * @param array data
	 * @return string プレビューHTML
	 */
	_makePrviewHtml(data){
		if(data.length==0) return '';
		
		// 列名リストを取得する
		var theads = this._getTHeads(data[0]);
		
		var html = "<table class='tbl2'>";
		
		// 0件目のエンティティからtheadを作成
		html += "<thead><tr>";
	
		var ent0 = data[0];
		for(var field in ent0){
			var wamei = theads[field];
			html += "<th>" + wamei + "</th>";
		}
		html += "</tr></thead>";
		
		// tbodyの部分を作成
		for(var i in data){
			var ent = data[i];
			html += "<tr>";
			for(var f in ent){
				html += "<td>" + ent[f] + "</td>"
			}
			html += "</tr>";
			
		}
		
		html+= "</table>";
	
		return html;
	}
	
	/**
	 * 列名リストを取得する
	 * @param object ent0 データの先頭エンティティ
	 */
	_getTHeads(ent0){

		var tHeads = {}; // 列名リスト
		var fieldData = this.fieldData;
		
		for(var field in ent0){
			var wamei = field;
			for(var i in fieldData){
				var fEnt = fieldData[i];
				if(field == fEnt.field){
					wamei = fEnt.wamei;
					break;
				}
			}
			tHeads[field] = wamei;
		}
		return tHeads;
	}
	
	/**
	 * XSSサニタイズ
	 * 
	 * @note
	 * 「<」と「>」のみサニタイズする
	 * 
	 * @param any data サニタイズ対象データ | 値および配列を指定
	 * @returns サニタイズ後のデータ
	 */
	_xss_sanitize(data){
		if(typeof data == 'object'){
			for(var i in data){
				data[i] = this._xss_sanitize(data[i]);
			}
			return data;
		}
		
		else if(typeof data == 'string'){
			return data.replace(/</g, '&lt;').replace(/>/g, '&gt;');
		}
		
		else{
			return data;
		}
	}
	
	/**
	 * 一括追加処理
	 */
	_bulkAdd(){
		
		// 一括追加ボタンを登録中および押下無効にする。
		this._anabledBulkAddBtn(false);
		
		// 追加位置を取得する。
		var add_position = this._getAddPosition();
		this.param['add_position'] = add_position;
		
		// Ajax送信データ
		var sendData = {'add_position':add_position};
		
		// Ajax:順番を取得
		this._ajax('cbba_get_sort_no', sendData, this._bulkAdd2);
		

	}
	
	/**
	 * 一括追加処理: 順番取得後
	 * @param object self 当クラス自身のインスタンス
	 * @param object res AJAXからのレスポンス
	 */
	_bulkAdd2(self, res){
		
		var next_sort_no = res.next_sort_no; // 次順番
		var add_position = self.param['add_position']; // 追加位置 0:先頭追加, 1:末尾追加
		
		// ▼データに順番をセットする
		var data = self.data;
		var sort_no = next_sort_no;
		for(var i in data){
			var ent = data[i];
			ent['sort_no'] = sort_no;
			
			if(add_position == 1){
				sort_no++;
			}else{
				sort_no--;
			}
		}
		
		// Ajax送信データ
		var sendData = {'data':data};

		// 一括追加登録
		self._ajax('cbba_add_reg', sendData, self._bulkAdd3);
		
	}
	
	/**
	 * 一括追加処理: DB登録後
	 * @param object self 当クラス自身のインスタンス
	 * @param object res AJAXからのレスポンス
	 */	
	_bulkAdd3(self, res){

		var newIds = res.newIds; // 新IDリスト
		
		// データに新IDをセット
		var data = self.data;
		for(var i in data){
			var ent = data[i];
			var new_id = newIds[i];
			ent['id'] = new_id;
		}
		
		var err_msg = res.err_msg;
		if(err_msg != ''){
			self._err(err_msg);
			return;
		}
		
		location.reload(true);
		
	}
	

	/**
	 * AJAX
	 * @param string action_code アクションコード
	 * @param object sendData 送信データ
	 * @param function callback コールバック
	 */
	_ajax(action_code, sendData, callback){
		
		// AJAX通信先URL
		var ajax_url = this.param.ajax_url;
		
		// 送信データ
		sendData['action_code'] = action_code;
		var json_str = JSON.stringify(sendData);
		
		// AJAX
		jQuery.ajax({
			type: "POST",
			url: ajax_url,
			data: "key1="+json_str,
			cache: false,
			dataType: "text",
		})
		.done((str_json, type) => {
			
			var res = null;
			try{
				var res = jQuery.parseJSON(str_json);
			}catch(e){
				this._err(str_json);
				return;
			}
			
			callback(this, res);
			
		})
		.fail((jqXHR, statusText, errorThrown) => {
			this._err(jqXHR.responseText);
		});
	}
	
	
	/**
	 * 一括追加ボタンを有効または無効にする。
	 * @param bool flg false:無効にする , true:有効にする
	 */
	_anabledBulkAddBtn(flg){
		if(flg==null) flg = false;
		if(this.regBtn == null){
			this.regbtn = this.form.find('#cbba_reg_btn');
		}
		var regBtn = this.regbtn;
		
		if(flg==true){
			regBtn.val('一括追加');
			regBtn.prop('disabled',false);
		}else{
			regBtn.val('追加中・・・');
			regBtn.prop('disabled',true);
			
		}

	}
	
	/**
	 * 追加位置を取得する。
	 * @return int 追加位置 　0:先頭に追加, 1:末尾に追加
	 */
	_getAddPosition(){
		var radio = this.form.find('input[name="cbba_sort_no"]:checked');
		var add_position = 1;
		if(radio[0]){
			add_position = radio.val();
		}
		
		return add_position;
	}
	
	/**
	 * エラー表示
	 * @param string err_text エラーテキスト
	 */
	_err(err_text){
		if(this.errElm == null){
			this.errElm = this.form.find('#cbba_err');
		}
		this.errElm.html(err_text);
		
	}
	
}
/**
 * Class of JavaScript for ES6
 * 
 * @date 2017-10-10
 * @version 1.0.0
 * 
 */
class CrudBasePasswordEdit{
	
	
	/**
	 * コンストラクタ
	 * 
	 * @param param
	 * - flg
	 */
	constructor(newInpForm, editForm, param){

		this.newInpForm = newInpForm;
		this.editForm = editForm;
		
		this.param = this._setParamIfEmpty(param);
		
		var data = [];
		data = this._getPwElmsFromNewInp(data, newInpForm, 'new_inp'); // 新規入力フォームからパスワード要素データを取得
		data = this._getPwElmsFromNewInp(data, editForm, 'edit'); // 編集フォームからパスワード要素データを取得
		
		// パスワード変更ボタン群を各パスワード要素の下に作成する。ついでにボタン要素も取得する
		data = this._createPwChgbtns(data);
		
		// 変更ボタンにクリックイベントをセットする
		this._setClickEventToBtn(data);
		
		this.data = data;
	}

	
	/**
	 * If Param property is empty, set a value.
	 */
	_setParamIfEmpty(param){
		
		if(param == null) param = {};

		return param;
	}
	
	/**
	 * フォームからパスワード要素データを取得
	 * @param array data
	 * @param jQuery form フォームの要素オブジェクト
	 * @param string form_type フォーム種別
	 */
	_getPwElmsFromNewInp(data, form, form_type){
		var pwElms = form.find("input[name='password']");
		if(!pwElms[0]) return data;
		
		pwElms.each((i, e) => {
			var pwElm = jQuery(e);
			var ent = {
					'pwElm':pwElm,
					'pw_index':i,
					'form_type':form_type,
					};
			data.push(ent);
		});
		return data;
	}
	
	
	/**
	 * パスワード変更ボタン群を各パスワード要素の下に作成する
	 * @param array data
	 * @return data;
	 */
	_createPwChgbtns(data){
		
		for(var i in data){
			var ent = data[i];
			var form_type = ent.form_type;
			var pw_index = ent.pw_index;
			var pwElm = ent.pwElm;
			
			// 変更ボタン要素のHTMLを組み立て
			var xid = 'cbpe_' + form_type + pw_index;
			var html = `<input type="button" id="${xid}" value="パスワード変更" data-form-type="${form_type}" data-pw-index="${pw_index}" class="btn btn-warning btn-xs" />`;
			
			// パスワード要素の後ろに変更ボタン要素を追加
			pwElm.after(html);
			
			// 変更ボタン要素を取得する
			var btnElm = this._getBtnElm(form_type, pw_index);
			ent['btnElm'] = btnElm;
		}
		
		return data;
		
	}
	
	/**
	 * 変更ボタン要素を取得する
	 * @param string form_type フォーム種別
	 * @param int pw_index パスワード要素インデックス
	 * @return jQuery 変更ボタン要素
	 */
	_getBtnElm(form_type, pw_index){
		
		var form = null;
		if(form_type == 'new_inp') form = this.newInpForm;
		if(form_type == 'copy') form = this.newInpForm;
		if(form_type == 'edit') form = this.editForm;
		
		var xid = 'cbpe_' + form_type + pw_index;
		var btnElm = form.find('#' + xid);
		return btnElm;
	}
	
	
	/**
	 * 変更ボタンにクリックイベントをセットする
	 * @param array data
	 */
	_setClickEventToBtn(data){
		for(var i in data){
			var ent = data[i];
			var btnElm = ent.btnElm;
			btnElm.click( (evt)=>{
				this.clickPwChgbtn(this, evt.currentTarget);
			});
		}
	}
	
	/**
	 * 変更ボタンクリックイベント
	 */
	clickPwChgbtn(self, btnElm){
		var btnElm = jQuery(btnElm);
		
		var form_type = btnElm.attr('data-form-type');
		var pw_index = btnElm.attr('data-pw-index');
		
		var ent = this._getEntity(form_type, pw_index);
		if(ent == null) return;
		
		// パスワード要素には暗号化文字列が入力されているのでクリアしてから表示する。
		var pwElm = ent.pwElm;
		pwElm.val('');
		pwElm.show();
		
		// 変更ボタン要素を隠す
		var btnElm = ent.btnElm;
		btnElm.hide();

	}
	
	/**
	 * データからフォーム種別とパスワード要素インデックスを指定してエンティティを取得する。
	 */
	_getEntity(form_type, pw_index){
		
		for(var i in this.data){
			var ent = this.data[i];
			if(ent.form_type == form_type && ent.pw_index == pw_index){
				return ent;
			}
		}
		return null;
	}
	
	
	
	/**
	 * フォーム表示イベント
	 * @param form_type フォーム種別
	 */
	showForm(form_type){
		if(this.data.length == 0) return;
		
		if(form_type=='new_inp'){
			this._changeForNewInp(form_type); // 変更ボタンを隠し、パスワード要素を表示する
		}else{
			this._changeForEditAndCopy(form_type); // 変更ボタンを表示し、パスワード要素を隠す
		}
		
	}
	
	/**
	 * 変更ボタンを隠し、パスワード要素を表示する
	 */
	_changeForNewInp(form_type){
		
		for(var i in this.data){
			var ent = this.data[i];
			if(ent.form_type == form_type){
				
				// 変更ボタンを隠す
				var btnElm = ent.btnElm;
				btnElm.hide();
				
				// パスワードテキスト要素を表示する
				var pwElm = ent.pwElm;
				pwElm.show();
				
			}
		}
	}
	
	/**
	 * 変更ボタンを表示し、パスワード要素を隠す
	 */
	_changeForEditAndCopy(form_type){
		
		for(var i in this.data){
			var ent = this.data[i];

			// 変更ボタンを表示する。
			var btnElm = ent.btnElm;
			btnElm.show();
			
			// パスワードテキスト要素を隠す
			var pwElm = ent.pwElm;
			pwElm.hide();

		}
	}
	
}
/**
 * CrudBase用リアクティブ機能
 * 
 * @note
 * 行/エンティティ単位で要素をバインドすることができる。
 * 
 * @date 2018-12-6
 * @version 0.1.0
 * 
 */
class CrudBaseReact{
	
	
	/**
	 * コンストラクタ
	 * 
	 * @param param
	 * - flg
	 */
	constructor(param){
		

	}
	
	/**
	 * If Param property is empty, set a value.
	 */
	_setParamIfEmpty(param){
		
		if(param == null) param = {};

		
		return param;
	}
	
	/**
	 * 初期化
	 * @param array fields フィールド配列
	 * @param string hyo_elm_id 表要素ID   複数の表IDを指定するときはコンマで連結する
	 */
	init(fields, hyo_elm_id){
		
		this.fields = fields;
		
		// 表IDリストの取得とトリミング
		var hyoIds = hyo_elm_id.split(',');
		for(var i in hyoIds){
			var hyo_id = hyoIds[i];
			hyoIds[i] = hyo_id.trim();
		}
		this.hyoIds = hyoIds;
		
//		console.log(this.fields);//■■■□□□■■■□□□■■■□□□)
//		console.log(this.hyoIds);//■■■□□□■■■□□□■■■□□□)
	}
	
	/**
	 * 行のリアクティビング
	 * @note
	 * 各表の行/エンティティを同期する
	 */
	reactivatingOfRow(){
//		console.log('test=Ａ');//■■■□□□■■■□□□■■■□□□)
	}

}
/**
 * 
 * 行入替機能
 * 
 * @note
 * テーブルの行を入れ替えることによる並べ替え
 * 
 * @version 1.1 ExchangeTrから名称変更
 * @date 2017-3-7 | 2018-3-2
 * 
 */
class CrudBaseRowExchange{
	
	/**
	 * コンストラクタ
	 * @param crudBase CrudBaseオブジェクト
	 * @param param 当クラス専用パラメータ
	 * @param afterCallback 入替後に実行するコールバック関数
	 */
	constructor(crudBase,param,afterCallback){

		if(param == null) param = {};
		
		var tbl_slt = crudBase.param.tbl_slt;

		this.afterCallback = afterCallback; // 入替後コールバック
		
		this.tbl = crudBase.tbl; // HTMLテーブルのjQueryオブジェクト
		
		// テーブルセレクタからフォームセレクタを作成する
		var form_slt = "#exchange_tr_form_" + tbl_slt;
		param['form_slt'] = form_slt;
		
		// 行入替フォームのHTML文字列を取得する
		var formHtml = this._getFormHtml(form_slt);
		
		// テーブル要素の下に行入替フォームを追加、およびオブジェクトを取得
		this.tbl.after(formHtml);
		this.form = jQuery(form_slt); // 行入替のフォーム
		
		this.param = param;
		
		
		// 閉じるボタンのクリックイベント
		this.form.find('.exchange_tr_form_close').click( ()=>{
			this.form.hide();
		});
		
		// 行入替ボタンのクリックイベント
		this.form.find('.exchange_tr_btn').click( ()=>{
			this._exchageTrReb(); // 行入替
		});
		
		
		// 行入替フォームのinput系要素にEnterキーによるイベントを組み込む
		jQuery(form_slt + ' input').keypress( (e)=>{
			if(e.which==13){ // Enterキーである場合
				this._exchageTrReb(); // 行入替ボタンによる行入替処理
			}
		});
		
		// 上シフトボタンのクリックイベント
		this.form.find('.exchange_tr_shift_up').click( ()=>{
			this._exchageTrShiftUp(); // 上シフトボタンによる行入替処理
		});
		
		// 下シフトボタンのクリックイベント
		this.form.find('.exchange_tr_shift_down').click( ()=>{
			this._exchageTrShiftDown(); // 下シフトボタンによる行入替処理
		});
	}

	
	/**
	 * 行入替フォームを表示する
	 * @param btn 行内の入替ボタン要素
	 */
	showForm(btn){
		
		// 移動元インデックスを取得し、パラメータにセットする
		var btnElm = jQuery(btn);
		var trElm = btnElm.parents('tr');
		var from_row_index = trElm.index();
		from_row_index = from_row_index + 1;// 1からの数えにする。
		this.param['from_row_index'] = from_row_index;
		
		// 移動先テキストボックスが空であるなら、上記で取得した移動元インデックスを初期セットする。
		var sortNoElm = this.form.find('.exchange_tr_sort_no');
		var idx = sortNoElm.val();
		if(this._empty(idx)){
			sortNoElm.val(from_row_index);
		}

		// 行内入替ボタンの下に行入替フォームを表示する
		this._showForm(this.form,btnElm);
	}
	
	
	
	
	/**
	 * 行入替ボタンによる行入替処理
	 */
	_exchageTrReb(){
		
		// 移動元行インデックスを取得する
		var from_row_index = this.param['from_row_index'];
		
		// 移動先行インデックスを取得する
		var to_row_index = this.form.find('.exchange_tr_sort_no').val();

		// 行インデックスをチェックし、不正があれば、処理中断
		if(this._checkRowIndex(to_row_index)==false){
			return;
		}
		
		// 移動元と移動先が同じなら処理中断
		if(from_row_index == to_row_index){
			return;
		}

		// 行入替
		this._exchageTr(from_row_index,to_row_index);
		
	}
	
	/**
	 * 上シフトボタンによる行入替処理
	 */
	_exchageTrShiftUp(){
		// 移動元行インデックスを取得する
		var from_row_index = this.param['from_row_index'];
		
		// 移動先行インデックスを取得する
		var to_row_index = from_row_index - 1;
		
		// 移動先行番が0以下なら上シフト処理を中断する
		if(to_row_index <= 0){
			return;
		}
		
		// 行入替
		this._exchageTr(from_row_index,to_row_index);
		
		// 連続して上シフトボタンを押した時のために、移動先を移動元として保存しておく
		this.param['from_row_index'] = to_row_index;
	}
	
	/**
	 * 下シフトボタンによる行入替処理
	 */
	_exchageTrShiftDown(){
		// 移動元行インデックスを取得する
		var from_row_index = this.param['from_row_index'];
		
		// 移動先行インデックスを取得する
		var to_row_index = from_row_index + 1;
		
		// テーブルの行数を取得する
		var tBody = this.tbl.children('tbody');
		var rowCnt = tBody.children('tr').length;// テーブル行数
		
		// 移動先行番が行数を超えるなら下シフト処理を中断する
		if(to_row_index > rowCnt){
			return;
		}
		
		// 行入替
		this._exchageTr(from_row_index,to_row_index);
		
		// 連続して上シフトボタンを押した時のために、移動先を移動元として保存しておく
		this.param['from_row_index'] = to_row_index;
	}
	
	/**
	 * ★ 行入替
	 * @param from_row_index 移動元行インデックス
	 * @param to_row_index 移動先行インデックス
	 */
	_exchageTr(from_row_index,to_row_index){
		// 移動元と移動先のTR要素を取得する
		var tr1 = this.tbl.find('tr').eq(from_row_index);
		var tr2 = this.tbl.find('tr').eq(to_row_index);
		
		// 移動元と移動先のTR要素を入れ替える
		if(from_row_index > to_row_index){
			jQuery(tr2).before(tr1);
			
		}else{
			jQuery(tr2).after(tr1);
			
		}
		
		// コールバックが設定されていれば、コールバックを実行する
		if(this.afterCallback){
			this.afterCallback({
				'from_row_index':from_row_index,
				'to_row_index':to_row_index
			});
		}
	}
	
	
	
	
	/**
	 * 行インデックスをチェックする
	 * @param row_index 行インデックス
	 * @returns {Boolean} true:はい  false:いいえ
	 */
	_checkRowIndex(row_index) {
		
		if(row_index == undefined){
			return false;
		}
		

		if(!row_index.match(/^[0-9]*$/)){
			return false;
		}
		
		if(row_index <= 0){
			return false;
		}
	
		return true;
	
	}
	
	
	
	
	
	
	
	
	/**
	 * 行入替フォームを表示する
	 * 
	 * @param object form フォーム要素オブジェクト
	 * @param string triggerElm トリガー要素  ボタンなど
	 */
	_showForm(form,triggerElm,form_position){
		
		if(!form_position){
			form_position = 'auto';
		}
		
		form.show();
		
		//トリガー要素の右上位置を取得
		triggerElm = jQuery(triggerElm);
		var offset=triggerElm.offset();
		var left = offset.left;
		var top = offset.top;
		
		var ww = jQuery(window).width();// Windowの横幅（ブラウザの横幅）
		var form_width = form.outerWidth();// フォームの横幅
		
		// フォーム位置Yをセット
		var trigger_height = triggerElm.outerHeight();
		var tt_top=top + trigger_height;
		
		var tt_left=0;// フォーム位置X
		
		// フォーム位置の種類毎にフォーム位置Xを算出する。
		switch (form_position) {
		
		case 'left':
			
			// トリガーの左側にフォームを表示する。
			tt_left=left - form_width;
			break;
			
		case 'center':

			// フォームを中央にする。
			tt_left=(ww / 2) - (form_width / 2);
			break;
			
		case 'right':
			
			// トリガーの右側にフォームを表示する
			tt_left=left;
			break;
			

		default:// auto

			// 基本的にトリガーの右側にフォームを表示する。
			// ただし、トリガーが右端付近にある場合、フォームは外側にでないよう左側へ寄せる。
			
			tt_left=left;
			if(tt_left + form_width > ww){
				tt_left = ww - form_width;
			}
			
			break;
		}

		if(tt_left < 0){
			tt_left = 0;
		}

		//フォーム要素に位置をセット
		form.offset({'top':tt_top,'left':tt_left });
	}
	
	
	/**
	 * 行入替フォームのHTML文字列を取得する
	 * @param form_slt フォーム要素のセレクタ
	 * @returns 行入替フォームのHTML
	 */
	_getFormHtml(form_slt){
		
		var xid = this._sltToCode(form_slt);// セレクタから識別子「#」「.」を取り外したコードを取得する
		
		var html = 
			"<div id='" + xid +"_rap'>" +
			"	<div id='" + xid +"' class='panel panel-primary' style='display:none;width:170px;'>" +
			"		<div class='panel-heading'>" +
			"			" +
			"			<div style='display:inline-block;width:80%'>行入替</div>" +
			"			<div style='display:inline-block;width:15%'>" +
			"				<button type='button' class='exchange_tr_form_close btn btn-primary btn-sm'>" +
			"					<span class='glyphicon glyphicon-remove'></span>" +
			"				</button>" +
			"			</div>" +
			"		</div>" +
			"		<div class='panel-body' \">" +
			"			<button type='button' class='exchange_tr_shift_up btn btn-primary btn-sm'><span class='glyphicon glyphicon-arrow-up'></span></button>" +
			"			<button type='button' class='exchange_tr_shift_down btn btn-primary btn-sm'><span class='glyphicon glyphicon-arrow-down'></span></button>" +
			"			<div style='margin-top:20px'>" +
			"				<input class='exchange_tr_sort_no' type='number' style='width:60px' min='1' max='9999'  />" +
			"				<input type='button' value='行入替' class='exchange_tr_btn btn btn-warning btn-sm' />" +
			"			</div>" +
			"		</div>" +
			"	</div>" +
			"</div>";
		
		return html;
	}
	
	
	/**
	 * セレクタから識別子「#」「.」を取り外したコードを取得する
	 * 
	 * @note
	 * セレクタに空文字を指定すると空を返す。ただしnullを指定した場合はエラーになる。
	 * 
	 * @param slt セレクタ
	 * @returns コード
	 */
	_sltToCode(slt){
		
		var code = slt;
		var s1 = code.charAt(0); // 先頭の一文字を取得
		if(s1=='#' || s1=='.'){
			code = code.substr(1);
		}
		return code;
	}
	
	
	
	
	// 空判定
	_empty(v){
		if(v == null || v == '' || v=='0'){
			return true;
		}else{
			if(typeof v == 'object'){
				if(Object.keys(v).length == 0){
					return true;
				}
			}
			return false;
		}
	}
	
	

}
/**
 * カレンダー日付ピッカー・ラッパーコンポーネント
 * 
 * @note
 * カレンダーピッカー関連ライブラリをまとめたコンポーネントクラス。
 * カレンダーピッカーを組み込みたい要素のclass属性にdatepicker,datetimepicker,ympickerを
 * 記述するとそれぞれの特徴をもったカレンダーが組み込まれる。
 * 
 * class属性とカレンダーピッカーの種類
 * 		datepicker 日付ピッカー
 * 		datetimepicker 日時ピッカー（※処理が重いため非推奨）
 * 		ympicker 年月ピッカー
 * 
 * 依存ライブラリ
 * 		jquery-ui.min.js
 * 		jquery.ui.ympicker.js
 * 		jquery.datetimepicker.full.min.js
 * 
 * @version 2.0.1
 * @date 2015-7-1 | 2019-1-25
 * @history
 * 2018-10-09 v2.0.0 YmpickerWrapからDatepickerWrapに名称変更
 * 2015-09-17 バグ修正
 * 2015-07-01 新規作成
 * 
 */
class DatepickerWrap{
	
	
	/**
	 * コンストラクタ
	 * 
	 * @param param
	 * - ja_flg 0:日本語化しない , 1:日本語化する（デフォルト）
	 * - datetimepicker_f 日時ピッカー機能フラグ 0:無効(デフォルト) , 1:有効
	 */
	constructor(param){

		if(jQuery.datepicker == null) return;
		
		this.param = this._setParamIfEmpty(param);
		
		// カレンダーを日本語化する
		if(param['ja_flg'] == 1) this.datepicker_ja();
		
		this._datepickerApply(); // datepickerを適用
		this._datetimepickerApply(); // datetimepickerを適用
		this._ympickerApply(); // ympickerを適用
		
		
		
	}
	
	/**
	 * If Param property is empty, set a value.
	 */
	_setParamIfEmpty(param){
		
		if(param == null) param = {};
		
		if(param['ja_flg'] == null) param['ja_flg'] = 1; 
		if(param['datetimepicker_f'] == null) param['datetimepicker_f'] = 0; 
		
		return param;
	}
	
	
	/**
	 * datepickerを適用
	 * 
	 * @note
	 * class属性に「datepicker」が記述されているすべての要素にdatepickerを適用
	 */
	_datepickerApply(){
		
		jQuery('.datepicker').each((i,elm) => {
			jQuery(elm).datepicker({dateFormat:'yy-mm-dd'});
		});
	}
	
	
	/**
	 * datetimepickerを適用
	 * 
	 * @note
	 * class属性に「datetimepicker」が記述されているすべての要素にdatetimepickerを適用
	 */
	_datetimepickerApply(){
		if(this.param.datetimepicker_f == 0) return;
		
		jQuery('.datetimepicker').each((i,elm) => {
			jQuery(elm).datetimepicker({dateFormat:'Y-m-d H:i'});
		});
	}
	
	
	/**
	 * ympickerを適用
	 * 
	 * @note
	 * class属性に「ympicker」が記述されているすべての要素にympickerを適用
	 */
	_ympickerApply(){
		//年月入力
		var op = {
			closeText: '閉じる',
			prevText: '&#x3c;前',
			nextText: '次&#x3e;',
			currentText: '今日',
			monthNames: ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'],
			monthNamesShort: ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'],
			dateFormat: 'yy/mm',
			yearSuffix: '年',
			onSelect:function(date, instance) {
			}
		};
		
		jQuery('.ympicker').each((i,elm) => {
			jQuery(elm).ympicker(op);
		});
	}
	
	
	
	/**
	 * 年月ダイアログを作成する関数
	 * 
	 * jquery.ui.ympicker.jsを拡張しています。
	 * 年月選択により月初日、月末日らのテキストボックスと連動できるようになっています。
	 *
	 * @param tb_ym_id 年月テキストボックスのID
	 * @param tb_m_start_id 月初日テキストボックスのID
	 * @param tb_m_ent_id 月末日テキストボックスのID
	 *
	 */
	tukishomatu(tb_ym_id,tb_m_start_id,tb_m_ent_id){

		//年月入力
		var op = {
			closeText: '閉じる',
			prevText: '&#x3c;前',
			nextText: '次&#x3e;',
			currentText: '今日',
			monthNames: ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'],
			monthNamesShort: ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'],
			dateFormat: 'yy/mm',
			yearSuffix: '年',
			onSelect:function(date, instance) {

				//月初日の作成と出力
				var d1=date + '/1';
				$('#' + tb_m_start_id).val(d1);

				//月末日の算出と出力
				var dt=new Date(d1);
				var last_d=new Date(dt.getFullYear(), dt.getMonth() + 1, 0);
				var last_d=DateFormat(last_d, 'yyyy/mm/dd'); // 01月23日
				$('#' + tb_m_ent_id).val(last_d);

			}
		};

		//年月ダイアログを適用
		$('#' + tb_ym_id).ympicker(op);


		//年月をクリアしたら月初、月末もクリアする。
		$('#' + tb_ym_id).blur(function () {
			var v = $('#' + tb_ym_id).val();
			if(v =='' || v==null){
				$('#' + tb_m_start_id).val('');
				$('#' + tb_m_ent_id).val('');
			}
		});

	}
	
	
	
	/**
	 * jQuery UIカレンダーを日本語化する
	 */
	datepicker_ja(){
		
		jQuery.datepicker.regional['ja'] = {
				closeText: '閉じる',
				prevText: '<前',
				nextText: '次>',
				currentText: '今日',
				monthNames: ['1月','2月','3月','4月','5月','6月',
				'7月','8月','9月','10月','11月','12月'],
				monthNamesShort: ['1月','2月','3月','4月','5月','6月',
				'7月','8月','9月','10月','11月','12月'],
				dayNames: ['日曜日','月曜日','火曜日','水曜日','木曜日','金曜日','土曜日'],
				dayNamesShort: ['日','月','火','水','木','金','土'],
				dayNamesMin: ['日','月','火','水','木','金','土'],
				weekHeader: '週',
				dateFormat: 'yy/mm/dd',
				firstDay: 0,
				isRTL: false,
				showMonthAfterYear: true,
				yearSuffix: '年'};
			jQuery.datepicker.setDefaults(jQuery.datepicker.regional['ja']);
	}
	
	
	
	
	
	
	
	
	
	
	
	
	
}


	/**
	 * 日付オブジェクトから文字列に変換します
	 * 
	 * @param date 対象の日付オブジェクト
	 * @param format フォーマット
	 * @return フォーマット後の文字列
	 * @date 2012/06/10 新規作成
	 */
	function DateFormat(date, format){

		var result = format;

		var f;
		var rep;

		var yobi = new Array('日', '月', '火', '水', '木', '金', '土');

		f = 'yyyy';
		if ( result.indexOf(f) > -1 ) {
			rep = date.getFullYear();
			result = result.replace(/yyyy/, rep);
		}

		f = 'mm';
		if ( result.indexOf(f) > -1 ) {
			rep = PadZero(date.getMonth() + 1, 2);
			result = result.replace(/mm/, rep);
		}

		f = 'ddd';
		if ( result.indexOf(f) > -1 ) {
			rep = yobi[date.getDay()];
			result = result.replace(/ddd/, rep);
		}

		f = 'dd';
		if ( result.indexOf(f) > -1 ) {
			rep = PadZero(date.getDate(), 2);
			result = result.replace(/dd/, rep);
		}

		f = 'hh';
		if ( result.indexOf(f) > -1 ) {
			rep = PadZero(date.getHours(), 2);
			result = result.replace(/hh/, rep);
		}

		f = 'ii';
		if ( result.indexOf(f) > -1 ) {
			rep = PadZero(date.getMinutes(), 2);
			result = result.replace(/ii/, rep);
		}

		f = 'ss';
		if ( result.indexOf(f) > -1 ) {
			rep = PadZero(date.getSeconds(), 2);
			result = result.replace(/ss/, rep);
		}

		f = 'fff';
		if ( result.indexOf(f) > -1 ) {
			rep = PadZero(date.getMilliseconds(), 3);
			result = result.replace(/fff/, rep);
		}

		return result;

	}


	/**
	 * 文字列から日付オブジェクトに変換します
	 * 
	 * @param date 対象の日付オブジェクト
	 * @param format フォーマット
	 * @return 変換後の日付オブジェクト
	 * 
	 * @date 2012/06/10 新規作成
	 */
	function DateParse(date, format){

		var year = '1990';
		var month = '01';
		var day = '01';
		var hour = '00';
		var minute = '00';
		var second = '00';
		var millisecond = '000';

		var f;
		var idx;

		f = 'yyyy';
		idx = format.indexOf(f);
		if ( idx > -1 ) {
			year = date.substr(idx, f.length);
		}

		f = 'MM';
		idx = format.indexOf(f);
		if ( idx > -1 ) {
			month = parseInt(date.substr(idx, f.length), 10) - 1;
		}

		f = 'dd';
		idx = format.indexOf(f);
		if ( idx > -1 ) {
			day = date.substr(idx, f.length);
		}

		f = 'HH';
		idx = format.indexOf(f);
		if ( idx > -1 ) {
			hour = date.substr(idx, f.length);
		}

		f = 'mm';
		idx = format.indexOf(f);
		if ( idx > -1 ) {
			minute = date.substr(idx, f.length);
		}

		f = 'ss';
		idx = format.indexOf(f);
		if ( idx > -1 ) {
			second = date.substr(idx, f.length);
		}

		f = 'fff';
		idx = format.indexOf(f);
		if ( idx > -1 ) {
			millisecond = date.substr(idx, f.length);
		}

		var result = new Date(year, month, day, hour, minute, second, millisecond);

		return result;

	}


	/**
	 * ゼロパディングを行います
	 * @param value	対象の文字列
	 * @param length	長さ
	 * @return 結果文字列
	 * 
	 */
	function PadZero(value, length){
	    return new Array(length - ('' + value).length + 1).join('0') + value;
	}



/**
 * ファイルアップロードの拡張クラス
 * 
 * @note
 * DnD（ドラッグ&ドロップに対応。
 * アップロード区分のドレスアップ。
 * エンティティなどのデータも一緒に送信。
 * 複数のファイルをアップロードできる。
 * 複数のファイルアップロード要素に対応。
 * 進捗バーの表示
 * ファイルの初期表示
 * 
 * @license MIT
 * @version 1.2.6
 * @date 2018-7-6 | 2018-10-2
 * @history 
 *  - 2018-10-2 var 1.2.6 「Now Loading...」メッセージを表示する
 *  - 2018-9-18 var 1.2.5 コールバックパラメータを追加（pacb_param)
 *  - 2018-9-18 var 1.2.4 fuk_preview要素のstyle属性を修正
 *  - 2018-9-18 var 1.2.3 クリアのバグを修正
 *  - 2018-8-27 ver 1.2.2 setFilePaths:ファイル名空に対応
 *  - 2018-8-14 ver 1.2.0 ファイルの初期表示
 *  - 2018-8-11 ver 1.1
 *  - 2018-8-7 リリース
 *  - 2018-7-6 新規作成
 * 
 */
class FileUploadK{
	
	
	/**
	 * コンストラクタ
	 * 
	 * @param param
	 * - ajax_url 通信先URL
	 * - style_flg 専用スタイルフラグ デフォルトON
	 * - unit_slt まとまり要素のセレクタ  省略時はbody
	 * - prog_slt 進捗バー要素のセレクタ
	 * - err_slt  エラー要素のセレクタ
	 * - fuk_msg_text 初期メッセージテキスト
	 * - img_width プレビュー画像サイスX　（画像ファイルのみ影響）
	 * - img_height プレビュー画像サイスY
	 * - adf    補足データフラグリスト (Ancillary Data Flgs)
	 *     - fn_flg ファイル名・表示フラグ (デフォ:1 以下同じ)
	 *     - size_flg 容量・表示フラグ
	 *     - mime_flg MIME・表示フラグ
	 *     - modified 更新日時・表示フラグ
	 * - valid_ext バリデーション拡張子
	 *      指定方法
	 *          グループ指定： audio,image
	 *          拡張子単体指定: jpg
	 *          拡張子配列指定: array('jpg','png')
	 *          拡張子コンマ連結: 'jpg,png,gif'
	 * - valid_mime_flg バリデーションMIMEフラグ 0:バリデーション行わない(デフォ) , 1:バリデーションを行う
	 */
	constructor(param){
		
		this.active_fue_id;// ファイルアップロード要素のid属性(イベント中）
		
		this.box = {}; // データボックス   ファイル要素、ファイルオブジェクト、各種パラメータを格納
		
		this.mimeMap = this._getMimeMapping(); // MIMEマッピングデータ
		
		this.param = this._setParamIfEmpty(param);
		
		this.unit = jQuery(this.param.unit_slt);
		
		this.cbAsynsEnd; // 複数非同期・全終了後コールバック・データ
		
	}

	
	/**
	 * If Param property is empty, set a value.
	 */
	_setParamIfEmpty(param){
		
		if(param == null) param = {};
		
		if(param['ajax_url'] == null) param['ajax_url'] = null;
		
		if(param['style_flg'] == null) param['style_flg'] = 1;
		
		if(param['unit_slt'] == null) param['unit_slt'] = 'body';
		
		if(param['err_slt'] == null) param['err_slt'] = '#err';
		
		if(param['fuk_msg_text'] == null) param['fuk_msg_text'] = '';
		
		if(param['valid_mime_flg'] == null) param['valid_mime_flg'] = 0;
		
		if(param['img_width'] == null) param['img_width'] = null;
		if(param['img_height'] == null) param['img_height'] = null;
		
		// 補足データフラグリスト
		if(param['adf'] == null){
			param['adf'] = {
					'fn_flg':1,
					'size_flg':1,
					'mime_flg':1,
					'modified_flg':1,
			};
		}
		
		// バリデーション情報を作成する。
		var valid_ext = null;
		if(param['valid_ext'] != null) valid_ext = param['valid_ext'];
		param['validData'] = this._createValidData(valid_ext);

		return param;
	}
	
	
	
	/**
	 * ファイルアップロード関連のイベントを追加する。
	 * 
	 * @note
	 * ファイルチェンジイベントの追加。
	 * DnDイベントの追加
	 * 
	 * @param fue_id ファイルアップロード要素のid属性
	 * @param option 
	 *  - valid_ext バリデーション拡張子(詳細はconstructor()の引数を参照）
	 *  - pacb プレビュー後コールバック関数
	 *  - pacb_param pacbに渡すパラメータ
	 *  - img_width プレビュー画像サイスX　（画像ファイルのみ影響）
	 *  - img_height プレビュー画像サイスY
	 */
	addEvent(fue_id,option){
		
		if(option == null) option = {};
		
		// ファイルアップロード要素の親ラベル（DnD要素）を取得する
		var parLabel = this._getElement(fue_id,'label');
		
		// 親ラベル要素にfue_idを属性として追加する。
		parLabel.attr('data-fue-id',fue_id);
		
		// 各要素から値を取ってきて、データボックスに格納する。
		var box = this._setToBox(fue_id,this.box,option);
		
		// 親ラベル要素にいくつかの関連要素を追加する。
		this._addRelatedElements(parLabel,fue_id,box);
		
		// 関連要素にCSSスタイルを適用する
		this._applyStyle(fue_id);
		
		// DnDイベントをラッパー要素に追加
		parLabel[0].addEventListener('drop',(evt) => {
			evt.stopPropagation();
			evt.preventDefault();

			// ボックスデータにアップロードファイル情報を追加
			var files = evt.dataTransfer.files; 
			this.box[fue_id]['files'] = files;
			this._preview(fue_id,'files',option); // プレビュー表示
			
		},false);
		// ドラッグオーバーイベントを発動させないようにする。
		parLabel[0].addEventListener('dragover',(evt) => {
			evt.preventDefault();
		},false);
		
		// ファイルアップロード要素のチェンジイベントを追加する。
		var fue = this._getElement(fue_id,'fue');
		fue.change((e) => {

			// ボックスデータにアップロードファイル情報を追加
			var files = e.target.files; // ファイルオブジェクト配列を取得（配列要素数は選択したファイル数を表す）
			if(files == null || files.length == 0) return;// ファイル件数が0件なら処理抜け
			this.box[fue_id]['files'] = files;
			this._preview(fue_id,'files',option); // プレビュー表示
			
		});
		
		// クリアボタンにイベントを実装する
		var clearBtn = this._getElement(fue_id,'clear_btn');
		clearBtn.click((e) => {
			this._clearBtnClick(e);
		});
	}
	
	
	/**
	 * file要素にファイルパスをセットする
	 * @param string fue_id file要素のid
	 * @param array fps ファイルパスリスト（ ファイル名一つを文字列指定可）
	 * @param object option addEventのoptionと同じ
	 */
	setFilePaths(fue_id,fps,option){

		if(option == null) option = {};
		
		this._clearBtnAction(fue_id); // クリアボタンアクション
		
		if(fps == null || fps == '' || fps == 0) return;
		if(typeof fps == 'string') fps = [fps];
		
		var fukMsg = this._getElement(fue_id,'fuk_msg');
		fukMsg.html('Now Loading ..');
		
		var bData = [];
		option['pacb'] = () => {
			//複数非同期・全終了後コールバック
			// プレビュー表示
			this.box[fue_id]['bData'] = bData;
			this._preview(fue_id,'blob',option);
		}
		
		// 複数非同期・全終了後コールバック・初期化
		this._cbAsynsEndInit(fps.length,option);

		// ファイルをXHRでプリロードする
		for(var i in fps){
			var fp = fps[i];
			this._preloadByXhr(fp,bData);
		}
	}
	
	
	
	/**
	 * XHRによってファイルをプリロードする Preloaded by XHR
	 * @param string fp ファイルパス
	 * @param array bData BLOB関連データ
	 */
	_preloadByXhr(fp,bData){
		var xhr = new XMLHttpRequest();
		xhr.open('GET', fp, true);
		xhr.responseType = 'blob';
		xhr.onload = (e) => {

			// プリロードのonloadイベント処理： ファイル関連情報をbDataにセットする。
			this._xhrOnload(e,xhr,bData);

		};
		xhr.send();
	}
	
	/**
	 * プリロードのonloadイベント処理： ファイル関連情報をbDataにセットする。
	 * @param object e onloadイベント
	 * @param XMLHttpRequest xhr
	 * @param array bData BLOB関連データ
	 */
	_xhrOnload(e,xhr,bData){
		// Blobを取得する
		var blob = e.target.response;
		
		var r_url = e.target.responseURL;
		var fn = this._stringRightRev(r_url,'/');

		var mime_type = xhr.getResponseHeader("Content-Type");
		var size = xhr.getResponseHeader("Content-Length");
		var server = xhr.getResponseHeader("server");
		var modified = xhr.getResponseHeader("Last-Modified");
		
		
		var bEnt = {
				'fn':fn,
				'mime_type':mime_type,
				'size':size,
				'modified':modified,
				'blob':blob
		};
		
		
		bData.push(bEnt);

		// 複数非同期・全終了後コールバック・アクション
		this._cbAsynsEndAction('exe1');
	}
	
	
	/**
	 * 親ラベル要素にいくつかの関連要素を追加する。
	 * @param jQuery parLabel 親ラベル要素
	 * @param int fue_id FU要素ID
	 * @param object box データボックス
	 */
	_addRelatedElements(parLabel,fue_id,box){
		
		var html = '';
		
		// 初期メッセージ要素を追加
		var fuk_msg_text = box[fue_id]['fuk_msg_text']; // 初期メッセージテキスト
		html += "<span class='fuk_msg'>" + fuk_msg_text +"</span>";
		
		// プレビュー要素を追加
		html += "<span class='fuk_preview' style='display:inline-block'></span>";
		
		// クリアボタン用を追加
		html += "<div class='fuk_clear_btn_w'><input type='button' value='Clear' class='btn btn-default btn-xs fuk_clear_btn' " +
				"data-fue-id='" + fue_id + "' /></div>";
		
		parLabel.append(html);
		
	}
	
	
	/**
	 * 関連要素にCSSスタイルを適用する
	 * 
	 * @param int fue_id FU要素ID
	 */
	_applyStyle(fue_id){
		if(!(this.param.style_flg)) return;
		
		var parLabel = this._getElement(fue_id,'label'); // 親ラベル要素
		parLabel.addClass('fuk'); // CSSスタイルの適用
		
	}
	
	
	/**
	 * プレビュー表示
	 * @param string fue_id ファイルアップロード要素のid属性
	 * @param bin_type 'files' or 'blob'
	 * @param object option オプション（addEventメソッドの引数と同じ）
	 *  -  BLOBフラグ ファイル初期表示から呼び出し時はtrue
	 */
	_preview(fue_id,bin_type,option){

		var fukMsg = this._getElement(fue_id,'fuk_msg');
		fukMsg.html('Now Loading ...');

		this.active_fue_id = fue_id;
		
		var files = null;
		var bData = null;
		var fileData = [];
		if(bin_type == 'files'){

			// filesからファイル名などのファイルデータを取得する
			var files = this.box[fue_id]['files'];
			fileData = this._getFileDataFromFiles(files);
			
		}else if(bin_type == 'blob'){
			
			// BLOBの関連データからファイルデータを取得する
			bData = this.box[fue_id]['bData'];
			fileData = this._getFileDataFromBData(bData);
		}else{
			throw new Error("Unknown 'bin_type'");
		}
		
		if(this._checkFnsEmpty(fileData)) return; // ファイルデータ中のファイル名がすべて空であるなら中断。
		
		// 親ラベル要素を内部要素に合わせてフィットさせるため幅をautoにする。
		var parLbl = this._getElement(fue_id,'label');
		parLbl.css({'width':'auto','height':'auto'});

		// クリアボタンを表示する
		var clearBtnW = this._getElement(fue_id,'clear_btn_w');
		clearBtnW.show();
		
		// バリデーション確認
		fileData = this._validCheck(fue_id,fileData); 
		this.box[fue_id]['fileData'] = fileData;
		
		
		var preview_html = ''; // プレビューHTML
		
		// ファイルユニットHTMLを作成して、プレビューHTMLに連結する。
		for(var i in fileData){
			var fEnt = fileData[i];
			preview_html += this._makeFileUnitHtml(fue_id,fEnt,option); 
		}
		
		// プレビュー区分要素にプレビューHTMLをセットする。
		var prvElm = this._getElement(fue_id,'preview');
		if(prvElm[0]) prvElm.html(preview_html);
		
		// リソースプレビュー要素を取得する。リソースプレビュー要素はプレビュー区分要素内に複数存在するDIV要素群のこと。
		var rpElms = {}; // リソースプレビュー要素リスト
		prvElm.children('div').each((i,elm)=>{
			elm = jQuery(elm);
			var rpElm = elm.find('.fuk_rp');
			if(rpElm[0]){
				rpElms[i] = rpElm;
				
			}else{
				rpElms[i] = null;
			}
		});
		
		// ファイルデータのフィルタリング：0サイズとバリデーションエラーのエンティティを取り除く。
		fileData = this._filteringFileData(fileData,rpElms);
		
		if(bin_type == 'files'){
		
			// プレビュー後コールバックアクションの初期化
			this._cbAsynsEndInit(fileData.length,option);
		
			// リソース（画像など）をリソースプレビュー要素に表示させる。（非同期処理あり）
			for(var i in fileData){
	
				var fEnt = fileData[i];
				var index = fEnt.index;
				var file = files[index];
				
				// リソース（ファイル）のレンダリングを行い、リソースプレビュー要素に画像などを表示する。
				this._setupRender(file,rpElms,index);
	
			}
			
			this._cbAsynsEndAction('exe2'); // プレビュー後コールバックアクション：制御と実行2
		
		}else if(bin_type == 'blob'){
			
			// リソース（画像など）をリソースプレビュー要素に表示させる。
			for(var i in fileData){
	
				var fEnt = fileData[i];
				var index = fEnt.index;
				var blob = bData[index]['blob'];
				var blob_url = window.URL.createObjectURL(blob);
				var rpElm = rpElms[index];
				rpElm.attr('src',blob_url);
	
			}
			
			this._cbAsynsEndAction('exe2'); // プレビュー後コールバックアクション：制御と実行2
		}
	}
	
	/**
	 * ファイルデータ中のファイル名がすべて空であるか？
	 * @reutrn false:空でないファイル名が存在 , true:すべてのファイル名が空である
	 */
	_checkFnsEmpty(fileData){
		
		for(var i in fileData){
			var fEnt = fileData[i];
			if(fEnt.fn){
				return false; // false:空でないファイル名が存在
			}
		}
		
		return true; //  true:すべてのファイル名が空である
		
	}
	
	
	/**
	 * ファイルデータのフィルタリング：0サイズとバリデーションエラーのエンティティを取り除く。
	 * @param array fileData ファイルデータ
	 * @param array rpElms リソースプレビュー要素リスト
	 * @return array フィルタリング後のファイルデータ
	 */
	_filteringFileData(fileData,rpElms){
		var fileData2 = [];
		
		for(var i in fileData){
			if(rpElms[i]==null) continue;
			var fEnt = fileData[i];

			if(fEnt.err_flg == true) continue;
			if(fEnt.size == null || fEnt.size == 0) continue;
			
			fEnt['index'] = i;
			
			fileData2.push(fEnt);

		}
		
		return fileData2;
	}
	
	
	/**
	 * リソース（ファイル）のレンダリングを行い、リソースプレビュー要素に画像などを表示する。
	 * @param object file ファイルデータ
	 * @param array rpElms リソースプレビュー要素群
	 * @param int i インデックス
	 */
	_setupRender(file,rpElms,i){
		var reader = new FileReader();
		reader.readAsDataURL(file);
		
		// After conversion of the event.
		reader.onload = (evt) => {

			var rpElm = rpElms[i];
			rpElm.attr('src',reader.result);
			
			this._cbAsynsEndAction('exe1'); // プレビュー後コールバックアクション：制御と実行1
		}
	}
	
	
	/**
	 * filesからファイル名などのファイルデータを取得する
	 * 
	 * @note
	 * サイズ0のファイルデータは取得しない。
	 * 
	 * @param array アップロードファイルリスト
	 * @return array ファイルデータ
	 */
	_getFileDataFromFiles(files){
		
		var fileData = []; // ファイルデータ
		
		for(var i in files){
			var file = files[i];
			if(file.size == null) continue;
			var fEnt = {};
			
			// MIME
			var mime = file.type; 
			fEnt['mime'] = mime;
			
			// MIMEからファイル種別を判別する。
			var file_type = '';
			if(mime != null){
				if(mime.indexOf('image') >= 0) file_type = 'image';
				if(mime.indexOf('audio') >= 0) file_type = 'audio';
			}
			fEnt['file_type'] = file_type;
			
			// ファイル名
			var fn = ''; 
			if(file.name != null) fn = file.name;
			fEnt['fn'] = fn;
			
			// サイズ
			fEnt['size'] = file.size;
			
			// 単位表示付きサイズ
			var size_str = 0; // サイズ（ファイル容量）
			if(file.size != null) size_str = file.size;
			if(!isNaN(size_str)){
				size_str = this._convSizeUnit(size_str); // 単位付き表示に変換
			}
			fEnt['size_str'] = size_str;
			
			// 更新日
			var modified = ''; 
			if(file.lastModifiedDate != null){
				modified = file.lastModifiedDate.toLocaleString();
			}
			fEnt['modified'] = modified;
			
			fileData.push(fEnt);

		}
		
		return fileData;
		
	}
	
	
	/**
	 * bDataからファイル名などのファイルデータを取得する
	 * 
	 * @note
	 * サイズ0のファイルデータは取得しない。
	 * 
	 * @param array アップロードファイルリスト
	 * @return array ファイルデータ
	 */
	_getFileDataFromBData(bData){
		
		var fileData = []; // ファイルデータ
		
		for(var i in bData){
			var bEnt = bData[i];
			if(bEnt.size == null || bEnt == 0) continue;
			var fEnt = {};
			
			// MIME
			fEnt['mime'] = bEnt.mime_type;
			
			// MIMEからファイル種別を判別する。
			var file_type = '';
			if(fEnt.mime != null){
				if(fEnt.mime.indexOf('image') >= 0) file_type = 'image';
				if(fEnt.mime.indexOf('audio') >= 0) file_type = 'audio';
			}
			fEnt['file_type'] = file_type;
			
			// ファイル名
			fEnt['fn'] = bEnt.fn;
			
			// サイズ
			fEnt['size'] = bEnt.size;
			
			// 単位表示付きサイズ
			var size_str = 0; // サイズ（ファイル容量）
			if(bEnt.size != null) size_str = bEnt.size;
			if(!isNaN(size_str)){
				size_str = this._convSizeUnit(size_str); // 単位付き表示に変換
			}
			fEnt['size_str'] = size_str;
			
			// 更新日
			var modified = ''; 
			if(bEnt.modified != null){
				modified = new Date(modified).toLocaleString();
			}
			fEnt['modified'] = modified;
			
			fileData.push(fEnt);

		}
		
		return fileData;
		
	}
	
	/**
	 * バリデーション確認
	 * @param string fue_id ファイルアプロード要素のID属性値
	 * @param array fileData ファイルデータ
	 * @return array エラーフラグをセットしたファイルデータ
	 */
	_validCheck(fue_id,fileData){

		if(fue_id == null) return fileData;
		
		var validData = this.box[fue_id]['validData']; // バリデーションデータ
		var validExts = validData.validExts; // バリデーション拡張子リスト

		// バリデーション実行フラグ
		var valid_flg = true;
		if(validExts == null || validExts == 0) valid_flg = false;

		for(var i in fileData){
			var fEnt = fileData[i];
			
			// バリデーション実行フラグがOFFならチェックをしない。
			if(valid_flg == false){
				fEnt['err_flg'] = false;
				continue;
			}
			
			var fn = fEnt.fn;
			
			// ファイル名が空である場合
			if(fn == '' || fn == null){
				fEnt['err_flg'] = true;
				fEnt['err_msg'] = 'ファイル名が空です。';
				fEnt['fn_empty'] = true;
				continue;
			}
			
			var ext = this._getExtension(fEnt.fn);// ファイル名から拡張子を取得する。
			
			// 拡張子チェック
			var res = validExts.indexOf(ext);
			if(res == -1){ // 対象外の拡張子である場合
				fEnt['err_flg'] = true;
				fEnt['err_msg'] = fn + 'の拡張子は対象外です。';
				continue;
			}else{
				fEnt['err_flg'] = false;
			}
			
			// MIMEチェック
			fEnt = this._validCheckMime(fue_id,fEnt);
			
		}
		
		return fileData;
	}
	
	/**
	 * ファイル名から拡張子を取得する。
	 * @param string fn ファイル名
	 * @return string 拡張子
	 */
	_getExtension(fn){
		if(fn==null){
			return '';
		}

		var ary=fn.split(".");
		var ext=ary[ary.length-1];

		ext=ext.toLowerCase();//小文字化する

		return ext;
	}
	
	/**
	 * MIMEチェック
	 * @param string fue_id
	 * @param object fEnt
	 * @return fEnt
	 */
	_validCheckMime(fue_id,fEnt){
		if(this.param.valid_mime_flg == 0) return fEnt;
		if(fEnt.err_flg == true) return fEnt;
		
		var validData = this.box[fue_id]['validData']; // バリデーションデータ
		var validMimes = validData.validMimes; // バリデーションMIMEリスト
		
		var mime = fEnt.mime;
		
		// チェック
		var res = validMimes.indexOf(mime);
		if(res == -1){ // 対象外のMIMEである場合
			fEnt['err_flg'] = true;
			fEnt['err_msg'] = fEnt.fn + 'のMIME(' + mime + ')は対象外です。';
		}else{
			fEnt['err_flg'] = false;
		}
		return fEnt;
	}
	
	
	
	/**
	 * ファイルユニットHTML
	 * @param int fue_if FU要素ID
	 * @param array fEnt ファイルエンティティ
	 * @param object option オプション（addEventメソッドの引数と同じ）
	 * @return string プレビューユニットHTML
	 */
	_makeFileUnitHtml(fue_id,fEnt,option){

		var p_unit_html = ""; // プレビューユニットHTML
		
		// エラーである場合
		if(fEnt.err_flg == true){
			p_unit_html = "<div class='fuk_err_msg'>" + fEnt.err_msg + "</div>";
			p_unit_html = "<div class='fuk_file_unit' >" + p_unit_html + '</div>';
			return p_unit_html;
		}
		
		// プレビュー画像サイズを取得
		var imgSize = this._getImgSize(fue_id,option);
		var label_width = imgSize.width;
		var label_height = imgSize.height;
		
		// 画像要素と音楽要素の作成
		if(fEnt.file_type == 'image'){
			p_unit_html += "<img src='' class='fuk_rp' style='width:" + label_width + "px;height:" + label_height + "px;' />";
		}else if(fEnt.file_type == 'audio'){
			p_unit_html += "<audio src='' class='fuk_rp' controls />";
		}
		
		var adf = this.param.adf;// 付属データフラグリスト
	
		// 通常パラメータの表示
		var paramData = [
			{'label':'ファイル名','val':fEnt.fn,'flg':adf.fn_flg},
			{'label':'サイズ','val':fEnt.size_str,'flg':adf.size_flg},
			{'label':'MIME','val':fEnt.mime,'flg':adf.mime_flg},
			{'label':'更新日','val':fEnt.modified,'flg':adf.modified_flg},
		];
		
		// パラメータ区分のHTMLを組み立てる
		for(var i in paramData){
			var pEnt = paramData[i];
			if(pEnt.flg != 1) continue;
			p_unit_html += 
				"<div><label class='fuk_param_label'>" + pEnt.label + "</label>" + 
				"<val class='fuk_param_val'>" + pEnt.val + "</val></div>";
		}

		p_unit_html = "<div class='fuk_file_unit' >" + p_unit_html + '</div>';

		return p_unit_html;
		
	}
	
	/**
	 * プレビュー画像サイズを取得
	 * @return プレビュー画像サイズ
	 */
	_getImgSize(fue_id,option){
		
		var width = 0;
		var height = 0;
		
		if(option['img_width']){
			width = option['img_width'];
		}else if(this.param['img_width']){
			width = this.param['img_width'];
		}else if(this.box[fue_id]['label_width']){
			width = this.box[fue_id]['label_width'];
		}else{
			width = 160;
		}
		
		if(option['img_height']){
			height = option['img_height'];
		}else if(this.param['img_height']){
			height = this.param['img_height'];
		}else if(this.box[fue_id]['label_height']){
			height = this.box[fue_id]['label_height'];
		}else{
			height = 160;
		}
		
		var imgSize ={'width':width,'height':height};
		return imgSize;
		
	}
	
	
	
	
	/**
	 * クリアボタンのクリックイベント
	 */
	_clearBtnClick(e){
		
		// クリアボタン要素を取得、そのクリアボタン要素から要素ID(fue_id)を取得。ついでにクリアボタンも隠す。
		var clickBtn = jQuery(e.currentTarget);
		var fue_id = clickBtn.attr('data-fue-id');

		this._clearBtnAction(fue_id);
		
	}
	
	/**
	 * クリアボタンアクション
	 * @param string fue_id file要素のid属性
	 */
	_clearBtnAction(fue_id){
		// クリアボタンラッパー要素を隠す
		var clearBtnW = this._getElement(fue_id,'clear_btn_w');
		clearBtnW.hide();
		
		// FU要素を取得し、中身をクリアする。
		var fue = this._getElement(fue_id,'fue');
		fue.val('');
		
		// 初期メッセージ要素を再表示する。
		var fukMsg = this._getElement(fue_id,'fuk_msg');
		var fuk_msg_text = this.box[fue_id]['fuk_msg_text'];
		fukMsg.html(fuk_msg_text);
		fukMsg.show();
		
		// プレビュー要素を取得し、中身をクリアする。
		var preview = this._getElement(fue_id,'preview');
		preview.html('');

		// 親ラベルの幅をautoから初期サイズに戻す
		var label_width = this.box[fue_id]['label_width']
		var label_height = this.box[fue_id]['label_height']
		var parLabel = this._getElement(fue_id,'label');
		parLabel.width(label_width);
		parLabel.height(label_height);
		
		// ファイルデータもクリアする。
		this.box[fue_id]['fileData'] = [];
	}
	
	/**
	 * 複数非同期・全終了後コールバック・初期化
	 * @param int count 非同期処理の件数
	 * @param object option 
	 *  - pacb ファイルプレビュー後コールバック
	 *  - pacb_param コールバックパラメータ 
	 */
	_cbAsynsEndInit(count,option){

		var pacb = function(){};
		if(option['pacb'] != null) pacb = option['pacb'];
		
		var pacb_param = {};
		if(option['pacb_param'] != null) pacb_param = option['pacb_param'];
		
		this.cbAsynsEndData = {
			'index':0,
			'count':count,
			'callback':pacb,
			'cbParam':pacb_param,
		};
		
	}
	
	/**
	 * 複数非同期・全終了後コールバック
	 * @note
	 * 複数の非同期処理がすべて終了したらコールバックを実行する。
	 * 
	 * @param string action アクションコード
	 *  - exe1 非同期処理がすべて終了したらコールバック関数を実行する。
	 *  - exe2 非同期処理が0件であるならコールバック関数を実行する。
	 * @param string fue_id FU要素のID属性
	 */
	_cbAsynsEndAction(action){
		switch (action) {
		case 'exe1':

			var cbAsynsEndData = this.cbAsynsEndData;
			if(cbAsynsEndData.index == cbAsynsEndData.count -1){
				if(cbAsynsEndData.callback != null){
					cbAsynsEndData.callback(this.active_fue_id,this.box,cbAsynsEndData.cbParam);
					this._endPreview();
				}
			}else{
				cbAsynsEndData.index ++;
			}
			break;

		case 'exe2':

			
			var cbAsynsEndData = this.cbAsynsEndData;
			if(cbAsynsEndData.count == 0){
				if(cbAsynsEndData.callback != null) {
					cbAsynsEndData.callback(this.active_fue_id,this.box,cbAsynsEndData.cbParam);
					this._endPreview();
				}
				
			}
			
			break;
		}
	}
	

	/**
	 * プレビュー最後の処理
	 */
	_endPreview(){

		// 初期メッセージ要素を隠す。
		var fukMsgElm = this._getElement(this.active_fue_id,'fuk_msg');
		fukMsgElm.hide();
	}
	
	
	/**
	 * AJAXによるアップロード
	 * 
	 * @param callback(res) ファイルアップロード後コールバック
	 * @param withData 一緒に送るデータ
	 * @param option 未使用
	 */
	uploadByAjax(callback,withData,option){

		var param = this.param;
	
		var fd = new FormData();
		
		var index = 0;
		for(var fu_id in this.box){
			var files = this.box[fu_id]['files'];
			var fileData = this.box[fu_id]['fileData'];
			for(var i in fileData){
				var fEnt = fileData[i];
				if(fEnt.err_flg == false){
					fd.append(index, files[i]);
					index ++;
				}
			}
		}

		// ファイル情報と一緒に送信するデータをセットする
		withData = this._escapeForAjax(withData); // Ajax送信データ用エスケープ
		var with_json = JSON.stringify(withData);
		fd.append( "key1", with_json );
	
		var prog1 = null; // 進捗バー要素
		if (param.prog_slt) prog1 = this.unit.find(param.prog_slt);
		
		
		// AJAXによるファイルアップロード
		jQuery.ajax({
			type: "POST",
			url: param.ajax_url,
			data: fd,
			cache: false,
			dataType: "text",
			processData : false,
			contentType : false,
			xhr : () => { // 進捗イベント
				var XHR = jQuery.ajaxSettings.xhr();
				if (XHR.upload) {
					XHR.upload.addEventListener('progress',
							(e) => {
								if(prog1){
									var prog_value = parseInt(e.loaded / e.total * 10000) / 100;
									prog1.val(prog_value);
								}
							}, false);
				}
				return XHR;
			},
	
		})
		.done((str_json, type) => {
			var res;
			try{
				res =jQuery.parseJSON(str_json);//パース
			}catch(e){
				jQuery(this.param.err_slt).html(str_json);
				return;
			}
			
			resOutput(res); // レスポンス出力
			
			
		})
		.fail((jqXHR, statusText, errorThrown) => {
			
			var err_res = jqXHR.responseText;
			console.log(err_res);
			jQuery(this.param.err_slt).html(err_res);
			alert(statusText);
		});
	}
	
	
	/**
	 * ファイル群のパラメータデータを取得する
	 * @return object ファイル群のパラメータデータ
	 */
	getFileParams(){
		
		var pData = [];
		for(var fu_id in this.box){
			var files = this.box[fu_id]['files'];
			var pEnt = {};
			for(var i in files){
				
				var file = files[i];
				if(file.size == null) continue;
				
				pEnt['fu_id'] = fu_id;
				pEnt['name'] = file.name;
				pEnt['size'] = file.size;
				pEnt['mime'] = file.type;
				pEnt['modified'] = file.lastModifiedDate.toLocaleString();
				
				pData.push(pEnt);
			}
		}
		return pData;
	}
	
	
	/**
	 * ファイルアップロード関連の要素を引数を指定して取得する
	 * @param fue_id ファイルアップロード要素のid属性
	 * @param key 要素を指定するキー　label,file,fuk_msg,preview
	 * @return jQuery 要素
	 */
	_getElement(fue_id,key){
		
		var box = this.box; // データボックス
		
		if(box[fue_id] == null) box[fue_id] = {};
		
		// ファイル要素を取得
		if(key == 'fue'){
			var elm = null;
			if(box[fue_id]['fue']){
				elm = box[fue_id]['fue'];
			}else{
				elm = this.unit.find('#' + fue_id);
				box[fue_id]['fue'] = elm;
			}
			return elm; 
		}
		
		// 親ラベル要素を取得。ついでにラベル幅も取得。
		else if(key == 'label'){
			var elm = null;
			if(box[fue_id]['label']){
				elm = box[fue_id]['label'];
			}else{
				var fileElm = this._getElement(fue_id,'fue');
				if(fileElm == null) return null;
				elm = fileElm.parents('label');
				box[fue_id]['label'] = elm;
				

			}
			return elm; 
		}
		
		// 初期メッセージ要素を取得
		else if(key == 'fuk_msg'){
			var elm = null;
			if(box[fue_id]['fuk_msg']){
				elm = box[fue_id]['fuk_msg'];
			}else{
				var label = this._getElement(fue_id,'label');
				if(label == null) return null;
				elm = label.find('.fuk_msg');
				box[fue_id]['fuk_msg'] = elm;
			}
			return elm; 
		}
		
		// プレビュー要素を取得
		else if(key == 'preview'){
			var elm = null;
			if(box[fue_id]['preview']){
				elm = box[fue_id]['preview'];
			}else{
				var label = this._getElement(fue_id,'label');
				if(label == null) return null;
				elm = label.find('.fuk_preview');
				box[fue_id]['preview'] = elm;
			}
			return elm; 
		}
		
		// クリアボタン要素を取得
		else if(key == 'clear_btn'){
			var elm = null;
			if(box[fue_id]['clear_btn']){
				elm = box[fue_id]['clear_btn'];
			}else{
				var label = this._getElement(fue_id,'label');
				if(label == null) return null;
				elm = label.find('.fuk_clear_btn');
				box[fue_id]['clear_btn'] = elm;
			}
			return elm; 
		}
		
		// クリアボタンラッパー要素を取得
		else if(key == 'clear_btn_w'){
			var elm = null;
			if(box[fue_id]['clear_btn_w']){
				elm = box[fue_id]['clear_btn_w'];
			}else{
				var label = this._getElement(fue_id,'label');
				if(label == null) return null;
				elm = label.find('.fuk_clear_btn_w');
				box[fue_id]['clear_btn_w'] = elm;
			}
			return elm; 
		}
		
		return null;

	}
	
	/**
	 * 各要素から値を取ってきてデータボックスにセットする。
	 * 
	 * @param int fue_id FU要素ID
	 * @param object box データボックス
	 * @param object option
	 *  - valid_ext バリデーション拡張子
	 * @return データボックス
	 */
	_setToBox(fue_id,box,option){
		if(option == null) option = {};
		
		var bEnt = {};
		if(box[fue_id]) bEnt = box[fue_id];
		
		// 親ラベル要素から幅を取得してセット
		var parLebel = this._getElement(fue_id,'label'); // 親ラベル要素
		bEnt['label_width'] = parLebel.width(); 
		bEnt['label_height'] = parLebel.height(); 
		
		// paramの初期メッセージテキストをセット。空ならFU要素のtitle属性をセット
		var fuk_msg_text = ''; // 初期メッセージテキスト
		if(this.param.fuk_msg_text){
			fuk_msg_text = this.param.fuk_msg_text;
		}else{
			var fue = this._getElement(fue_id,'fue'); // FU要素
			var fe_title = fue.attr('title');
			if(fe_title){
				fuk_msg_text = fe_title;
			}else{
				fuk_msg_text = 'File Upload';
			}
		}
		bEnt['fuk_msg_text'] = fuk_msg_text;
		
		// バリデーション情報をセットする
		if(option['valid_ext'] == null){
			bEnt['validData'] = this.param.validData;
		}else{
			bEnt['validData'] = this._createValidData(option.valid_ext);
		}

		box[fue_id] = bEnt;
		
		return box;
	}
	
	
	
	
	/**
	 * 容量サイズの数値を適切な単位表示に変換する（Byte,KB,MB,GB,TB)
	 * @param int value1 入力数値
	 * @param int n 小数点以下の桁（四捨五入）
	 * @returns string 単位表示
	 */
	_convSizeUnit(value1,n){
		
		if(n == null) n=1;
	
		var res = '';
		if(value1 < 1000){
			res = value1 + 'Byte';
		}else if(value1 < Math.pow(10,6)){
			value1 = Math.round( value1  * Math.pow(10,n - 3) ) / Math.pow(10,n); // 四捨五入
			res = value1 + 'KB';
		}else if(value1 < Math.pow(10,9)){
			value1 = Math.round( value1  * Math.pow(10,n - 6) ) / Math.pow(10,n);
			res = value1 + 'MB';
		}else if(value1 < Math.pow(10,12)){
			value1 = Math.round( value1  * Math.pow(10,n - 9) ) / Math.pow(10,n);
			res = value1 + 'GB';
		}else{
			value1 = Math.round( value1  * Math.pow(10,n - 12) ) / Math.pow(10,n);
			res = value1 + 'TB';
		}
		return res;
	}
	
	
	/**
	 * バリデーション情報を作成する。
	 * @param string valid_ext バリデーション拡張子
	 * @return object バリデーション情報
	 */
	_createValidData(valid_ext){

		var validData = {
				'validExts':[],
				'validMimes':[],
		}
		
		if (valid_ext == null || valid_ext == '') return validData;
		
		var validExts = []; // バリデーション拡張子リスト
		
		// バリデーション拡張子が配列型である場合
		if(Array.isArray(valid_ext)){
			validExts = valid_ext;
		}
		
		else if(valid_ext == 'image'){
			validExts = ['jpg','jpeg','png','gif','bpg'];
		}
		
		else if(valid_ext == 'audio'){
			validExts = ['mp3','wav'];
		}
		
		// バリデーション拡張子が文字列型である場合
		else{
			validExts = valid_ext.split(',');
		}

		// トリミング
		for(var i in validExts){
			validExts[i] = validExts[i].trim();
		}
		
		// 重複を除く
		validExts = this._array_unique(validExts);
		
		// バリデーションMIMEを取得
		var validMimes = this._getValidMimes(validExts);
		
		validData['validExts'] = validExts;
		validData['validMimes'] = validMimes;
		
		return validData;

	}
	
	/**
	* 配列から重複を除去する
	*/
	_array_unique(ary){
		var ary2= ary.filter(function (x, i, self) {
			return self.indexOf(x) === i;
		});
		
		return ary2;
	}
	
	/**
	 * バリデーションMIMEを取得
	 * @param array validExts バリデーション拡張子
	 * @return バリデーションMIME
	 */
	_getValidMimes(validExts){

		var mimeMap = this.mimeMap;// MIMEマッピングデータ

		var validMimes = [];// バリデーションMIME
		
		//  MIMEマッピングデータから拡張子に紐づくMIMEをバリデーションMIMEにセットする。
		for(var i in validExts){
			var ext = validExts[i];
			var mime = '';
			if(mimeMap[ext] != null) mime = mimeMap[ext];
			validMimes.push(mime);
		}
		
		return validMimes;
	}
	
	
	/**
	 * ファイル名リストを取得
	 * @param int fue_id ファイル要素のID属性値（省略可）
	 * @return array ファイル名リスト
	 */
	getFileNames(fue_id){
		
		var fns = [];
		if(fue_id == null){
			for(var fue_id in this.box){
				var fileData = this.box[fue_id]['fileData'];
				for(var i in fileData){
					var fEnt = fileData[i];
					fns.push(fEnt.fn);
				}
			}
		}else{
			var fileData = this.box[fue_id]['fileData'];
			for(var i in fileData){
				var fEnt = fileData[i];
				fns.push(fEnt.fn);
			}
		}
		return fns;
	}
	
	
	
	/**
	 * MIMEマッピングデータを取得
	 */
	_getMimeMapping(){
		
		var map = {};
		
		map['aac'] = 'audio/aac';
		map['abw'] = 'application/x-abiword';
		map['arc'] = 'application/octet-stream';
		map['avi'] = 'video/x-msvideo';
		map['azw'] = 'application/vnd.amazon.ebook';
		map['bin'] = 'application/octet-stream';
		map['bmp'] = 'image/bmp';
		map['bpg'] = 'image/bpg';
		map['bz'] = 'application/x-bzip';
		map['bz2'] = 'application/x-bzip2';
		map['csh'] = 'application/x-csh';
		map['css'] = 'text/css';
		map['csv'] = 'text/csv';
		map['doc'] = 'application/msword';
		map['docx'] = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
		map['eot'] = 'application/vnd.ms-fontobject';
		map['epub'] = 'application/epub+zip';
		map['es'] = 'application/ecmascript';
		map['gif'] = 'image/gif';
		map['htm'] = 'text/html';
		map['html'] = 'text/html';
		map['ico'] = 'image/x-icon';
		map['ics'] = 'text/calendar';
		map['jar'] = 'application/java-archive';
		map['jpeg'] = 'image/jpeg';
		map['jpg'] = 'image/jpeg';
		map['js'] = 'application/javascript';
		map['json'] = 'application/json';
		map['mid'] = 'audio/midi audio/x-midi';
		map['midi'] = 'audio/midi audio/x-midi';
		map['mp3'] = 'audio/mp3';
		map['mpeg'] = 'video/mpeg';
		map['mpkg'] = 'application/vnd.apple.installer+xml';
		map['odp'] = 'application/vnd.oasis.opendocument.presentation';
		map['ods'] = 'application/vnd.oasis.opendocument.spreadsheet';
		map['odt'] = 'application/vnd.oasis.opendocument.text';
		map['oga'] = 'audio/ogg';
		map['ogv'] = 'video/ogg';
		map['ogx'] = 'application/ogg';
		map['otf'] = 'font/otf';
		map['png'] = 'image/png';
		map['pdf'] = 'application/pdf';
		map['ppt'] = 'application/vnd.ms-powerpoint';
		map['pptx'] = 'application/vnd.openxmlformats-officedocument.presentationml.presentation';
		map['rar'] = 'application/x-rar-compressed';
		map['rtf'] = 'application/rtf';
		map['sh'] = 'application/x-sh';
		map['svg'] = 'image/svg+xml';
		map['swf'] = 'application/x-shockwave-flash';
		map['tar'] = 'application/x-tar';
		map['tif'] = 'image/tiff';
		map['tiff'] = 'image/tiff';
		map['ts'] = 'application/typescript';
		map['ttf'] = 'font/ttf';
		map['vsd'] = 'application/vnd.visio';
		map['wav'] = 'audio/wav';
		map['weba'] = 'audio/webm';
		map['webm'] = 'video/webm';
		map['webp'] = 'image/webp';
		map['woff'] = 'font/woff';
		map['woff2'] = 'font/woff2';
		map['xhtml'] = 'application/xhtml+xml';
		map['xls'] = 'application/vnd.ms-excel';
		map['xlsx'] = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
		map['xml'] = 'application/xml';
		map['xul'] = 'application/vnd.mozilla.xul+xml';
		map['zip'] = 'application/zip';
		map['3gp'] = 'video/3gpp';
		map['3g2'] = 'video/3gpp2';
		map['7z'] = 'application/x-7z-compressed';
		
		return map;
	}

	
	
	
	/**
	 * Ajax送信データ用エスケープ。実体参照（&lt; &gt; &amp; &）を記号に戻す。
	 * 
	 * @param any data エスケープ対象 :文字列、オブジェクト、配列を指定可
	 * @returns エスケープ後
	 */
	_escapeForAjax(data){
		if (typeof data == 'string'){
			if ( data.indexOf('&') != -1) {
				data = data.replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&amp;/g,'&');
				return encodeURIComponent(data);
			}else{
				return data;
			}
		}else if (typeof data == 'object'){
			for(var i in data){
				data[i] = this._escapeForAjax(data[i]);
			}
			return data;
		}else{
			return data;
		}
	}
	
	/**
	 * 文字列を右側から印文字を検索し、右側の文字を切り出す。
	 * @param s 対象文字列
	 * @param mark 印文字
	 * @return 印文字から右側の文字列
	 */
	_stringRightRev(s,mark){
		if (s==null || s==""){
			return s;
		}
		
		var a=s.lastIndexOf(mark);
		var s2=s.substring(a+mark.length,s.length);
		return s2;
	}
	

}

/**
 * インポート・ファイルアップロードクラス
 * 
 * @note
 * インポートに特化したファイルアップロード拡張クラス
 * 
 * @version 1.0.1
 * @date 2017-6-26 | 2017-7-2
 * 
 * @param param
 * - fu_slt: 		ファイルアップロード要素のセレクタ
 * - ajax_url: 	 	AJAX通信先のURL: WordPressの場合、省略可。
 * - preview_flg: 	プレビューフラグ: 0:プレビューを表示せず即座にアップロード  1(デフォルト):プレビューを表示する
 * - caption: 		見出し名: デフォルトの見出し → File Upload
 * - caption_color:  見出し文字色: ふちの色
 * - caption_color2: 見出し文字色: デフォルトは白
 * - back_color:	背景色
 * - backimg_fp: 	背景画像ファイルパス
 * - wrap_xid: 		ラッパーのID属性: ファイルアップロード要素のラッパーは当クラスで自動生成される。
 * - fw: 	フレームワーク識別子: wp:WordPress
 * - wp_ajax_action: 	AJAXアクション: WordPressの場合は必須。
 * - success_callback: 	成功コールバック: AJAXレスポンス後かつ成功時に呼び出されるコールバック関数: コールバックの引数は1つ存在する。その引数にはPHP側からのレスポンスが格納されている。
 * - suc_msg: 	成功メッセージ
 * - suc_toggle_sec: 	成功表示秒: 成功メッセージを表示する時間（秒）。 0を設定するとずっと表示しつづける。
 */
var ImportFu =function(param){

	this.param = param;
	
	// ファイルアップロード要素のラッパー要素
	this.fu_wrap; 
	
	// ファイルオブジェクト
	this.files;
	
	var self=this; // Instance of myself.

	/**
	 * initialized.
	 */
	this.constract=function(){
		
		// If Param property is empty, set a value.
		this.param = _setParamIfEmpty(this.param);
		
		// ファイルアップロード要素をラベル等でラップ、および画像要素の追加
		_wrapFu(this.param);
		
		// ファイルアップロードイベントを追加する
		_addFileuploadEvent(this.param);
		
		// DnDイベントを追加する（DnD→ドラッグアンドドロップイベント）
		_addDnDEvent(this.param);

	}
	
	// If Param property is empty, set a value.
	function _setParamIfEmpty(param){
		
		if(param == undefined){
			param = {};
		}
		
		if(param['fu_slt'] == undefined){
			throw new Error('The fu_slt in param is empty!');
		}
		var fu_slt2 = _sltToCode(param['fu_slt']); // セレクタから識別子「#」「.」を取り外す
		
		if(param['ajax_url'] == undefined){
			param['ajax_url'] = '';
		}
		
		if(param['preview_flg'] == undefined){
			param['preview_flg'] = 1;
		}
		
		if(param['caption'] == undefined){
			param['caption'] = 'File upload';
		}
		
		if(param['caption_color'] == undefined){
			param['caption_color'] = '#a698c9';
		}
		
		if(param['caption_color2'] == undefined){
			param['caption_color2'] = '#FFFFFF';
		}
		
		if(param['back_color'] == undefined){
			param['back_color'] = '#e3dfee';
		}
		
		if(param['caption_font_size'] == undefined){
			param['caption_font_size'] = '40px';
		}
		
		if(param['backimg_fp'] == undefined){
			param['backimg_fp'] = '';
		}
		
		if(param['wrap_xid'] == undefined){
			param['wrap_xid'] = fu_slt2 + '_wrap';
		}

		if(param['fw'] == undefined){
			param['fw'] = '';
		}
		
		if(param['wp_ajax_action'] == undefined){
			if(param['fw']=='wp'){
				throw Error('The wp_ajax_action in param is empty! (WordPress only)');
			}
			param['wp_ajax_action'] = '';
		}

		if(param['success_callback'] == undefined){
			param['success_callback'] = null;
		}

		if(param['suc_msg_xid'] == undefined){
			param['suc_msg_xid'] = fu_slt2 + '_suc_msg';
		}

		if(param['suc_msg'] == undefined){
			param['suc_msg'] = '読込が終わりました。';
		}

		if(param['suc_toggle_sec'] == undefined){
			param['suc_toggle_sec'] = 3000;
		}
		
		
		
		// ▽▽ 以下は隠し設定
		
		if(param['fuWrapCss'] == undefined){
			param['fuWrapCss'] = {
					'background-color':param['back_color'],
					'border-radius':'5px',
					'display':'inline-block',
				};
		}
		
		if(param['label_xid'] == undefined){
			param['label_xid'] = fu_slt2 + '_label';
		}
		
		if(param['caption_xid'] == undefined){
			param['caption_xid'] = fu_slt2 + '_caption';
		}
		
		if(param['preview_xid'] == undefined){
			param['preview_xid'] = fu_slt2 + '_preview';
		}
		
		if(param['captionCss'] == undefined){
			var caption_color = param['caption_color'];
			var caption_color2 = param['caption_color2'];
			var caption_font_size = param['caption_font_size'];
			param['captionCss'] = {
					'padding' : '0px 20px 0px 20px',
					'color' : caption_color2,
					'font-size' : caption_font_size,
					'font-weight' : 'bold',
					'text-shadow' : '2px 2px 1px ' + caption_color + ',-2px 2px 1px ' + caption_color + ',2px -2px 1px ' + caption_color + ',-2px -2px 1px ' + caption_color + '',
				};
		}

		if(param['err_xid'] == undefined){
			param['err_xid'] = fu_slt2 + '_err';
		}
		
		
		
		
		
		return param;
	}
	
	
	
	
	
	
	/**
	 * ファイルアップロード要素をラベル等でラップ、および画像要素の追加
	 * @param param
	 */
	function _wrapFu(param){
		
		var fu_slt = param.fu_slt;
		var fu = jQuery(fu_slt);
		var fu_xid = _sltToCode(fu_slt); // セレクタから識別子「#」「.」を取り外したコードを取得する
		fu.hide();
		

		// ファイルアップロード要素をラベル要素でラッピングする。
		fu.wrap("<div id='" + param.wrap_xid + "'  ><label id = '" + param.label_xid + "' for='" + fu_xid + "' ></label></div>");
		
		
		// ラッパー要素へCSSスタイルを適用する
		var fu_wrap = jQuery('#' + param.wrap_xid);
		fu_wrap.css(param.fuWrapCss);
		
		
		// 見出しを追加する
		var label = fu_wrap.find('#' + param.label_xid);
		var caption_html = "<div id='" + param.caption_xid + "' class='imp_fu_caption'>" + param.caption + "</div>";
		label.append(caption_html);
		var caption = fu_wrap.find('#' + param.caption_xid);
		
		caption.css(param.captionCss);
		
		
		// 背景画像要素を追加する
		if(!_empty(param.backimg_fp)){
			var img_html = "<img src='" + param.backimg_fp + "' />";
			fu_wrap.append(img_html);
		}
		
		
		// プレビュー要素を作成する。
		var preview_html = 
			"<div id='" + param.preview_xid + "' style='display:none;margin:0px 20px 20px 20px;'>" + 
			"	<div id='" + param.pre_fn_xid + "' class='imp_fu_pre_fn'></div>" + 
			"	<div class='imp_fu_pre_btns' style='margin-top:10px'>" +
			"		<input type='button' class='imp_fu_pre_exe_btn btn btn-success btn' value='アップロード' />" +
			"		<input type='button' class='imp_fu_pre_cancel_btn btn btn-default btn' value='キャンセル' />" +
			"	</div>" + 
			"</div>";
		fu_wrap.append(preview_html);
		
		
		// ローディングGIFを埋め込む
		var gifBase64 = _getLodingGifBase64();
		var loding_gif = 
			"<div class='loding_gif' style='display:none;padding:20px;'>" +
			"	<img src='" + gifBase64 + "' /> 読み込み中・・・" +
			"</div>";
		fu_wrap.append(loding_gif);
		
		
		// プレビュー要素のアップロード実行ボタンにイベントを組み込む
		var imp_fu_pre_exe_btn = fu_wrap.find('.imp_fu_pre_exe_btn');
		imp_fu_pre_exe_btn.click(function(e){
			_clickPreExeBtn(); // アップロード実行ボタンの実行処理
		});
		
		// プレビュー要素のキャンセルボタンにイベントを組み込む
		var cancel_btn = fu_wrap.find('.imp_fu_pre_cancel_btn');
		cancel_btn.click(function(e){
			_showBeginning(); // 初めに戻す
		});
		
		
		// 成功メッセージ要素を追加する
		var suc_msg_html = "<div id='" + param.suc_msg_xid + "' class='text-success' style='display:none'>" + param.suc_msg + "</div>";
		fu_wrap.after(suc_msg_html);
		
		
		// エラー要素を追加する
		var err_html = "<div id='" + param.err_xid + "' class='text-danger' ></div>";
		fu_wrap.after(err_html);

		self.fu_wrap = fu_wrap;

	}
	
	
	
	
	
	
	
	
	/**
	 * ファイルアップロードイベントを追加する
	 * @param param
	 */
	function _addFileuploadEvent(param){

		//ファイルアップロードイベント
		jQuery(param.fu_slt).change(function(e) {
			
			var files = e.target.files;
			
			if(param.preview_flg){
				// プレビューを表示する
				_showPreview(files);
				
			}else{
				// AJAXによるアップロード
				_uploadByAjax(files);
			}

		});		
	}
	
	
	/**
	 * DnDイベントを追加する（DnD→ドラッグアンドドロップイベント）
	 * @param param
	 */
	function _addDnDEvent(param){
		var wrapElm = jQuery('#' + param.wrap_xid);
		
		wrapElm[0].addEventListener('drop',function(evt){
			evt.stopPropagation();
			evt.preventDefault();
	
			var files = evt.dataTransfer.files; 
			
			if(param.preview_flg){
				// プレビューを表示する
				_showPreview(files);
				
			}else{
				// AJAXによるアップロード
				_uploadByAjax(files);
			}
	
	
		},false);
		
		wrapElm[0].addEventListener('dragover',function(evt){
			// evt.stopPropagation();
			evt.preventDefault();
		},false);
		

	}
	
	
	
	
	/**
	 * AJAXによるアップロード
	 * @param files ファイルオブジェクト
	 */
	function _uploadByAjax(files){
		
		var param = self.param;

		_showLoading(); // ローディング表示
		
		var oFile = files[0];
		
		// IEはファイル要素にnullが入っていてもチェンジイベントが発生するため対策する。
		if(oFile==null){return;}

		var reader = new FileReader();
		reader.readAsDataURL(oFile);
	
		//ファイル読込成功イベント
		reader.onload = function(evt) {
			
			// AJAXのURLを取得
		    var url = _getAjaxUrl();

		    var fu_slt = param.fu_slt;
		    var fd = new FormData();
		    fd.append( "upload_file", jQuery(fu_slt).prop("files")[0] );
		    
			// WordPressのAjaxで必要なパラメータをセットする
			if(param.fw=='wp'){
				fd = _setFormDataForWp(fd,param.wp_ajax_action);
			}
			
			jQuery.ajax({
				type: "POST",
				url: url,
				data: fd,
				cache: false,
				dataType: "text",
				processData : false,
				contentType : false,


			}).done(function(str_json, type) {
				
				var data;
				try{
					data = JSON.parse(str_json);

					// エラーメッセージが空である場合（成功時）
					if(_empty(data['err_msg'])){
						
						_showSuccess(); // 成功の表示
						
						// 成功コールバックが設定されていれば実行する
						if(!_empty(param.success_callback)){
							param.success_callback(data);
						}
					}
					
					// エラーメッセージが送信されてきた場合
					else{
						jQuery('#' + param.err_xid).html(data['err_msg']);
					}
					
					_hideLoading(); // ローディング非表示
					
					_showBeginning(); // 初めの状態に戻す

				}catch(e){
					console.log(str_json);
					jQuery('#' + param.err_xid).html(str_json);
					_hideLoading(); // ローディング非表示
					_showBeginning(); // 初めの状態に戻す
					throw e;
				}
				
				
			})
			.fail(function(jqXHR, statusText, errorThrown) {
				console.log(jqXHR);
				var err_res = jqXHR.responseText;
				console.log(err_res);
				jQuery('#' + param.err_xid).html(err_res);
				alert(statusText);
				_hideLoading(); // ローディング非表示
			});

		}
	}
	
	

	

	/**
	 * AJAX URLを取得する
	 * @returns string Ajax URL
	 */
	function _getAjaxUrl(){
		
		var fw = self.param.fw;
		var ajax_url = self.param.ajax_url;
		
		if(fw=='' && ajax_url!=''){
			return ajax_url;
		}
		
		else if(fw=='' && ajax_url==''){
			throw new Error('Empty ajax_url !')
		}
		
		else if(fw=='wp' && ajax_url!=''){
			return ajax_url;
		}
		
		else if(fw=='wp' && ajax_url==''){
			return jQuery('#admin-ajax-url').val();;
		}
		
	}
	
	
	/**
	 * WordPressのAjaxで必要なパラメータをセットする
	 * @param fd FormDataオブジェクト
	 * @param action WordPressのAjaxアクションコード
	 * @returns セット後のFormDataオブジェクト
	 */
	function _setFormDataForWp(fd,action){
		var nonce = jQuery('#nonce').val();
		fd.append('action',action);
		fd.append('nonce',nonce);
		return fd;
		
	}
	
	
	/**
	 * アップロード実行ボタンの実行処理
	 */
	function _clickPreExeBtn(){
		
		// AJAXによるアップロード
		_uploadByAjax(self.files);
		
	}
	
	
	
	/**
	 * 初めに戻す
	 */
	function _showBeginning(){

		// ファイルオブジェクトをクリア
		self.files = null;
		
		// 見出しを表示
		var imp_fu_caption = self.fu_wrap.find('.imp_fu_caption');
		imp_fu_caption.show();
		
		// プレビュー要素のファイル名をクリアする
		var preview = self.fu_wrap.find('#' + param.preview_xid);
		var imp_fu_pre_fn = preview.find('.imp_fu_pre_fn');
		imp_fu_pre_fn.html('');
		
		// プレビュー要素を隠す
		preview.hide();
		
		// ファイルアップロード要素のクリア
		var fu_slt = self.param.fu_slt;
		var fu = jQuery(fu_slt);
		fu.val('');
		

	}
	
	
	
	
	/**
	 * プレビューを表示する
	 * @param files ファイルオブジェクト
	 */
	function _showPreview(files){
		var param = self.param;
		
		// プレビュー要素を表示する
		var preview = self.fu_wrap.find('#' + param.preview_xid);
		preview.show();
		
		// プレビュー要素にファイル名を表示する
		var imp_fu_pre_fn = preview.find('.imp_fu_pre_fn');
		var fn = files[0].name;
		imp_fu_pre_fn.html(fn);
		
		// 見出しを隠す
		var imp_fu_caption = self.fu_wrap.find('.imp_fu_caption');
		imp_fu_caption.hide();
		
		// ファイルオブジェクトをメンバへセット（アップロード実行ボタンで必要になる）
		self.files = files;
		
		// 成功メッセージを隠す
		var sucMsgElm = jQuery('#' + self.param.suc_msg_xid);
		sucMsgElm.hide();
		
		
	}
	
	
	/**
	 * 成功の表示
	 */
	function _showSuccess(){
		var elm = jQuery('#' + self.param.suc_msg_xid);
		elm.show();
		if(self.param.suc_toggle_sec != 0){
			elm.fadeOut(self.param.suc_toggle_sec);
		}
		
		
		
	}
	
	
	
	
	/**
	 * ローディング表示
	 */
	function _showLoading(){
		var param = self.param;
		
		// プレビュー要素を隠す
		var preview = self.fu_wrap.find('#' + param.preview_xid);
		preview.hide();
		
		var loding_gif = self.fu_wrap.find('.loding_gif');
		loding_gif.show();
	}
	
	
	/**
	 * ローディング非表示
	 */
	function _hideLoading(){
		var loding_gif = self.fu_wrap.find('.loding_gif');
		loding_gif.hide();
	}
	
	
	
	
	
	
	/**
	 * セレクタから識別子「#」「.」を取り外したコードを取得する
	 * 
	 * @note
	 * セレクタに空文字を指定すると空を返す。ただしnullを指定した場合はエラーになる。
	 * 
	 * @param slt セレクタ
	 * @returns コード
	 */
	function _sltToCode(slt){
		
		var code = slt;
		var s1 = code.charAt(0); // 先頭の一文字を取得
		if(s1=='#' || s1=='.'){
			code = code.substr(1);
		}
		return code;
	}


	
	// Check empty.
	function _empty(v){
		if(v == null || v == '' || v=='0'){
			return true;
		}else{
			if(typeof v == 'object'){
				if(Object.keys(v).length == 0){
					return true;
				}
			}
			return false;
		}
	}
	
	
	
	/**
	 * ローディングGIFのbase64文字列を取得する
	 * @returns ローディングGIFのbase64文字列
	 */
	function _getLodingGifBase64(){
		return "data:image/gif;base64,R0lGODlhGAAYAPcAABgYGB0dHSIiIioqKi4uLjExMTMzMzY2Njw8PD8/P0RERE9PT1NTU1dXV1paWl1dXV5eXl9fX2FhYWJiYmNjY2ZmZmlpaWpqamtra21tbW9vb3FxcXNzc3Z2dnh4eIKCgoODg4yMjI+Pj5CQkJGRkZOTk5WVlZiYmJmZmZqampubm5ycnKKioqSkpKWlpaenp6mpqaurq6+vr7CwsLKysrOzs7W1tbe3t7m5ub29vb+/v8DAwMLCwsTExMXFxcfHx8jIyMnJycrKysvLy8zMzM3Nzc/Pz9DQ0NHR0dLS0tPT09TU1NbW1tfX19nZ2dvb29zc3N3d3d7e3t/f3+Dg4OPj4+Xl5efn5+np6erq6uvr6+zs7O7u7u/v7/Hx8fLy8vPz8/T09PX19fb29vf39/j4+Pn5+fr6+vv7+/z8/P39/f7+/v///wUFBQoKCg8PDy0tLTAwMD09PUBAQENDQ0lJSUxMTFBQUFJSUllZWWBgYGxsbHBwcHJycnd3d3l5eXp6enx8fH9/f4CAgISEhIWFhYaGhpKSkp2dnZ6enqGhoaOjo6ampqqqqqysrK2trba2tru7u7y8vL6+vsHBwcbGxs7OztXV1djY2Nra2uHh4eLi4ujo6O3t7fDw8BAQEBcXF0dHR1RUVFZWVlxcXHV1dYGBgYiIiImJiYuLi42NjY6OjqCgoLi4uMPDw+bm5ikpKUJCQm5ubrS0tOTk5E1NTU5OTkhISIqKikVFRWRkZBkZGQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh/i1NYWRlIGJ5IEtyYXNpbWlyYSBOZWpjaGV2YSAod3d3LmxvYWRpbmZvLm5ldCkAIfkEAQoAbQAsAAAAABgAGAAAB/+AbIKDhGpGRmqEiotsZWWCXwkJX4Jra4yEWBUjl14GBl6CXVhpmIJYCgNIbJ6gbGZUVaWmbDEAGGdfn6FZUGCYWlqCYQ8BOGCfX2JRV4lsZ2eDZhwLNGJsPgIXYi4uZllSY2xqW0lPzmcpCAQXRGM1TYRnYWpfTj9DVs5sa0weBQdwYOIiBMiTMIzO6OjwBBMZKFz2jRsjpiIZMpcwpUHDkeMaKBkmUKAwYQetKz1S9gjy5YmGCDAh6DipsgeQL2rEhNk55pGpNBs7ZhSEpogJK5i++KgisdIUEg0cAMFU5UWLHlyGopEhgQGIJWWOXCHEBQoaLDlYwFDiDE0IDTtlyLBxkmHFmSVL0OAwUYUNGik0eMxiw4WLoDIlLBgxQ4KEmSgkZkRjM0Ycox8VVKAp07hMmhsimNBi9WEDlUad2WA50QKhKS8oalziTMJnEBuuTXEUZAYFCjNE0YxWtMaKlaGMAgEAIfkEAQoAAQAsAAAAABgAGAAACP8A2QgcSFCNEiVqCCpcyKZMGYFg7twBI5AMGYYEtXBAsYbNFwUKvrBZYyjPFYwCteCRw8QjSJFGAMQ5iZINDTgeznwMaSZCm0UYO3USKAZDAR1hQIqp4WZBGIFp0gw8A0KPpItCDvgZ8+iRmAdvdrBRA6YKlo5szrCwM8cPEjI4nhBc4sgMmStRpnRBO9ZJITp1emAUMyUKlocLz/QwpAnjGSxi+I4lM6ayw5pqompmQyVQHw4c+vyouQWJaSSXCP/hw1pDJdKnUYtRM0aMbTJmMGfWLBlNkkQ0F4ZRoiWhwjWbEFnYYwkjlkg4knzhiwZSnwojMJlhooXgl01puBBzuTFJinE0KARVeihlUAw0mTKh8fGCE5s0VnocMc7GkyeBZigSSBNnLLLIGVW0MAkaAl3GkBGAwJCGGQaaoUYPLEhRk0eHEGIFGxQukhsXjdRwEUpfMCIWiBUKpAQlJ6KEBoNpwQDDGVBJtSFBa2BxVk0BAQAh+QQBCgAFACwAAAAAGAAYAAAI/wDZCBxIUE2TJmoIKlzI5swZgWIiRBAjsEwZhgS3gGAkEAwDBmDYrBlRAQtGgVv0LMjExiNINkgGKDB5kk2rBKfQhPkY5sweADEwdvEEsZSCH2M+jsER4EEYgVdeDTyjaoMrMmwshUJVpkaNMRgE+GjZgkCei2zQPIogyhCTMjw0EWxSQwylBW1AGULLRk2UVaNICcHo6JObCEbWLDwjRIQVjEse1ODbtwyZy2bMnFxjZo2azwk3pfpA2hSRmmCqqK5ixcwmVIIGDRI0BPUm1ZtaqyEzZgyZMppPggatME2TGFowkonSRbHCNVZgBBrEBCMXIUCgUByYZgcIQKymnHWBwoVgmCxpvGD6QcSK8zSMRhzRXMUEjjRUqKRJIql8Gi1IPJGQQF98IdAZM5AQBRpenYEFDpakceBDDDUhQitpnNGgGki0IlVNYbRwgkka1vCQFzn4EBxGYdgQxIENChTFfDWlhcaBrbRC4Wc1PscFF85hFBAAIfkEAQoAAwAsAAAAABgAGAAACP8A2QgcSFDNEyhqCCpcyObMGYFiNGQYI7BMGYYEu4SQITBMBApi2KxBwUELRoFc+EiYwsYjSDZM5OAxeZLNDgYk0Lgcc8YDHBoYPXkRSIZQgyJjPpLRUQBDSDZYOA08g2IQkItKHJgoo2MHGT8HgrR0FKuCGYFoZm2oUOJJmSBWCD7BMabSAwCwRpwVuEaTCguyjmCsISAAhiRrFp4xsuIKxiYXcOzla8ZiGTOTF64RA+aLJ09f1FhBQaI0CSU1XRQwwDqBkdGmT6de3drImsoWzTw8aeaLl8+hCaaJgoMLxjNZxCRWuCbLDRImoGAMIyVKlsxphJwQMYMWmipfCJJ14aKGzBUoU7osT2ODRZOHnF74SHPlihooQsKrAVMFy/KWYaA1SQtVpNGDD2hwAYQTCbGRRhoYScFCD2qg0UMPaKzxxA9b1MQGGTU0YtwZF6LREhFJ7IYRGZSg1lCJAtHyhIoYPYgWEEGYyIYaDXpI0Bfh1RQQACH5BAEKAAAALAAAAAAYABgAAAj/ANkIHEhQzRQqaggqXMgGDRqBY/4EIiPQjBmGBD2hgCRQDB8OY9isWQSCC0aBngb12cTGI0g2mGpRMHmSjY8KiNK4HHOm0JxIGL98EViGhIUkZD6W6RHLA0U2WrQMRMNoxJGLmPYkMvPjRxlDdZC0pLGAw0U2aXaAAMRqihlLVwhq6kGGyAUCCFKcGbjGCoxAg5hgxHGggAcmaxamaRJDKsMnHXTs5XvGopkzDzGuERNG6BcwarDAWER6Uaaaj2IpUEDnjhLRpU2jVs3a9ZrKFjGf3CzGM+iCVXwMZbjkQY0yC9dw6dHiRRWMjj65iWAksUA1SmCwyIElDZYwBM+IbzlDyVYbUIaQo6VEQ8rDTpGUqNmyJfQUimFaEMijns2YkA0RgYMWaiCBhE5RXJEQG1e8gpEVNyShRhoGprEGFlGAURMbS00yFIUHcjhFFWnUVMYRUggEYolsdNHdhmosmMYll7C4hnUbEiSGGBsGBAAh+QQBCgADACwAAAAAGAAYAAAI/wDZCBxIUM2mTWoIKlzIBg0agWRO4Soj8IwZhgTBMNohcMygD2TYrHmkyhNGgWAOEbLCxiNINlH0cDB5ko0RQDDSkPlIBo0IUa4whgkj0IyiQE3KfDQzZJShkGy2bBmYxgYLJmfYSBkU48wQImZEkLrUEgcEEFnZpBFyQsQMWmeYaCFoRUgZS6USLGCUVmSWGyRMQMHI45aCU0/WLEwTBQcXjJpO/egr8ozlMw5rlhkTBgwYMWq4tKJRowYNKjVp4GEgikGEJqJJm0Z9UjWD26/XXMac5uSaMZw9gy6IJQlRhk0u4KAscI0XJDgkZcFYQ0AADEkUC1QTJUcrS1zScHiBKnCJIzGVHgCANeIiGzVHfLzq7UVIFDVgwpx58IljGEexVOAeG2a4lwYmQXShRhVVsFGDGwschwUnGGnxAxRrLFiFGmZE0MYiNbFxBhJEiPEegwkVAUAcV9R0xhMsnbihSIbk0WJNaiT0nhVW6EgGeSEOVGCIAQEAIfkEAQoACgAsAAAAABgAGAAACP8A2QgcSHCNFStrCCpcyAYNGoFmUKAwI9AhQ4JhbAQRWIYEiTJs1tRA4eWiwDCLTmBh0/EjGyobPpQ0yYaJiBtpWpZBo6LCj4tjyAg8M4NEFDMezRixUAIkGy5cBqahREPKwyomcKBRouTMigxO2JDZoSHEQzZqlMBgMQkLGihRB145UmYJCAYSZJwNyaVHixdVLgJx0IDElIQK1VTx8eWiFRNF9oZ06DBNGpplxoTZLEbNFyA9Qve4QlMHhAioNTz5EkT06NITKFCYkAHKGsqVTa4hQ0aM7zFqCKrhAkUowycddJxhGOYJECFxF+I4UMADE8RorQz54eSLmjDLBzZ2qTFmyAUCCFKEV/MkyZbgZKRkMePChZgLAnywEUNjAQeKQ613RRRifGGAAWDgEAAEYQikhRYXgQFFFmx4ceAXZ2AAgCM0sZFGFVRQZKEBJSExQC4rmZQGFl0INGJJa4xQQYq6IfZFAnM0xpJTHQ6khhFGBGdSQAAh+QQBCgABACwAAAAAGAAYAAAI/wDZCBxIcA0WLGsIKlzIJk0agWdgNDojEA0ahgTJ8FAi0MyiRWYE7mD0BaNAMjUacWHjESQbK4QOlTTJJgqLHmpamkkDA5ARjGXKVJzUosqZj2eaBFIUko0nTwPVHOlh5SGnFz7QZMqEJsYgKWzKVBKE4iIbNVJy3CDCJc2mmQK1MDGDiUSFPpDMslnzJQmOSFgwWtpjAdGmhArVaFESBuOVREn07nXoUI0ammbIiNk8Ro2YJUhCI9lCs5IGPqj/TBFzSfRomj/6cODQJxCVhpTTXDYZdMwYMWR2C1wjBgtFhpoM9TiusAyWKKsx9qhDp5AT4Wu6TIlyhYwZR5cIPnjBQQaJnzl2Fh03WAXM5R1vHohx9GiMnwNC2JCRpAcEc4cChbGAGzWIoYACYuhQAAZiCNRJJxgt0kYEZnxx4BdneAAHDTSxcUUcAPxkoQIlMSEHHlrQdEUehiQ0YklroMBBijSRQYZAYNxxBxgCBdVhYkooIRxDAQEAIfkEAQoABQAsAAAAABgAGAAACP8A2QgcSHANFy5rCCpcyEaNGoFnWrU6IxANGoYEzRyJArFGDYpsgtgIg1GgGR85vLA545EilhMtSJZk86oVEjUsP6a5IaIJxjMg01jCgSUnmigkZoD88mWgmidItKRhwyVSkjRUqKTBYaIKG40kGE1ls8YKkR+YvKTBIlMgFyhnpigCBGLHWIFioAARwgUjk0GBYFhJqHBNFyhkMGqJ0eSuQIeQH5Y0U4bMmDFk1JixsqlKlU1gZg4RNKg0qk2bPXsOXZKIqQ+wcW1qCHmNGcIMzZghw7uMZIFlajxYgtGKiCEgCxqJ4OaTI4xCSI1aFeV3GUOg2tiiJGaWz4GaeJR6YWJIVIRHF9mUyUOgRWgfAjCM8VgGVShLbMi42qAq+asrAoXxQAA4jMGAKGP8oEApYgjkSRcYOQLAHmeEwQADYaBxSgKtzMQGFgoMgAQbYFwYWiYL6LHFTFhUMEJCJTLAGiMgdOJhGWXgBUEEDa5khocKqdFEE78xFBAAIfkEAQoAAwAsAAAAABgAGAAACP8A2QgcSJDNly8FEyZUo0YgmiBA0AhMk0YhwTNPrDjs0UMiGyU8yFgUeCYJkTBs0HCUyKVRDZEj2Wz58WSNyo5qerCQYpGiQDVOgHBB46NHmiotJnkMg1LgGixVwDT8IgSKmitX0vh4wYnNmSYsbFRks6bLFChXyKjhAlPglypoaM0QcULIWIFmskSR0jQhFBMkbmRZk3CNmCxnLHLBEeUuGzVfPHny8sVMzDNmymg2s8ZIAgOgC7iIqYSEaRIorHgGbUA06dOorUCW/AWMGMIWzWTejBsvjgtNLF5ZYcQjwTVJMAQQUMPiEVkWVGjqbWYELAAPKo3B8YSglSBlnpR2qLBhlkczFWI5QinkgB8yO3SUMeFACZsyQAahMM4Ji0AxGBSgAxkU6DJGEQ0QApMXnlhEAxwenDEGBRGEgQYJDOwQExta4CEHE2yIQSFKU0jABxcxacEBCoSJWKFAMoTQxYaaCTRGBhqIQVJiGxKkBhRPNDRSQAAh+QQBCgAAACwAAAAAGAAYAAAI/wDZCBxIkI0YMQUTJlyzRmCaS0vSCFSjRiHBNFi6OESCRCIbKUfKWHRYZYrINBwlfpnkQ+RINmCiYFmDsqOaJDesWHx1ZeKVKGJqqtGCgwgagWTGDCyTh0ALMGzITMGiZssWNUoidWKDRgoNHh7LGALVZgGlM2LOEAyDBWMOFjCUVBS4xkgEN58cWazyokUPLg0Llqnx4JLFLz6qzJ0I5ovjg4EVojljpvKZNUru0FGgINajl5kWiV4EA0vmzZ0/jww9urSaxo7DiImccHJlM5cJntHh54lFLTGaeCS4homHAgciWWQyKBAMK5HNpEBA4MIQMj00EbxixMwUVoBA7GzwaIbDAhoIkdQxVObHDzOJ9mBiY+bICEZHBWrRgtRDrB5lcMAHGUlYQIJLjlkUyRyFnDGGgEEhUkElL7HBBQW1zPcgHwht0scgnrzUCQiLNLQhQmxAgkKIL1WGVCB/KMVVfhUOpAYVUyymUEAAIfkEAQoAAwAsAAAAABgAGAAACP8A2QgcSJCNGTMFEyYkQ0agGitW1DiUqHDglTyG1rBRU6UKRStPzlQUeCUOgCIbO0oUQwSJyJFsFrWJYIajxzVQfmipyAmLwDAL3NRgo7JLEExpBB4caKZCLEdh2Ox48+BMGDBqogjxwibNKx9HKJoZAWvXg0piHC0hSIZLGi6WWuWIQpHNmiQYAggYqhCLJBxIvGgseAbHhSYVwyTBUnejGDBgwowRM1hhGjRnMp9Z0yQCg894aMCkQqNGDRqtuHT+zCD06NKnU6t5HHlMGZhoMGuuzObMD1SbKnLBESVpwTVPTim4xaMiFBMkbmCpfIbRggSlLJURYoWgFiZnaM12EHFCiPEzICDgGMPmEikRZogQORNjkJTeTFjYMM5myxaBZBgyyhBmfDBIGU0EoghCbIQRlUKuiCICGmQYSEYaMAByBExseMKBHlGwUeEg7FlByCFgwOSJKo9oNCJ7UjGSIkxmvFQGLqg0xEZuHBakxiabNJZQQAA7";
	}
	
	
	
	
	
	
	
	

	// call constractor method.
	this.constract();
}
/**
 * CrudBase:indexページの共通JavaScript
 * 
 * @version 1.2.4
 * @date 2015-1-1 | 2017-9-25
 */

$(function(){
	
	// もし入力エラーであるなら詳細要素を表示します。
	errShowDetail();
	
});

/**
 * もし入力エラーであるなら詳細要素を表示します。
 */
function errShowDetail(){
	
	// エラー要素および詳細要素が存在しなければ、処理をしません。
	if(!$('#err')[0] || !$('#detail_div')[0]) return;
	
	// エラーメッセージが空でない場合、詳細要素を表示します。
	var msg = $('#err').html();
	msg = msg.trim();
	if(msg!=""){
		$('#detail_div').show();
	}
	
	
}



/**
 * 検索条件をリセットする
 * 
 * リセット対象外フィールドを指定することができます。
 * @param array exempts リセット対象外フィールド配列（省略可）
 * @author k-uehara
 */
function resetKjs(exempts){
	
	if(exempts==null){
		exempts=[];
	}
	
	//デフォルト検索条件JSONを取得およびパースする。
	var def_kjs_json=$('#def_kjs_json').val();
	var defKjs=$.parseJSON(def_kjs_json);
	
	for(var key in defKjs){
		
		//リセット対象外でなければ、検索条件入力フォームをリセットする。
		if(exempts.indexOf(key) < 0){
			$('#' + key).val(defKjs[key]);
		}
		
	}
}



/**
 * 列並替画面に遷移する
 * @param page_code ページコード (モデル名のスネーク表示）
 */
function moveClmSorterBase(page_code){
	
	//列表示配列を取得して、URLクエリ用にエンコードする。
	var csh_ary=csh.getCshAry();
	
	var csh_json = null;
	if(csh_ary.length == 0){
		csh_json = $('#csh_json').val();
	}else{
		csh_json = JSON.stringify(csh_ary);
	}
	
	var csh_u=encodeURIComponent(csh_json);

	//列並替画面に遷移する。
	var webroot = $('#webroot').val();
	var url = webroot + 'clm_sorter?p=' + page_code + '&csh_u=' + csh_u;
	location.href=url;
	
}




/**
 * SVG画像ファイルを読み込んで指定要素に表示する（指定要素が空である場合のみ）
 * @param svg_fn SVG画像ファイル名
 * @param svg_slt SVG画像を表示する指定要素セレクタ
 */
function loadSvg(svg_fn,svg_slt){
	
	$(svg_slt + ":empty").load(svg_fn, function(){
		
	});
	
	
	
	
}

/**
 * 
 * SVG画像ファイルを読込と表示切替機能
 * @param svg_fn SVG画像ファイル名
 * @param svg_slt SVG画像を表示する指定要素セレクタ
 * @returns
 */
function toggleSvg(svg_fn,svg_slt){
	
	// SVG画像ファイルを読み込んで指定要素に表示する（指定要素が空である場合のみ）
	loadSvg(svg_fn,svg_slt);
	
	var elm = $(svg_slt);
	
	var display = elm.css('display');
	if(display=='none'){
		elm.show();
	}else{
		elm.hide();
	}
	
}





/**
 * 行データによるリンク
 * @param thisElm this要素
 * @param base_url 基本URL： 可変は%0とする（例：game_text?kj_scene_id=%0）
 * @param field フィールド：　基本URLの可変部分に適用する行のフィールド。省略時はid。
 * @returns
 */
function linkByRowdata(thisElm,base_url,field){
	
	thisElm = $(thisElm);
	
	if(field==null){
		field = 'id';
	}
	
	//	this要素からTR要素を取得する
	var tr = thisElm.parents('tr');
	
	//	TR要素からフィールド要素を取得する
	var fElm = tr.find('.' + field);
	
	//	フィールド要素から可変値を取得する
	var v = fElm.text();
	
	//	基本URLに可変値を置換適用。
	base_url = base_url.replace( '%0' , v ) ;
	
	//	画面遷移
	location.href = base_url;
	
	
}




$( function() {
	
	var cssData={
		'width':'auto'
	}
	var liviPage = new LiviPage();
	liviPage.execution(cssData);
	
});



/**
 * livipage.js | ページ内リンク先プレビュー
 * 
 * ページ内リンクにカーソルを合わせると、リンク先をプレビュー表示する。
 * アンカーのclass属性にlivipageを追加するだけで使用可能。
 * 
 * 要素の予約語
 * class=livipage
 * id=livipage_tooltip
 * 
 * @param cssData CSSデータ（オブジェクト形式）
 * 
 * @version 1.1
 * @date 2016-1-19 オブジェクト化。オプション指定。
 * @date 2016-1-14 ver 1.0
 * @date 2016-1-4 新規作成
 * @author wacgance 
 * 
 */
var LiviPage =function(){
	

	
	this.execution=function(p_cssData){
		//ツールチップ用DIV
		$(document.body).append("<div id='livipage_tooltip'></div>");

		
		//デフォルトCSSデータ
		var cssData = {
			'z-index':2,
			'background-color':'white',
			'position':'absolute',
			'border':'solid 2px #ccb1bf',
			'padding':'5px',
			'width':'280px',
			'height':'460px',
			'overflow-y':'auto',
		}
		
		//引数CSSデータが空でなければ、CSSデータにマージする
		if(p_cssData!=undefined){
			$.extend(cssData, p_cssData);
		}
		
		//ツールチップの外をクリックするとツールチップを閉じる
		$(document).click(
				function (){
					$('#livipage_tooltip').hide();
				});
		
		//領域外クリックでツールチップを閉じるが、ツールチップ自体は領域内と判定させ閉じないようにする。
		$('#livipage_tooltip').click(function(e) {
			e.stopPropagation();
		});
		

		//対象リンクをクリックするとツールチップを表示させる。
		$('.livipage').click(
				function(){
					
					//対象セレクタ
					var slt=$(this).attr('href');

					//対象要素の右上位置を取得
					var offset=$(this).offset();
					var left = offset.left;
					var top = offset.top;
			
					//対象要素の外幅を取得
					var width= $(slt).width();
					var height= $(slt).height();
					
					var tt_html=$(slt).html();
					
					//リンクを作成する
					var link_text=$(this).html();
					var link1="<a href='" + slt + "'>" + link_text + "</a><br>";
					
					tt_html = link1 + tt_html;
					
					$('#livipage_tooltip').show();
					

					
					$('#livipage_tooltip').css(cssData);
					
					
					//ツールチップにHTMLをセット
					$('#livipage_tooltip').html(tt_html);
					
					//ツールチップの位置を算出
					var tt_left=left;
					var tt_top=top + 16;

					//ツールチップ要素に位置をセット
					$('#livipage_tooltip').offset({'top':tt_top,'left':tt_left });
					
					return false;//リンク無効
				}
			);
		
		
		
	};
};

















/**
 * 数値範囲入力スライダー・noUiSliderラップクラス
 * 
 * nouislider.min.jsの拡張クラスです。
 * 入力フォームをテキストボックス形式から、スライダー形式に変更します。
 * 
 * ◇主なメソッド
 * - init noUiSliderの初期化（数値範囲入力スライダーを生成）
 * - reload 数値テキストボックスに合わせて、スライドバーを修正する。
 * 
 * @date 2015-11-25 | 2018-3-9 v1とv2の両方が0であれば、両方を空文字にする。
 */
var NoUiSliderWrap = function(){
	
	this.props;//プロパティ
	this.slider;//スライダーオブジェクト
	
	
	/**
	 * noUiSliderの初期化（数値範囲入力スライダー）
	 * @param param
	 * 
	 * paramの設定例
	 * 	'slider':'#ans_tw_cnt_slider',
	 *	'tb1':'#kj_ans_tw_cnt1',
	 *	'tb2':'#kj_ans_tw_cnt2',
	 *	'step':1,
	 *	'min':0,
	 *	'min':0,
	 *	'max':200,
	 * 
	 */
	this.init=function(myself,param){
		
		this.props=param;
		
		var slider = $(param.slider).get(0);//スライダー要素オブジェクトを取得
		this.slider=slider;
			
		var v1=$(param.tb1).val();
		var v2=$(param.tb2).val();
		
		
		//noUiSliderスライダーの生成と設定をする。
		noUiSlider.create(slider, {
			start: [v1, v2],//初期値
			step:param.step,//ステップ：スライダー一切りの間隔値
			connect: true,
			tooltips: false,// true:スライダーにツールチップを表示
			range: {//入力できる数値の範囲
				'min': param.min,
				'max': param.max
			}
		});
		
		//スライダーを動かしたときのイベント
		slider.noUiSlider.on('update', function ( values, handle ) {
			var v1=values[0];
			var v1=Math.round(v1);

			var v2=values[1];
			var v2=Math.round(v2);
			
			if(v1!=0 || v2!=0){
				$(param.tb1).val(v1);
				$(param.tb2).val(v2);
				$(param.value_preview).html(v1 + '～' + v2);
			}else{
				$(param.tb1).val('');
				$(param.tb2).val('');
				$(param.value_preview).html('OFF');
			}
			
		});
		
		//テキストボックスの値を変更したときに、スライダーにも反映させる。
		$(param.tb1).blur(function(e){
			myself.reload();
		});
		
		//テキストボックスの値を変更したときに、スライダーにも反映させる。（右の値）
		$(param.tb2).blur(function(e){
			myself.reload();
		});
		
		
	};


	/**
	 * 数値テキストボックスに合わせて、スライドバーを修正する。
	 */
	this.reload=function(){
		var v1=$(this.props.tb1).val();
		var v2=$(this.props.tb2).val();
		this.slider.noUiSlider.set([v1,v2]);
	};
};




/**
 * 一覧のチェックボックス複数選択による一括処理
 * Check box in list Batch processing with multiple selection.
 * ProcessWithMultiSelection.js
 * 
 * @note
 * 当クラスは、一覧を複数選択して一括処理を行う処理をサポートする。
 * 一括無効化、一括有効化などの機能を備えている。
 * 複数選択の方法はチェックボックスにのみ対応している。
 * 
 * @version 1.0
 * @date 2016-2-5
 * 
 * @param param
 * - tbl_slt HTMLテーブルのセレクタ
 * - cb_slt チェックボックスのセレクタ（class属性名 or name属性名）	省略時："pwms"
 * - id_slt IDのセレクタ（class属性名 or name属性名）	省略時："id"
 * - ajax_url AJAX送信先URL
 */
var ProcessWithMultiSelection =function(param){

	this.param = param;
	
	var myself=this; // Instance of myself.

	/**
	 * initialized.
	 */
	this.constract=function(){
		
		// If Option property is empty, set a value.
		this.param = setOptionIfEmpty(this.param);
		
	};
	
	// If Option property is empty, set a value.
	function setOptionIfEmpty(param){
		
		if(param == undefined){
			param = {};
		}
		
		if(param['tbl_slt'] == undefined){
			param['tbl_slt'] = 'tbl1';
		}
		
		if(param['cb_slt'] == undefined){
			param['cb_slt'] = 'pwms';
		}
		
		if(param['id_slt'] == undefined){
			param['id_slt'] = 'id';
		}
		
		if(param['ajax_url'] == undefined){
			throw new Error("'ajax_url' is nothing");
		}
		
		return param;
	};
	
	
	
	/**
	 * 一括アクション
	 * @param kind_no アクション種別番号 10:有効化,  11:無効化
	 */
	this.action = function(kind_no){
		
		// チェックされた行のIDをリストで取得する
		var ids = getIdLintInChecked();
		
		// IDリストが0件なら処理抜け
		if(ids.length == 0){
			return;
		}
		
		// 無効化である場合、確認ダイアログを表示する
		if(kind_no == '11'){
			var rs = confirm('チェックした行を削除してもよろしいですか？');
			if(!rs){
				return;
			}
		}
		
		// Ajaxへ送信するデータをセットする
		var data={'ids':ids,'kind_no':kind_no};
		var json_str = JSON.stringify(data);//データをJSON文字列にする。

		//☆AJAX非同期通信
		$.ajax({
			type: "POST",
			url: myself.param.ajax_url,
			data: "key1="+json_str,
			cache: false,
			dataType: "text",
			success: function(res, type) {

				if(res=='success'){
					
					// ブラウザをリロードする
					location.reload(true);
					
				}else{
					$("#err").html(res);
				}
				

			},
			error: function(xmlHttpRequest, textStatus, errorThrown){
				$('#err').html(xmlHttpRequest.responseText);//詳細エラーの出力
				alert(textStatus);
			}
		});
	};

	
	
	
	/**
	 * チェックされた行のIDをリストで取得する
	 * 
	 * @return IDリスト
	 * 
	 */
	function getIdLintInChecked(){
		
		var ids = []; // IDリスト
		
		var slt = myself.param.tbl_slt + ' tbody tr';
		$(slt).each(function(){
			
			var tr = $(this);
			
			// TR要素内からname属性またはclass属性を指定してチェックボックス要素を取得する
			var cb = getElmByNameOrClass(tr,myself.param.cb_slt);
			
			
			// チェックされている場合のみIDを取得してリストに追加する
			var checked = cb.prop('checked');
			if(checked){
				
				// TR要素内からname属性またはclass属性を指定してID値を取得する
				var id = getValueByNameOrClass(tr,myself.param.id_slt);
				ids.push(id);
			}
			
		});
		
		
		return ids;
		
	}
	
	/**
	 * 親要素内からname属性またはclass属性を指定して要素を取得する
	 * @param parElm 親要素
	 * @param key name属性名またはclass属性名
	 * @return 要素<jquery object>
	 */
	function getElmByNameOrClass(parElm,key){
		var elm = parElm.find("[name='" + key + "']");
		if(!elm[0]){
			elm = parElm.find('.' + key);
		}
		return elm;
		
	}
	
	/**
	 * 親要素内からname属性またはclass属性を指定して値を取得する
	 * @param parElm 親要素
	 * @param key name属性名またはclass属性名
	 * @return 値
	 */
	function getValueByNameOrClass(parElm,key){
		var v = undefined;
		var elm = parElm.find("[name='" + key + "']");
		if(elm[0]){
			v = elm.val();
		}else{
			elm = parElm.find('.' + key);
			if(elm[0]){
				v = elm.text();
			}
		}
		return v;
	}
	
	
	
	
	
	
	/**
	 * 全選択の切替
	 * @param triggerCb トリガーチェックボックス
	 */
	this.switchAllSelection = function(triggerCb){

		// トリガーチェックボックスのチェックを取得する
		var trigCb = $(triggerCb);
		var trigChecked = trigCb.prop('checked');
		
		// 一覧をループして全行のチェック切替を行う
		var slt = myself.param.tbl_slt + ' tbody tr';
		$(slt).each(function(){
			
			var tr = $(this);
			
			// TR要素内からname属性またはclass属性を指定してチェックボックス要素を取得する
			var cb = getElmByNameOrClass(tr,myself.param.cb_slt);
			
			// チェックを切り替える
			cb.prop('checked',trigChecked);
			
		});
		
		
	}
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	// call constractor method.
	this.constract();
};